<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Optics, programming, and computer vision.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kyle M. Douglass</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="assets/css/custom_notebook.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="http://kmdouglass.github.io/">
<link rel="next" href="index-4.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel="prefetch" href="posts/comparison-of-two-methods-to-append-to-a-list-in-python/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://kmdouglass.github.io/">

                <span id="blog-title">Kyle M. Douglass</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="stories/contact/index.html">Contact</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/comparison-of-two-methods-to-append-to-a-list-in-python/" class="u-url">Comparison of two methods to append to a list in Python</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/comparison-of-two-methods-to-append-to-a-list-in-python/" rel="bookmark">
            <time class="published dt-published" datetime="2020-03-27T18:09:00+01:00" itemprop="datePublished" title="2020-03-27 18:09">2020-03-27 18:09</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/comparison-of-two-methods-to-append-to-a-list-in-python/#disqus_thread" data-disqus-identifier="cache/posts/comparison-of-two-methods-to-append-to-a-list-in-python.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<div class="abstract docutils container">
<p>A colleague recently told me that the <code class="docutils literal">append</code> method on a Python
list is more efficient than using the += operator but provided no
justification. Curious, I investigated whether this was true.</p>
</div>
<div class="section" id="string-validation-as-an-example">
<h2>String validation as an example</h2>
<p>Consider the following function as an example. It checks whether a
string is <em>semantically</em> correct, i.e. whether it satisifies some set of
requirements that are dictated by the needs of the application. In this
example, the requirements are</p>
<ol class="arabic simple">
<li><p>The string cannot be longer than 10 characters</p></li>
<li><p>The string cannot contain a number</p></li>
</ol>
<pre class="code python"><a name="rest_code_1001bcca55fb45a88d7a71b779d09598-1"></a><span class="kn">import</span> <span class="nn">re</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-2"></a>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-3"></a><span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="nb">input</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-4"></a>    <span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-5"></a>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-6"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-7"></a>        <span class="n">reasons</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"Input is too long"</span><span class="p">]</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-8"></a>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-9"></a>    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\d"</span><span class="p">,</span> <span class="nb">input</span><span class="p">)):</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-10"></a>        <span class="n">reasons</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">"Input contains a number"</span><span class="p">]</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-11"></a>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-12"></a>    <span class="k">if</span> <span class="n">reasons</span><span class="p">:</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-13"></a>         <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">" | "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reasons</span><span class="p">))</span>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-14"></a>
<a name="rest_code_1001bcca55fb45a88d7a71b779d09598-15"></a>    <span class="k">return</span> <span class="nb">input</span>
</pre>
<p>If either of these conditions are violated, an exception is raised
containing a message. The message describes which condition(s) is(are)
violated. The <code class="docutils literal">reasons</code> list contains zero, one, or two elements, and
it is built by appending to the list using the += operator. I could
have instead used the <code class="docutils literal">append</code> method of <code class="docutils literal">list</code>.</p>
</div>
<div class="section" id="vs-append">
<h2>+= vs. append</h2>
<p>To test the speed of the two methods, I use the <code class="docutils literal">timeit</code> package from
the Python standard library in the program below. The test consists of
the following:</p>
<ol class="arabic simple">
<li><p>Create an empty list</p></li>
<li><p>Append error strings to the list one at a time</p></li>
</ol>
<pre class="code python"><a name="rest_code_351fa1974a9648f194cac3ef35ed9263-1"></a><span class="kn">import</span> <span class="nn">string</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-2"></a><span class="kn">import</span> <span class="nn">timeit</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-3"></a>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-4"></a><span class="n">reasons</span> <span class="o">=</span> <span class="p">[</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-5"></a>    <span class="s2">"This is an error message"</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-6"></a>    <span class="s2">"This is another error message"</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-7"></a>    <span class="s2">"Let's add another for good measure"</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-8"></a><span class="p">]</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-9"></a><span class="k">def</span> <span class="nf">test_plus_equals</span><span class="p">():</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-10"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-11"></a>    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">reasons</span><span class="p">:</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-12"></a>        <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">reason</span><span class="p">]</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-13"></a>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-14"></a><span class="k">def</span> <span class="nf">test_append</span><span class="p">():</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-15"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-16"></a>    <span class="k">for</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">reasons</span><span class="p">:</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-17"></a>        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-18"></a>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-19"></a><span class="n">number</span> <span class="o">=</span> <span class="mi">1000000</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-20"></a><span class="n">repeat</span> <span class="o">=</span> <span class="mi">5</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-21"></a><span class="n">results_plus_equals</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-22"></a>    <span class="n">timeit</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-23"></a>        <span class="s2">"test_plus_equals()"</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-24"></a>        <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-25"></a>        <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-26"></a>        <span class="n">setup</span><span class="o">=</span><span class="s2">"from __main__ import test_plus_equals"</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-27"></a>    <span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-28"></a><span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-29"></a>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-30"></a><span class="n">results_append</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-31"></a>    <span class="n">timeit</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-32"></a>        <span class="s2">"test_append()"</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-33"></a>        <span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-34"></a>        <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-35"></a>        <span class="n">setup</span><span class="o">=</span><span class="s2">"from __main__ import test_append"</span><span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-36"></a><span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-37"></a>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-38"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-39"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"1E+6 loops per test"</span><span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-40"></a>    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"+= (best of five tests):</span><span class="se">\t</span><span class="s2">{results_plus_equals:0.4f} s"</span><span class="p">)</span>
<a name="rest_code_351fa1974a9648f194cac3ef35ed9263-41"></a>    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"append (best of five tests):</span><span class="se">\t</span><span class="s2">{results_append:0.4f} s"</span><span class="p">)</span>
</pre>
</div>
<div class="section" id="results">
<h2>Results</h2>
<pre class="code text"><a name="rest_code_b7bf81d52bbb401d9b9a9f9de6844e0b-1"></a>1E+6 loops per test
<a name="rest_code_b7bf81d52bbb401d9b9a9f9de6844e0b-2"></a>+= (best of five tests):     0.2392 s
<a name="rest_code_b7bf81d52bbb401d9b9a9f9de6844e0b-3"></a>append (best of five tests): 0.2241 s
</pre>
<p>In this test the <code class="docutils literal">append</code> method of Python's list does appear to be
faster by a factor of 6% or 7%. <code class="docutils literal">append</code> took about 0.224
microseconds per loop, whereas the += operator took 0.239 microseconds.</p>
<p>The advantage of the <code class="docutils literal">append</code> method is probably only noticeable if
you need to append to a list many millions of times per second.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/summary-out-of-the-tar-pit/" class="u-url">Out of the Tar Pit: a Summary</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/summary-out-of-the-tar-pit/" rel="bookmark">
            <time class="published dt-published" datetime="2020-02-28T23:40:18+01:00" itemprop="datePublished" title="2020-02-28 23:40">2020-02-28 23:40</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/summary-out-of-the-tar-pit/#disqus_thread" data-disqus-identifier="cache/posts/out-of-the-tar-pit-a-summary.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p><a class="reference external" href="http://curtclifton.net/papers/MoseleyMarks06a.pdf">Out of the Tar Pit</a> is a 2006 paper by Ben Moseley and Peter Marks about the causes and effects
of complexity in software systems. The thesis of the paper is stated already in the second sentence
of the paper:</p>
<blockquote>
The biggest problem in the development and maintenance of large-scale software systems is
complexity — large systems are hard to understand.</blockquote>
<p>As implied by the authors, complexity is a property of a software system that represents the degree
of difficulty that is experienced when trying to understand the system. State—in particular mutable
state—is the primary cause of complexity. Additional causes are code volume and control flow, but
these are of secondary importance.</p>
<div class="section" id="complexity">
<h2>Complexity</h2>
<p>Of the four properties described by Brooks in the paper entitled <a class="reference external" href="https://en.wikipedia.org/wiki/No_Silver_Bullet">No Silver Bullet</a> that make
building software hard (complexity, conformity, changeability, invisibility), the authors state
that complexity is the only meaningful one:</p>
<blockquote>
Complexity is the root cause of the vast majority of problems with software today. Unreliability,
late delivery, lack of security — often even poor performance in large-scale systems can all be
seen as deriving ultimately from unmanageable complexity.</blockquote>
<p>By complexity, the authors mean "that which makes large systems <em>hard to understand</em>," not the
field of computer science that is concerned with the resources that are consumed by an algorithm.</p>
</div>
<div class="section" id="approaches-to-understanding">
<h2>Approaches to Understanding</h2>
<p>To better establish their definition of complexity, the authors explore the ways in which
developers attempt to understand a system. There are two main ways:</p>
<ol class="arabic simple">
<li>
<strong>Testing</strong> This is a way to understand the system from the outside.</li>
<li>
<strong>Informal Reasoning</strong> This is a way to understand the system from the inside.</li>
</ol>
<blockquote>
Of the two, informal reasoning is the most important by far. This is because — as we shall see
below — there are inherent limits to what can be achieved by testing, and because informal
reasoning (by virtue of being an inherent part of the development process) is always used.  The
other justification is that improvements in informal reasoning will lead to less errors being
created whilst all that improvements in testing can do is to lead to more errors being detected.</blockquote>
<p>The primary problem with testing is that a test will only tell you about the behavior of a system
subject to the particular range of inputs used by the test. A test will tell you absolutely nothing
about the system's behavior under a different set of inputs. In large systems, the set of all
possible inputs is too large to fully explore with testing.</p>
<blockquote>
Have you performed the right tests? The only certain answer you will ever get to this question is
an answer in the negative — when the system breaks.</blockquote>
<p>Informal reasoning, on the other hand, is what is used when a developer builds a mental model about
how the system works while looking at the code. Because it is the most important way to understand
a system, simplicity is a vital characteristic of well-functioning, large-scale systems.</p>
</div>
<div class="section" id="causes-of-complexity">
<h2>Causes of Complexity</h2>
<div class="section" id="state">
<h3>State</h3>
<p>The presence of state (particularly mutable state) makes programs difficult to understand. The
authors offer the following example to explain the problems of state:</p>
<blockquote>
Anyone who has ever telephoned a support desk for a software system and been told to “try it
again”, or “reload the document”, or “restart the program”, or “reboot your computer” or
“re-install the program” or even “re-install the operating system and then the program” has
direct experience of the problems that state causes for writing reliable, understandable
software.</blockquote>
<p>State makes testing difficult by making flakiness more likely. (Flakiness describes a set of tests
that randomly fail for seemingly no reason.) This fact, combined with the large number of inputs to
a program, combine together <em>horribly</em> (emphasis the authors).</p>
<p>In addition, state complicates informal reasoning by hindering the developer from understanding the
system "from the inside." It contaminates a system in the sense that even mostly stateless systems
become difficult to understand when coupled to components with mutable state.</p>
</div>
<div class="section" id="control">
<h3>Control</h3>
<p>The authors claim that the next most important barrier to understanding is control.</p>
<blockquote>
Control is basically about the order in which things happen. The problem with control is that
very often we do not want to have to be concerned with this.</blockquote>
<p>Complexity caused by control very much depends on the choice of language; some languages make
control flow explicit, whereas other, more declarative languages, make control flow
implicit. Having to explicitly deal with control creates complexity.</p>
<p>The same is true of concurrency. Explicit concurrency in particular makes both testing and informal
reasoning about programs hard.</p>
</div>
<div class="section" id="code-volume">
<h3>Code volume</h3>
<p>Increasing the amount of code does increase complexity, but effective management of state and
control marginalizes its impact.</p>
<p>There are indeed other causes of complexity than the three listed above, but they all reduce to
three basic principles:</p>
<ol class="arabic simple">
<li>Complexity breeds complexity</li>
<li>Simplicity is <em>hard</em>
</li>
<li>Power corrupts</li>
</ol>
<p>The last principle states that mistakes and poor decisions <em>will be made</em> when a language allows
it. For this reason, restrictive, declarative languages and tools should be preferred.</p>
</div>
</div>
<div class="section" id="classical-approaches-to-managing-complexity">
<h2>Classical approaches to managing complexity</h2>
<p>To better understand the ways in which programmers manage complexity, the authors explore three
major styles of programming:</p>
<ol class="arabic simple">
<li>Imperative (more precisely, object-oriented)</li>
<li>Functional</li>
<li>Logic</li>
</ol>
<div class="section" id="object-orientation">
<h3>Object-orientation</h3>
<p>Object-oriented programming (OOP) is one of the most dominant styles of programming today for
computers that are based on the von Neumann architecture and is presumably inspired largely by its
state-based form of computation.</p>
<p>OOP enforces integrity constraints on data by combining an object's state with a set of procedures
to access and modify it. This characteristic is known as <em>encapsulation</em>. Problems may arise when
multiple procedures contend for access to the same state.</p>
<p>OOP also views objects as being uniquely identifiable, regardless of the object's attributes. In
other words, two objects with the exact same set of attributes and values are condsidered
distinct. This property is known as <em>intensional identity</em> and contrasts with <em>extensional
identity</em> in which things are considered the same if their attributes are the same.</p>
<p>For these two reasons, OOP is not suitable for avoiding the problems of complexity:</p>
<blockquote>
The bottom line is that all forms of OOP rely on state (contained within objects) and in general
all behaviour is affected by this state. As a result of this, OOP suffers directly from the
problems associated with state described above, and as such we believe that it does not provide
an adequate foundation for avoiding complexity.</blockquote>
</div>
<div class="section" id="functional-programming">
<h3>Functional programming</h3>
<p>Modern functional programming (FP) languages can be classified as pure (e.g. Haskell) and impure
(e.g. the ML family of languages).</p>
<blockquote>
<p>The primary strength of functional programming is that by avoiding state (and side-effects) the
entire system gains the property of <em>referential transparency</em> - which implies that when supplied
with a given set of arguments a function will always return exactly the same result (speaking
loosely we could say that it will always behave in the same way)...</p>
<p>It is this cast iron guarantee of <em>referential transparency</em> that obliterates one of the two
crucial weaknesses of testing as discussed above. As a result, even though the other weakness of
testing remains (testing for one set of inputs says nothing at all about behaviour with another
set of inputs), testing does become far more effective if a system has been developed in a
functional style.</p>
</blockquote>
<p>Informal reasoning is also more effective in the functional approach to programming. By enforcing
<em>referential transparency</em>, mutable state is generally avoided. However, in spite of its
properties, nothing in FP can prevent somenone from effectively simulating multiple state, so some
care must still be taken.</p>
<p>The authors concede that by sacrificing state in FP, one does lose a degree of modularity.</p>
<blockquote>
Working within a stateful framework it is possible to add state to any component without
adjusting the components which invoke it. Working within a functional framework the same effect
can only be achieved by adjusting every single component that invokes it to carry the additional
information around.</blockquote>
<p>However,</p>
<blockquote>
The trade-off is between complexity (with the ability to take a shortcut when making some
specific types of change) and simplicity (with huge improvements in both testing and
reasoning). As with the discipline of (static) typing, it is trading a one-off up-front cost for
continuing future gains and safety (“one-off” because each piece of code is written once but is
read, reasoned about and tested on a continuing basis).</blockquote>
<p>FP remains relatively unpopular despite its advantages. The authors state that the reason is that
problems arise when programmers attempt to use it in problems that require mutable state.</p>
</div>
<div class="section" id="logic-programming">
<h3>Logic programming</h3>
<p>Logic programming is like FP in the sense that it is declarative: it emphasizes what needs to be
done, not how it is done. The primary example of a logic programming language is Prolog.</p>
<blockquote>
Pure logic programming is the approach of doing nothing more than making statements about the
problem (and desired solutions). This is done by stating a set of axioms which describe the
problem and the attributes required of something for it to be considered a solution. The ideal of
logic programming is that there should be an infrastructure which can take the raw axioms and use
them to find or check solutions. All solutions are formal logical consequences of the axioms
supplied, and “running” the system is equivalent to the construction of a formal proof of each
solution.</blockquote>
<p>Pure logic programming does not suffer from the same problems of state and control as OOP. However,
it appears that real logic programming languages need to make some pragmatic tradeoffs in their
implementations which introducs small amounts of state and control elements.</p>
</div>
</div>
<div class="section" id="accidents-and-essence">
<h2>Accidents and Essence</h2>
<p>The authors define two different types of complexity:</p>
<ul class="simple">
<li>
<strong>Essential complexity</strong> is inherent in, and the essence of, the problem as seen by the user.</li>
<li>
<strong>Accidental complexity</strong> is all the rest - complexity with which the development team would not
have to deal with in the real world.</li>
</ul>
<p>It is important to understand the degree of strictness in the definition of essential
complexity. Only complexity related to the problem domain of the user falls into this
category. Everything related to the implementation details - bytes, transistors, operating systems,
programming languages, etc. - is accidental complexity.</p>
<blockquote>
We hence see essential complexity as "the complexity with which the team will have to be
concerned, even in the ideal world"... Note that the "have to" part of this observation is
critical — if there is any possible way that the team could produce a system that the users will
consider correct without having to be concerned with a given type of complexity then that
complexity is not essential.</blockquote>
<p>The authors disagree with Brooks's assertion that most complexity in software is essential.</p>
<blockquote>
Complexity itself is not an inherent (or essential) property of software (it is perfectly
possible to write software which is simple and yet is still software), and further, much
complexity that we do see in existing software is not essential (to the problem).</blockquote>
</div>
<div class="section" id="recommended-general-approach">
<h2>Recommended general approach</h2>
<p>The remaining sections of the paper present the authors' idea on a model system that minimizes the
effects of complexity. First, they present the solution in the ideal world, and then adjust this
solution accordingly to handle real world constraints.</p>
<div class="section" id="ideal-world">
<h3>Ideal world</h3>
<p>The implementation of a complexity-minimizing system in the ideal world is not concerned with
performance, and the language and infrastructure provides all the support necessary to build the
system.</p>
<p>The purpose of designing the system is to translate users' informal requirements into formal
requirements.</p>
<div class="math">
\begin{equation*}
\text{Informal requirements} \rightarrow \text{Formal requirements}
\end{equation*}
</div>
<p>(Note that I believe that, today, this mapping is most often done as part of the Agile workflow,
not through a formal analysis method.) In the ideal world, this translation must not introduce any
accidental complexity, and, as a result, should not include any details about execution
what-so-ever.</p>
<blockquote>
The sole concern when producing the formal requirements must be to ensure that there is no
relevant ambiguity in the informal requirements (i.e. that it has no omissions).</blockquote>
<p>Once the design process has finished, it should suffice to simply execute the system in the ideal
world.</p>
<p>Such a system as described above obtains its data either as inputs or by deriving it from
inputs. All data derived from the user requirements is essential, but not all such data corresponds
to <em>essential state</em>. The reason is that some derived data need not be stored but, rather,
calculated only as needed.</p>
<p>Only essential input data corresponds to essential state. All other data is part of accidental
state, including:</p>
<ul class="simple">
<li>derived, immutable, essential data</li>
<li>derived, mutable, essential data</li>
<li>and derived accidental data.</li>
</ul>
<p>Control in the ideal world is entirely accidental; it is not something that programmer's should be
concerned with (in the ideal world!) because it does not pertain to the users' problem.</p>
</div>
<div class="section" id="required-accidental-complexity">
<h3>Required Accidental Complexity</h3>
<p>Once we move into the real world, we will find that we must allow for some accidental
complexity. The reasons for justifying it are</p>
<ul class="simple">
<li>Performance</li>
<li>Ease of expression</li>
</ul>
<p>Given that we must allow for some accidental complexity, the authors suggest the following strategy
to address it:</p>
<ul class="simple">
<li>Avoid</li>
<li>Separate</li>
</ul>
<p>The overriding aim must be to avoid accidental complexity and, when it is necessary, separate it
from the rest of the system to the greatest degree possible.</p>
</div>
</div>
<div class="section" id="functional-relational-programming">
<h2>Functional relational programming</h2>
<p>The second part of the paper concerns itself with exploring a real-world implementation of a
complexity-minimizing system known as <em>functional relational programming</em>, or FRP. It is based on
two major paradigms:</p>
<ul class="simple">
<li>the relational data model for handling state</li>
<li>pure functional programming for handling logic</li>
</ul>
<p>Throughout these final sections, the role of the relational model was the primary topic, whereas
the role of functional programming within the system was given relatively little importance. I
found a few points interesting here:</p>
<ol class="arabic simple">
<li>The authors focus primarily on the pure form of the relational model, citing <a class="reference external" href="https://dl.acm.org/doi/10.5555/77708.C1065772">a work of Codd's</a>
that criticizes "impure" but pragmatic implementations, such as SQL. However, and as far as I
can tell, there are extremely few real-world implementations of a pure relational database. (I
only managed to find one, <a class="reference external" href="https://reldb.org/c/">RelDB</a>, from <a class="reference external" href="https://www.sisense.com/blog/your-database-isnt-really-relational/">a page explaining why and how</a> SQL does not strictly
follow the relational model.)</li>
<li>In spite of the paper's insistence on the elimination of mutable state, it seems like the
authors ignore the point that their implementation of essential state using the relational model
is mutable. I know of no way that FRP can update the relational variables in the system's
essential state without mutating them.</li>
</ol>
<p>The following quotes indicate that the authors seem to understand that their system is based on
mutable state, which is why I am puzzled that it is part of their proposed solution.</p>
<blockquote>
<p>Specifically, all input must be converted into relational assignments (which replace the old
relvar values in the essential state with new ones), and all output (and side-effects) must be
driven from changes to the values of relvars (primarily derived relvars). - Section 9.1.4</p>
<p>Finally, the ability to access arbitrary historical relvar values would obviously be a useful
extension in some scenarios. - Section 9.1.5</p>
</blockquote>
<p>I was actually a bit relieved when a colleague pointed out to me that Rich Hickey expresses similar
criticism about FRP in his talk <a class="reference external" href="https://www.youtube.com/watch?v=Cym4TZwTCNU">Deconstructing the Database</a> because it gave me some confidence
that my suspicions may be correct.</p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>"Out of the Tar Pit" has significantly changed the way I think about solving problems with software
engineering. In particular, it has made me reevaluate the signifance of domain specific languages
(DSLs), especially those that constrain the freedom of the programmer to work only within the
problem's immediate domain. I am much more suspect of the tendency of programmers to focus on the
flow of control in a program, and I now go to great lengths to avoid mutable state in my own work.</p>
<p>I invested the most thought in the final sections of the paper, only to conclude that their
content, in my opinion, is somewhat incomplete. Though the relational model is indeed powerful and
elegant, it has very few pure, real-world implementations and seems to admit mutable state. This
last bit I find difficult to reconcile with the main thesis of the paper, which is that mutable
state is the primary cause of complexity in systems.</p>
<p>I described "Out of the Tar Pit" to my former manager as one of those papers where if you read it,
you can't help but agree with it's message because it puts into words what you already know by
heart. He replied that this is true only if you've worked in programming for long enough to suffer
from the effects of unmanageable complexity. Otherwise, you have no idea what the authors are
talking about.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/variable-locations-in-rust-during-copy-and-move/" class="u-url">Variable locations in Rust during copy and move</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/variable-locations-in-rust-during-copy-and-move/" rel="bookmark">
            <time class="published dt-published" datetime="2019-11-24T10:46:20+01:00" itemprop="datePublished" title="2019-11-24 10:46">2019-11-24 10:46</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/variable-locations-in-rust-during-copy-and-move/#disqus_thread" data-disqus-identifier="cache/posts/variable-locations-in-rust-during-copy-and-move.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p><a class="reference external" href="https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html">Ownership</a> is a well-known concept in Rust and is a major reason for the language's memory
safety. Consider the following example of ownership from <a class="reference external" href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html#memory-and-allocation">The Rust Programming Language</a>:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_ab8c77e60e9b49cd8f0baa547a637da0-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_ab8c77e60e9b49cd8f0baa547a637da0-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_ab8c77e60e9b49cd8f0baa547a637da0-3">3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_ab8c77e60e9b49cd8f0baa547a637da0-4">4</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_ab8c77e60e9b49cd8f0baa547a637da0-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"hello"</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_ab8c77e60e9b49cd8f0baa547a637da0-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_ab8c77e60e9b49cd8f0baa547a637da0-3"></a>
<a name="rest_code_ab8c77e60e9b49cd8f0baa547a637da0-4"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}, world!"</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p>Compiling this code will produce an error because the <tt class="docutils literal">String</tt> value that is bound to the
variable <tt class="docutils literal">s1</tt> is moved to <tt class="docutils literal">s2</tt>. After a move, you may no longer use the value bound to
<tt class="docutils literal">s1</tt>. (You may, as we will see, re-use its memory by binding a new value of the same type to it.)</p>
<p><tt class="docutils literal">String</tt> is a container type, which means that it contains both metadata on the stack and a
pointer to data on the heap. Simple types such as <tt class="docutils literal">i32</tt>, on the other hand, are normally stored
entirely on the stack. Types such as these implement the <a class="reference external" href="https://doc.rust-lang.org/std/marker/trait.Copy.html">Copy</a> trait. This means that variable
reassignment does not produce a compile-time error like it does in the example above:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-3">3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-4">4</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-5">5</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-3"></a>
<a name="rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-4"></a><span class="c1">// The value bound to x is Copy, so no error will be raised.</span>
<a name="rest_code_0f0822f5f2ce4f43a17dffeb09cd8225-5"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p><tt class="docutils literal">String</tt> is not <tt class="docutils literal">Copy</tt> because it contains a pointer to data on the heap. When a variable that
is bound to a <tt class="docutils literal">String</tt> is dropped, its data is automatically freed from the heap. If a <tt class="docutils literal">String</tt>
were <tt class="docutils literal">Copy</tt>, the compiler would have to determine whether the heap data is still pointed to by
another variable to avoid a <a class="reference external" href="https://stackoverflow.com/questions/21057393/what-does-double-free-mean">double free error</a>.</p>
<div class="section" id="memory-layout-in-copies-and-moves">
<h2>Memory layout in copies and moves</h2>
<p>What's happening inside a program's memory during copies and moves? Consider first a move:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-1"> 1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-2"> 2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-3"> 3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-4"> 4</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-5"> 5</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-6"> 6</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-7"> 7</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-8"> 8</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-9"> 9</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-10">10</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-11">11</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-12">12</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_76df2b45730a42f9b75d3349dbe0887b-13">13</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"foo"</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-2"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-3"></a>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-4"></a><span class="c1">// Move occurs here</span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-6"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of y: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-7"></a>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-8"></a><span class="c1">// Printing the memory address of x is an error because its value was moved.</span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-9"></a><span class="c1">// println!("Memory address of x: {:p}", &amp;x)</span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-10"></a>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-11"></a><span class="c1">// Assign new string to x</span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-12"></a><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"bar"</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_76df2b45730a42f9b75d3349dbe0887b-13"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p>In the above code snippet, addresses of variables are printed by using the pointer formatter
<tt class="docutils literal">:p</tt>. I create a <tt class="docutils literal">String</tt> value and bind it to the variable <tt class="docutils literal">x</tt>. Then, the value is moved to
the variable <tt class="docutils literal">y</tt> which prevents me from using <tt class="docutils literal">x</tt> again in the <tt class="docutils literal">println!</tt> macro.</p>
<p>However, I can assign a new <tt class="docutils literal">String</tt> value to <tt class="docutils literal">x</tt> by reusing its memory on the stack. This does
not change its memory address as seen in the output below:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_61bb6e1f1c1d4730b49b2d79e19d0ca4-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_61bb6e1f1c1d4730b49b2d79e19d0ca4-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_61bb6e1f1c1d4730b49b2d79e19d0ca4-3">3</a></pre></div></td>
<td class="code"><pre class="code console"><a name="rest_code_61bb6e1f1c1d4730b49b2d79e19d0ca4-1"></a><span class="go">Memory address of x: 0x7ffded2aa3d0</span>
<a name="rest_code_61bb6e1f1c1d4730b49b2d79e19d0ca4-2"></a><span class="go">Memory address of y: 0x7ffded2aa3f0</span>
<a name="rest_code_61bb6e1f1c1d4730b49b2d79e19d0ca4-3"></a><span class="go">Memory address of x: 0x7ffded2aa3d0  # Memory address of x is unchanged after reassignment</span>
</pre></td>
</tr></table>
<p>A copy is similar. In the snippet below, an integer that is originally bound to <tt class="docutils literal">x</tt> is copied to
<tt class="docutils literal">y</tt>, which means that I can still refer to <tt class="docutils literal">x</tt> in the <tt class="docutils literal">println!</tt> macro.</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-1"> 1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-2"> 2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-3"> 3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-4"> 4</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-5"> 5</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-6"> 6</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-7"> 7</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-8"> 8</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-9"> 9</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-10">10</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-11">11</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-12">12</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_cf3cd4b3be734d1c997ab1317439eff0-13">13</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-2"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-3"></a>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-4"></a><span class="c1">// Move occurs here</span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-6"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of y: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-7"></a>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-8"></a><span class="c1">// Printing the memory address of x is not an error because its value was copied.</span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-9"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-10"></a>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-11"></a><span class="c1">// Assign new integer to x</span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-12"></a><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_cf3cd4b3be734d1c997ab1317439eff0-13"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p>Both the copy operation and value reassignment do not change the memory locations of <tt class="docutils literal">x</tt> as seen
in the program's output:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_7bcef0c364664af6b1db61f2cc8d9f81-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_7bcef0c364664af6b1db61f2cc8d9f81-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_7bcef0c364664af6b1db61f2cc8d9f81-3">3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_7bcef0c364664af6b1db61f2cc8d9f81-4">4</a></pre></div></td>
<td class="code"><pre class="code console"><a name="rest_code_7bcef0c364664af6b1db61f2cc8d9f81-1"></a><span class="go">Memory address of x: 0x7ffee579d544</span>
<a name="rest_code_7bcef0c364664af6b1db61f2cc8d9f81-2"></a><span class="go">Memory address of y: 0x7ffee579d548</span>
<a name="rest_code_7bcef0c364664af6b1db61f2cc8d9f81-3"></a><span class="go">Memory address of x: 0x7ffee579d544  # Memory address of x is unchanged after copy</span>
<a name="rest_code_7bcef0c364664af6b1db61f2cc8d9f81-4"></a><span class="go">Memory address of x: 0x7ffee579d544  # Memory address of x is unchanged after reassignment</span>
</pre></td>
</tr></table>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>Move semantics on container types are one of the reasons for Rust's memory safety. Nothing
mysterious is happening in memory when a value is moved from one location to another. The original
stack memory still exists; its use is simply disallowed by the compiler until a new value is
assigned to it.</p>
<p>The complete program from this post may be found here:
<a class="reference external" href="https://gist.github.com/kmdouglass/e596d0934e15f6b3a96c1eca6f6cd999">https://gist.github.com/kmdouglass/e596d0934e15f6b3a96c1eca6f6cd999</a></p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/a-simple-plugin-interface-for-the-rust-ffi/" class="u-url">A simple plugin interface for the Rust FFI</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/a-simple-plugin-interface-for-the-rust-ffi/" rel="bookmark">
            <time class="published dt-published" datetime="2019-06-16T09:33:33+02:00" itemprop="datePublished" title="2019-06-16 09:33">2019-06-16 09:33</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#disqus_thread" data-disqus-identifier="cache/posts/a-simple-plugin-interface-for-the-rust-ffi.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>In a recent post I explored <a class="reference external" href="http://kmdouglass.github.io/posts/complex-data-types-and-the-rust-ffi/">how to pass complex datatypes through the Rust FFI</a>. (The FFI is the
foreign function interface, a part of the Rust language for calling code written in other
languages.)</p>
<p>I am exploring the Rust FFI because I want to use it in <a class="reference external" href="https://github.com/kmdouglass/kpal">a small web application</a> that I am
writing and that will be used to interact with hardware peripherals connected to a system on a chip
(SoC). One use-case that I have in mind is to monitor readings from moisture and temperature
sensors implanted in the soil of my houseplants. In many cases the general purpose input/output
(GPIO) pins of a SoC are controlled through a C library such as <a class="reference external" href="http://wiringpi.com">WiringPi</a> for the Raspberry Pi,
which means my monitoring system needs to interface with C libraries such as this one.</p>
<p>In this post I will describe my current understanding for how best to integrate C-language plugins
with a Rust application. I have omitted all application-specific logic from the example and will
instead focus on the design of the plugin interface itself.</p>
<p>You may find <a class="reference external" href="https://github.com/kmdouglass/rust-libloading-example">the source code for this post here</a>. I was heavily inspired by both the <a class="reference external" href="http://jakegoulding.com/rust-ffi-omnibus/">Rust FFI
Omnibus</a> and <a class="reference external" href="https://michael-f-bryan.github.io/rust-ffi-guide/">The (unofficial) Rust FFI Guide</a>. This post was written using version 1.35.0 of the
Rust compiler.</p>
<div class="section" id="the-c-plugin">
<h2>The C plugin</h2>
<p>I wrote a very simple of C library that is located in the <a class="reference external" href="https://github.com/kmdouglass/rust-libloading-example/tree/master/ffi-test">ffi-test</a> folder of the example
repository and that will serve the purpose of this demonstration. It consists of two source files
(<tt class="docutils literal"><span class="pre">ffi-test.c</span></tt> and <tt class="docutils literal"><span class="pre">ffi-test.h</span></tt>) and a <tt class="docutils literal">Makefile</tt>. The plugin's interface is defined as usual
in the header file:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-1"> 1</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-2"> 2</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-3"> 3</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-4"> 4</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-5"> 5</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-6"> 6</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-7"> 7</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-8"> 8</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-9"> 9</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-10">10</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-11">11</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-12">12</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-13">13</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-14">14</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-15">15</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_3229f5ca334f4d2faab09a82f880df02-1"></a><span class="cp">#ifndef FFI_TEST_H</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-2"></a><span class="cp">#define FFI_TEST_H</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-3"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-4"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-5"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-6"></a><span class="k">struct</span> <span class="n">object</span><span class="p">;</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-7"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-8"></a><span class="k">struct</span> <span class="n">object</span><span class="o">*</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-9"></a><span class="kt">void</span> <span class="nf">free_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span><span class="o">*</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-10"></a><span class="kt">int</span> <span class="nf">get_api_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-11"></a><span class="kt">int</span> <span class="nf">get_info</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">object</span><span class="o">*</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-12"></a><span class="kt">void</span> <span class="nf">set_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-13"></a><span class="kt">size_t</span> <span class="nf">sizeof_obj</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-14"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-15"></a><span class="cp">#endif </span><span class="cm">/* FFI_TEST_H */</span><span class="cp"></span>
</pre></td>
</tr></table>
<p>In particular, there is an opaque struct that is declared by the line <code>struct object;</code>. (An
opaque struct is a struct whose definition is hidden from the public API; the definition is
provided in the file <tt class="docutils literal"><span class="pre">ffi-test.c</span></tt>.) This object will hold the data for our plugin, but, because
it is opaque, we will only be able to interact with it through functions such as <tt class="docutils literal">init</tt>,
<tt class="docutils literal">free_object</tt>, etc. that are provided by the API.</p>
<p>To build the C library on UNIX-like systems, simply execute the <tt class="docutils literal">make</tt> command from within the
<tt class="docutils literal"><span class="pre">ffi-test</span></tt> library.</p>
<pre class="code console"><a name="rest_code_d952c6d87ba5421786543314ce9f4b86-1"></a><span class="gp">$</span> make
<a name="rest_code_d952c6d87ba5421786543314ce9f4b86-2"></a><span class="go">gcc -c -o libffi-test.o -fpic ffi-test.c -Wall -Werror</span>
<a name="rest_code_d952c6d87ba5421786543314ce9f4b86-3"></a><span class="go">gcc -shared -o libffi-test.so libffi-test.o</span>
</pre>
</div>
<div class="section" id="the-rust-c-plugin-interface">
<h2>The Rust-C plugin interface</h2>
<p>The Rust code is contained in one source file, <a class="reference external" href="https://github.com/kmdouglass/rust-libloading-example/blob/master/src/main.rs">src/main.rs</a>. The design pattern contained within
consists of three kinds of objects:</p>
<ul class="simple">
<li>type definitions for the functions in the C library</li>
<li>a <tt class="docutils literal">VTable</tt> struct that holds the external function types</li>
<li>a <tt class="docutils literal">Plugin</tt> struct that holds the plugin's library, the <tt class="docutils literal">VTable</tt>, and a raw pointer to the
object provided by the C library</li>
</ul>
<p>Let's take a look at each of these abstractions.</p>
<div class="section" id="external-function-types">
<h3>External function types</h3>
<p>The external function types are defined as follows:</p>
<pre class="code rust"><a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-2"></a><span class="k">struct</span> <span class="nc">Object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-3"></a><span class="w">    </span><span class="n">_private</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-4"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-5"></a><span class="k">type</span> <span class="nc">FreeObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-6"></a><span class="k">type</span> <span class="nc">Init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-7"></a><span class="k">type</span> <span class="nc">GetApiVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">c_int</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-8"></a><span class="k">type</span> <span class="nc">GetInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">c_int</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-9"></a><span class="k">type</span> <span class="nc">SetInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">c_int</span><span class="p">);</span><span class="w"></span>
</pre>
<p>The opaque struct from the C library is represented as rust <tt class="docutils literal">struct</tt> with a single, private field
containing an empty array. <a class="reference external" href="https://doc.rust-lang.org/nomicon/ffi.html#representing-opaque-structs">This is currently the recommended way</a> to represent opaque structs in
the Rust FFI. Following the <tt class="docutils literal">struct</tt> definition are the type definitions for the foreign
functions.</p>
<pre class="code rust"><a name="rest_code_4106bf0f510f4ff7b584fb5f36d30624-1"></a><span class="k">type</span> <span class="nc">FreeObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_4106bf0f510f4ff7b584fb5f36d30624-2"></a><span class="k">type</span> <span class="nc">Init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_4106bf0f510f4ff7b584fb5f36d30624-3"></a><span class="c1">// ...</span>
</pre>
<p>For example, the <tt class="docutils literal">Init</tt> type represents a foreign C function that takes no arguments and returns
a mutable raw pointer to an <tt class="docutils literal">Object</tt> instance. This function type therefore represents the
<tt class="docutils literal">Object</tt> constructor in Rust.</p>
</div>
<div class="section" id="the-vtable">
<h3>The VTable</h3>
<p>The <tt class="docutils literal">VTable</tt> serves as a way to collect the types associated with the C library functions into
one place. Furthermore, I added a version number to make it <tt class="docutils literal">VTableV0</tt>. The purpose in doing this
is to easily maintain backwards compatability with and follow changes to the C API.</p>
<p>By looking at its definition, you can see that it contains a few <tt class="docutils literal">RawSymbol</tt> instances:</p>
<pre class="code rust"><a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-1"></a><span class="k">struct</span> <span class="nc">VTableV0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-2"></a><span class="w">    </span><span class="n">free_object</span>: <span class="nc">RawSymbol</span><span class="o">&lt;</span><span class="n">FreeObject</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-3"></a><span class="w">    </span><span class="n">get_info</span>: <span class="nc">RawSymbol</span><span class="o">&lt;</span><span class="n">GetInfo</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-4"></a><span class="w">    </span><span class="n">set_info</span>: <span class="nc">RawSymbol</span><span class="o">&lt;</span><span class="n">SetInfo</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-5"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>A <tt class="docutils literal">RawSymbol</tt> is a name that I gave to Unix-specific symbols from the <tt class="docutils literal">libloading</tt> Rust
library. (See the <tt class="docutils literal">use</tt> statements at the top of the source code file.) I am not storing plain
<tt class="docutils literal">Symbols</tt> from that library inside the VTable because the lifetime constraints associated with
plain <tt class="docutils literal">Symbols</tt> and their corresponding <tt class="docutils literal">Library</tt> do not allow me to take ownership of them
inside the struct. (You can find a few attempts in the commit history of this repository where I
tried to own plain <tt class="docutils literal">Symbols</tt>; none of these attempts would compile.)</p>
<p>Instead, if I had used a plain <tt class="docutils literal">Symbol</tt>, then I would have had to lookup the symbols inside the C
library each time that I wanted to call them.</p>
<p>The way to obtain <tt class="docutils literal">RawSymbols</tt> is to use the <tt class="docutils literal">into_raw</tt> method of a plain <tt class="docutils literal">Symbol</tt>. You can
find an example of this inside the <tt class="docutils literal">VTable</tt>'s constructor:</p>
<pre class="code rust"><a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-1"></a><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">library</span>: <span class="kp">&amp;</span><span class="nc">Library</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">VTableV0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-2"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Loading API version 0..."</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">free_object</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">FreeObject</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"free_object</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">free_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_object</span><span class="p">.</span><span class="n">into_raw</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-5"></a><span class="w">    </span><span class="c1">// ...</span>
</pre>
<p>First, the <tt class="docutils literal">free_object</tt> <tt class="docutils literal">Symbol</tt> is imported from the library using the <tt class="docutils literal">get()</tt> method from
the library, then it is converted to a <tt class="docutils literal">RawSymbol</tt> in the following line so that it can be stored
inside the <tt class="docutils literal">VTableV0</tt> struct that is returned by the constructor. The whole function is marked as
<tt class="docutils literal">unsafe</tt> because of the multiple calls to the <tt class="docutils literal">get</tt> method.</p>
</div>
<div class="section" id="the-plugin">
<h3>The Plugin</h3>
<p>Finally we reach the top of the hierarchy of the components that comprise this design, the
<tt class="docutils literal">Plugin</tt> struct. Its implementation follows:</p>
<pre class="code rust"><a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-1"></a><span class="k">struct</span> <span class="nc">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-2"></a><span class="w">    </span><span class="cp">#[allow(dead_code)]</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-3"></a><span class="w">    </span><span class="n">library</span>: <span class="nc">Library</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-4"></a><span class="w">    </span><span class="n">object</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-5"></a><span class="w">    </span><span class="n">vtable</span>: <span class="nc">VTableV0</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-6"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-7"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-8"></a><span class="k">impl</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-9"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">library_name</span>: <span class="kp">&amp;</span><span class="nc">OsStr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Library</span>::<span class="n">new</span><span class="p">(</span><span class="n">library_name</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-11"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">get_api_version</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">GetApiVersion</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"get_api_version</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-12"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">get_api_version</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-13"></a><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">VTableV0</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">library</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-14"></a><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">"Unrecognized C API version number."</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-15"></a><span class="w">        </span><span class="p">};</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-16"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-17"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">init</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">Init</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"init</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-18"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">object</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-19"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-20"></a><span class="w">        </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-21"></a><span class="w">            </span><span class="n">library</span>: <span class="nc">library</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-22"></a><span class="w">            </span><span class="n">object</span>: <span class="nc">object</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-23"></a><span class="w">            </span><span class="n">vtable</span>: <span class="nc">vtable</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-24"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-25"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-26"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-27"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-28"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-29"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-30"></a><span class="w">        </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">vtable</span><span class="p">.</span><span class="n">free_object</span><span class="p">)(</span><span class="bp">self</span><span class="p">.</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-31"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-32"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The interesting parts here are the <tt class="docutils literal">Plugin</tt>'s constructor <tt class="docutils literal">new</tt> and the implementation of the
<tt class="docutils literal">Drop</tt> trait. After loading the library, the constructor calls the C library function that
returns its API version; if the version matches one for which we have a <tt class="docutils literal">VTable</tt>, then we create
the new <tt class="docutils literal">VTable</tt>. Next, we instantiate an <tt class="docutils literal">Object</tt> by calling its constructor to obtain a raw
pointer to it.</p>
<pre class="code rust"><a name="rest_code_3b30d939dcb94bf5b21f9a3e5c261d24-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">init</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">Init</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"init</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_3b30d939dcb94bf5b21f9a3e5c261d24-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">object</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">();</span><span class="w"></span>
</pre>
<p>The constructor packs the library, the <tt class="docutils literal">VTable</tt>, and the object pointer into a new <tt class="docutils literal">Plugin</tt>
struct and returns it.</p>
<p>The <tt class="docutils literal">Drop</tt> trait implementation is used to automatically free the memory that has been allocated
when the pointer held by the <tt class="docutils literal">Plugin</tt> struct goes out-of-scope. It does this by calling the
<tt class="docutils literal">free_object</tt> method in the VTable.</p>
<pre class="code rust"><a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-1"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-3"></a><span class="w">        </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">vtable</span><span class="p">.</span><span class="n">free_object</span><span class="p">)(</span><span class="bp">self</span><span class="p">.</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-4"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-5"></a><span class="p">}</span><span class="w"></span>
</pre>
</div>
<div class="section" id="running-the-example">
<h3>Running the example</h3>
<p>To run the example, run the following commands from the root directory of the example repository.</p>
<pre class="code console"><a name="rest_code_60bbc661a2b749749e78afdcefd84448-1"></a><span class="gp">$</span> cargo build
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-2"></a><span class="go">Compiling rust-libloading v0.1.0 (/home/kmdouglass/src/rust-libloading-example)</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-3"></a><span class="go"> Finished dev [unoptimized + debuginfo] target(s) in 0.27s</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-4"></a><span class="gp">$</span> cargo run
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-5"></a><span class="go"> Finished dev [unoptimized + debuginfo] target(s) in 0.01s</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-6"></a><span class="go">  Running `target/debug/rust-libloading`</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-7"></a><span class="go">Loading API version 0...</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-8"></a><span class="go">Original value: 0</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-9"></a><span class="go">New value: 42</span>
</pre>
<p>The <tt class="docutils literal">main</tt> method of the Rust code creates the plugin, prints the default value of the data held
by the object (which is instantiated by the C library), and then mutates the data to the value
<tt class="docutils literal">42</tt>.</p>
<p>It then prints this value, demonstrating that the FFI calls work.</p>
</div>
</div>
<div class="section" id="discussion">
<h2>Discussion</h2>
<p>The most difficult part of developing this design was finding a way to own the symbols exposed by
the plugin library. For me, it was not completely evident from the <a class="reference external" href="https://docs.rs/libloading/0.5.1/libloading/">libloading documentation</a> that
this was the purpose of the <tt class="docutils literal">into_raw</tt> method on a <tt class="docutils literal">Symbol</tt>.</p>
<p>What I like about this design is that the whole plugin interface fits nicely within a simple
hierarchy with a collection of foreign method types at its base. It also supports changes to the C
API because a new <tt class="docutils literal">VTable</tt> can be created each time the API changes.</p>
<p>One current disadvantage of the design is that <tt class="docutils literal">free_object</tt> is exposed through the VTable. I
think that this opens the possibility for a double-free error. One way to prevent this is to hide
the <tt class="docutils literal">free_object</tt> method, loading its corresponding symbol only when the <tt class="docutils literal">drop</tt> method is
called.</p>
<p>Another disadvantage of this design is that it relies on the particular C API exposed by the
library. C programmers have a large amount of freedom in designing APIs for their libraries. They
are not forced to use opaque structs or to version their APIs. As a result, I don't believe that
the plugin design presented here can be completely generalized to any C library.</p>
<p>The <tt class="docutils literal">Plugin</tt> struct is almost certainly not thread safe. To make it thread safe, it may be
necessary to wrap the raw pointer in a <tt class="docutils literal">Mutex</tt>. It may even be simpler to wrap the entire struct
in a <tt class="docutils literal">Mutex</tt>.</p>
<p>Finally, owning raw symbols is not platform independent. You can see at the top of the Rust source
code that I am importing the <tt class="docutils literal">Symbol</tt> object specific to UNIX systems. One would need to change
this if it was intended to work on Windows.</p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<ul class="simple">
<li>I presented a design pattern for managing C-language plugins in Rust.</li>
<li>The design pattern consists of a collection of foreign object function types, the
<tt class="docutils literal">VTable</tt>. This collection is part of a larger collection which owns pointers to the opaque data
types exposed by the library, as well as the plugin library itself.</li>
<li>The trick to owning symbols (instead of looking them up in the library each time you want to use
them), is to use <tt class="docutils literal">into_raw</tt> method that is implemented on libloading's <tt class="docutils literal">Symbol</tt>.</li>
<li>This design cannot be completely generalized to any C library, but should provide a good starting
point to work with FFI plugins in Rust.</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/complex-data-types-and-the-rust-ffi/" class="u-url">Complex data types and the Rust FFI</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/complex-data-types-and-the-rust-ffi/" rel="bookmark">
            <time class="published dt-published" datetime="2019-04-04T19:51:55+02:00" itemprop="datePublished" title="2019-04-04 19:51">2019-04-04 19:51</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/complex-data-types-and-the-rust-ffi/#disqus_thread" data-disqus-identifier="cache/posts/complex-data-types-and-the-rust-ffi.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>The <a class="reference external" href="https://doc.rust-lang.org/nomicon/ffi.html">Rust Foreign Function Interface</a> (FFI, for short) is a feature of Rust that enables the
sharing of data and functions between parts of code that have been written in different
languages. I am interested in the FFI because many libraries used in embedded systems are written
in C, and I would like to leverage them for my embedded work with Rust.</p>
<p>I quickly learned from my initial experiments with the Rust FFI that one of its challenges is
casting data types into a form that may be consumed by other languages. This challenge is not
unique to the Rust FFI, and there are numerous reasons for it. For one, different languages use
different mechanisms to layout data in the computer's memory. What's more, names for functions and
data types are often mangled, which means that the symbol in a library that maps to a function may
be different than the name that you give to the function in your code. As far as I know, C
compilers do not mangle symbol names, and partly for this reason the C language is often used as an
intermediary language in FFIs. Converting Rust to C is therefore an important skill when using Rust
for multi-language work.</p>
<p>There are a few good resources on the internet about using the Rust FFI to expose functions written
in Rust to other languages. However, I found little information about passing data types between
languages. To help remedy this situation, I describe in this post a simple Rust library that I
wrote to explore how to pass complex data types from Rust to C.</p>
<div class="section" id="an-example-ffi-project">
<h2>An example FFI project</h2>
<p>I created the Rust library in the typical way by first starting a new project with Cargo:</p>
<pre class="code shell"><a name="rest_code_372b84d1c7254bbaa80260de2378dbce-1"></a>$ cargo new --lib rstruct
<a name="rest_code_372b84d1c7254bbaa80260de2378dbce-2"></a>$ <span class="nb">cd</span> rstruct
</pre>
<p>Inside, I modified the contents of <tt class="docutils literal">Cargo.toml</tt> to the following:</p>
<pre class="code text"><a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-1"></a>[package]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-2"></a>name = "rstruct"
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-3"></a>version = "0.1.0"
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-4"></a>authors = ["Kyle M. Douglass"]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-5"></a>edition = "2018"
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-6"></a>
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-7"></a>[lib]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-8"></a>crate-type = ["cdylib"]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-9"></a>
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-10"></a>[dependencies]
</pre>
<p>The only lines that I added were <tt class="docutils literal">[lib]</tt> and <tt class="docutils literal"><span class="pre">crate-type</span> = ["cdylib"]</tt>. As described in the
<a class="reference external" href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/cdylib-crates-for-c-interoperability.html">2018 edition guide</a>, this type of crate produces a binary that has no Rust-specific information
in it and is intended for use through a C FFI.</p>
<p>Next, I opened the <tt class="docutils literal">src/lib.rs</tt> source file, removed the auto-generated content, and added the
following source.</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-1"> 1</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-2"> 2</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-3"> 3</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-4"> 4</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-5"> 5</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-6"> 6</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-7"> 7</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-8"> 8</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-9"> 9</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-10">10</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-11">11</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-12">12</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-13">13</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-14">14</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-15">15</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-16">16</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-17">17</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-18">18</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-19">19</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-20">20</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-21">21</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-22">22</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-23">23</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-24">24</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-25">25</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-26">26</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-27">27</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-28">28</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-29">29</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-30">30</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-31">31</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-32">32</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-33">33</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-34">34</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-35">35</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-36">36</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-37">37</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_d724c2d6c3244a979b169b4a559585b7-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">CString</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_char</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-4"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-5"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-6"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-7"></a><span class="w">    </span><span class="n">name</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_char</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-8"></a><span class="w">    </span><span class="n">value</span>: <span class="nc">Value</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-9"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-10"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-11"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-12"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-13"></a><span class="w">    </span><span class="n">_Int</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-14"></a><span class="w">    </span><span class="n">_Float</span><span class="p">(</span><span class="kt">f64</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-15"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-16"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-17"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-18"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-19"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="s">"Inside data_new()."</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-20"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-21"></a><span class="w">    </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-22"></a><span class="w">        </span><span class="n">name</span>: <span class="nc">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"my_rstruct"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-23"></a><span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error: CString::new()"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-24"></a><span class="w">            </span><span class="p">.</span><span class="n">into_raw</span><span class="p">(),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-25"></a><span class="w">        </span><span class="n">value</span>: <span class="nc">Value</span>::<span class="n">_Int</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-26"></a><span class="w">    </span><span class="p">}))</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-27"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-28"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-29"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-30"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_free</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-32"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-33"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-34"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-35"></a><span class="w">        </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-36"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-37"></a><span class="p">}</span><span class="w"></span>
</pre></td>
</tr></table>
<p>Roughly speaking, this simple library does two things. First, it defines two data types, a struct
called <tt class="docutils literal">RStruct</tt> and a Rust enum (not to be confused with a C enum!) called <tt class="docutils literal">Value</tt>. Second, it
exposes two functions that may be used to access instances of these data types from C:
<tt class="docutils literal">data_new()</tt> and <tt class="docutils literal">data_free()</tt>.</p>
<p>Let's take closer look now at what the code is doing.</p>
</div>
<div class="section" id="defining-structs-and-enums-for-use-in-c">
<h2>Defining structs and enums for use in C</h2>
<p>I want to expose instances of the RStruct type to C code. The definition of <tt class="docutils literal">RStruct</tt> is</p>
<pre class="code rust"><a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-3"></a><span class="w">    </span><span class="n">name</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_char</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-4"></a><span class="w">    </span><span class="n">value</span>: <span class="nc">Value</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-5"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The first line here is <tt class="docutils literal">[repr(C)]</tt>. This is an attribute that modifies the layout of the struct
in memory to "do what C does." As described in the <a class="reference external" href="https://doc.rust-lang.org/nomicon/other-reprs.html">Rustonomicon</a>,</p>
<blockquote>
The order, size, and alignment of fields is exactly what you would expect from C or C++. Any
type you expect to pass through an FFI boundary should have repr(C), as C is the lingua-franca
of the programming world.</blockquote>
<p>Next, we define a public struct just as we would if we were writing typical Rust code. In this
example, the struct has two fields. The first is a field called <tt class="docutils literal">name</tt>, which has a type <tt class="docutils literal">*const
c_char</tt>. The Rust data types <tt class="docutils literal">String</tt> and <tt class="docutils literal">&amp;str</tt> cannot be interpreted in C, so instead we
define the data type as a <a class="reference external" href="https://doc.rust-lang.org/std/primitive.pointer.html">raw pointer</a> to a <tt class="docutils literal">c_char</tt>. (In this case, <tt class="docutils literal">*</tt> is not dereferencing
the pointer but is <a class="reference external" href="https://doc.rust-lang.org/beta/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer">part of the type name</a> <tt class="docutils literal">*const T</tt>.)</p>
<p>The second field is an enum whose definition follows:</p>
<pre class="code rust"><a name="rest_code_50968308faa5491b9ed28adbef50b95c-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-3"></a><span class="w">    </span><span class="n">_Int</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-4"></a><span class="w">    </span><span class="n">_Float</span><span class="p">(</span><span class="kt">f64</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-5"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>Again we use <tt class="docutils literal">#[repr(C)]</tt> to indicate that we want the enum to be laid out in memory in the same
manner as in C. The enum <tt class="docutils literal">Value</tt> has two variants, <tt class="docutils literal">_Int</tt> and <tt class="docutils literal">_Float</tt>, that each contain a
value of <tt class="docutils literal">i32</tt> and <tt class="docutils literal">f64</tt>, respectively. If you're familiar with C, then you may have already
noticed that C enums are differnt from Rust enums in that they do not hold any data themselves. How
this minor annoyance is solved will be seen later when we generate the C header for this library.</p>
<p>The data types i32 and f64 are easily translated into C's equivalent numeric data types, so there
is no need to do anything special with them.</p>
<div class="section" id="instantiating-and-freeing-memory">
<h3>Instantiating and freeing Memory</h3>
<p>Following the data type definitions, there are two functions that are exposed through the FFI
boundary, one for instantiating an <tt class="docutils literal">RStruct</tt> and one for freeing the memory associated with an
<tt class="docutils literal">RStruct</tt>. The method for instantiation is first:</p>
<pre class="code rust"><a name="rest_code_c5c45d679080471fa4e88d3ba112337f-1"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-3"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="s">"Inside data_new()."</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-4"></a>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-5"></a><span class="w">    </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-6"></a><span class="w">        </span><span class="n">name</span>: <span class="nc">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"my_rstruct"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-7"></a><span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error: CString::new()"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-8"></a><span class="w">            </span><span class="p">.</span><span class="n">into_raw</span><span class="p">(),</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-9"></a><span class="w">        </span><span class="n">value</span>: <span class="nc">Value</span>::<span class="n">_Int</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-10"></a><span class="w">    </span><span class="p">}))</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-11"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The first line contains an attribute called <tt class="docutils literal">#[no_mangle]</tt>. As defined in <a class="reference external" href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#calling-rust-functions-from-other-languages">the Book</a>:</p>
<blockquote>
Mangling is when a compiler changes the name we’ve given a function to a different name that
contains more information for other parts of the compilation process to consume but is less
human readable.</blockquote>
<p>Placing the <tt class="docutils literal">#[no_mangle]</tt> attribute before the function definition ensures that the function
name matches that of the corresponding symbol in the library.</p>
<p>Next is the function definition <tt class="docutils literal">pub extern "C" fn data_new() <span class="pre">-&gt;</span> *mut RStruct</tt>. Let's break this
down into parts to understand it better:</p>
<ul class="simple">
<li>
<tt class="docutils literal">pub</tt> : The function will be callable from outside the library</li>
<li>
<tt class="docutils literal">extern "C"</tt> : This line serves two different purposes in Rust, both related to FFI. In my
case, I use it specify that the function should be exposed with the <a class="reference external" href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#using-extern-functions-to-call-external-code">application binary interface
from C</a>.</li>
<li>
<tt class="docutils literal">fn data_new()</tt> : This is just the usual <tt class="docutils literal">fn</tt> keyword and the name of the function</li>
<li>
<tt class="docutils literal"><span class="pre">-&gt;</span> *mut RStruct</tt> : Here I specify that the function will return a mutable, raw pointer to an
<tt class="docutils literal">RStruct instance</tt>.</li>
</ul>
<p>The purpose of this function is to create a <tt class="docutils literal">RStruct</tt> instance and return a pointer to it. The
<tt class="docutils literal">RStruct</tt> is created just as we would any other struct in Rust, with the exception of the
<tt class="docutils literal">name</tt> field:</p>
<pre class="code rust"><a name="rest_code_db22fa28688d448aa57c1b463f3b296e-1"></a><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-2"></a><span class="w">    </span><span class="n">name</span>: <span class="nc">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"my_rstruct"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-3"></a><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error: CString::new()"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-4"></a><span class="w">        </span><span class="p">.</span><span class="n">into_raw</span><span class="p">(),</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-5"></a><span class="w">    </span><span class="n">value</span>: <span class="nc">Value</span>::<span class="n">_Int</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-6"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The <tt class="docutils literal">CString</tt> is first created with the <tt class="docutils literal">new()</tt> constructor and contains the value
<tt class="docutils literal">"my_rstruct"</tt>. After unpacking the result with <tt class="docutils literal">expect()</tt>, I call the <tt class="docutils literal">into_raw()</tt> method to
create a raw pointer to the C string whose <a class="reference external" href="https://doc.rust-lang.org/std/ffi/struct.CString.html#method.into_raw">ownership will be passed off to the calling C
code</a>. (If I had used <tt class="docutils literal">as_ptr()</tt> instead, the pointer would have been dropped immediately after
the function call because the <tt class="docutils literal">CString</tt> <a class="reference external" href="https://doc.rust-lang.org/std/ffi/struct.CString.html#method.as_ptr">would have been deallocated</a>.) The <tt class="docutils literal">value</tt> field is
instantiated as it would be in normal Rust.</p>
<p>What is perhaps new in this method is the <tt class="docutils literal">Box</tt> type that wraps the <tt class="docutils literal">RStruct</tt> instance.</p>
<pre class="code rust"><a name="rest_code_23022038f17b42e8a9a6086151a67fda-1"></a><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">))</span><span class="w"></span>
</pre>
<p>A <tt class="docutils literal">Box</tt> is one of Rust's smart pointers that is used to <a class="reference external" href="https://doc.rust-lang.org/book/ch15-01-box.html">allocate memory for a data type on the
heap</a>. When <tt class="docutils literal"><span class="pre">Box::new()</span></tt> is called it creates a pointer to the newly created <tt class="docutils literal">RStruct</tt>
instance. Normally, this pointer would be dropped and the memory automatically deallocated when the
<tt class="docutils literal">data_new()</tt> function returns. However, the <tt class="docutils literal"><span class="pre">Box::into_raw()</span></tt> function serves the same purpose
here as the corresponding function for <tt class="docutils literal">CString</tt>: it hands off ownership of the pointer to the
calling code so that the memory is not deallocated.</p>
<p>There is a rule-of-thumb that memory allocated by Rust should be freed by Rust. For this reason, we
provide the <tt class="docutils literal">data_free()</tt> method that C code may use to deallocate the memory that is allocated
by <tt class="docutils literal">data_new()</tt>.</p>
<pre class="code rust"><a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-1"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_free</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-6"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-7"></a><span class="w">        </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-8"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-9"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>This function accepts a mutable pointer to an RStruct. First, it checks whether the pointer is null
and if it is, the function returns without doing anything. Assuming that the pointer is not null,
the <tt class="docutils literal">Box</tt> is reconstructed from it inside an <tt class="docutils literal">unsafe</tt> block because <tt class="docutils literal">from_raw()</tt> <a class="reference external" href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.from_raw">is
unsafe</a>. Importantly, this new Box pointer will go out of scope at the end of the function so that
it will automatically be dropped when the function returns.</p>
<p>Building the library is simple. I run <tt class="docutils literal">cargo build <span class="pre">--release</span></tt> to build a release version. The
library itself will be found at <tt class="docutils literal">target/release/librstruct.so</tt>. On Linux, one can verify that it
contains the <tt class="docutils literal">data_new()</tt> and <tt class="docutils literal">data_free()</tt> methods by displaying its symbols with the <tt class="docutils literal">nm
<span class="pre">-g</span></tt> command:</p>
<pre class="code console"><a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-1"></a><span class="gp">$</span> nm -g target/release/librstruct.so
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-2"></a><span class="gp">#</span> snip
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-3"></a><span class="go">00000000000046c0 T data_free</span>
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-4"></a><span class="go">00000000000044e0 T data_new</span>
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-5"></a><span class="gp">#</span> snip
</pre>
</div>
<div class="section" id="generating-the-header-for-the-library">
<h3>Generating the header for the library</h3>
<p>Now that I have a shared library, I want to access the functions that it exposes from C. To do
this, I first need a header file that I can use to import the library's declarations into the C
code. Moreover, generating the header can help in understanding how Rust translates its data types
to C.</p>
<p>I will use <a class="reference external" href="https://github.com/eqrion/cbindgen">cbindgen</a> to automatically generate the header. <tt class="docutils literal">cbindgen</tt> is installed with the
command</p>
<pre class="code console"><a name="rest_code_ac72fd56120b497b9d8d1c1be7dbf49e-1"></a><span class="gp">$</span> cargo install cbindgen
</pre>
<p><tt class="docutils literal">cbindgen</tt> is highly configurable, but for the project described here I only need its most basic
functionality. Assuming that I am in the root directory of my Rust project, I generate the header
<tt class="docutils literal">rstruct.h</tt> with the following</p>
<pre class="code console"><a name="rest_code_dabad64b9038496cba08a30fc4e7f836-1"></a><span class="gp">$</span> cbindgen --lang C -o rstruct.h .
</pre>
<p>After running <tt class="docutils literal">cbindgen</tt> there is a new file called <tt class="docutils literal">rstruct.h</tt> in the project folder. Here are
its contents:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-1"> 1</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-2"> 2</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-3"> 3</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-4"> 4</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-5"> 5</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-6"> 6</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-7"> 7</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-8"> 8</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-9"> 9</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-10">10</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-11">11</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-12">12</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-13">13</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-14">14</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-15">15</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-16">16</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-17">17</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-18">18</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-19">19</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-20">20</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-21">21</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-22">22</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-23">23</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-24">24</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-25">25</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-26">26</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-27">27</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-28">28</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-29">29</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-30">30</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-31">31</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-32">32</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-33">33</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-34">34</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-1"></a><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-2"></a><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-3"></a><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-4"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-5"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-6"></a><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-7"></a>  <span class="n">_Int</span><span class="p">,</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-8"></a>  <span class="n">_Float</span><span class="p">,</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-9"></a><span class="p">}</span> <span class="n">Value_Tag</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-10"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-11"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-12"></a>  <span class="kt">int32_t</span> <span class="n">_0</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-13"></a><span class="p">}</span> <span class="n">_Int_Body</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-14"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-15"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-16"></a>  <span class="kt">double</span> <span class="n">_0</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-17"></a><span class="p">}</span> <span class="n">_Float_Body</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-18"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-19"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-20"></a>  <span class="n">Value_Tag</span> <span class="n">tag</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-21"></a>  <span class="k">union</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-22"></a>    <span class="n">_Int_Body</span> <span class="n">_int</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-23"></a>    <span class="n">_Float_Body</span> <span class="n">_float</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-24"></a>  <span class="p">};</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-25"></a><span class="p">}</span> <span class="n">Value</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-26"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-27"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-28"></a>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-29"></a>  <span class="n">Value</span> <span class="n">value</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-30"></a><span class="p">}</span> <span class="n">RStruct</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-31"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-32"></a><span class="kt">void</span> <span class="nf">data_free</span><span class="p">(</span><span class="n">RStruct</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-33"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-34"></a><span class="n">RStruct</span> <span class="o">*</span><span class="nf">data_new</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></td>
</tr></table>
<p>First, you can see the <tt class="docutils literal">enum</tt> that contains the variations of the <tt class="docutils literal">Value</tt> data type that is
stored in the <tt class="docutils literal">RStruct</tt> and that was defined in Rust. The name of this new type is <tt class="docutils literal">Value_Tag</tt>,
and it is used to define the current type of a value.</p>
<pre class="code c"><a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-1"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-2"></a>  <span class="n">Value_Tag</span> <span class="n">tag</span><span class="p">;</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-3"></a>  <span class="k">union</span> <span class="p">{</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-4"></a>    <span class="n">_Int_Body</span> <span class="n">_int</span><span class="p">;</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-5"></a>    <span class="n">_Float_Body</span> <span class="n">_float</span><span class="p">;</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-6"></a>  <span class="p">};</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-7"></a><span class="p">}</span> <span class="n">Value</span><span class="p">;</span>
</pre>
<p>A <tt class="docutils literal">Value</tt> is just another struct that contains a <tt class="docutils literal">Value_Tag</tt> field to identify which variant of
the <tt class="docutils literal">enum</tt> it is holding and a <tt class="docutils literal">union</tt> field that holds the actual value.</p>
<p>The important thing to understand here is that <tt class="docutils literal">cbindgen</tt> effectively uses nested C data types to
represent complex Rust data structures. In particular, Rust <tt class="docutils literal">enums</tt> are a combination of C
<tt class="docutils literal">structs</tt>, <tt class="docutils literal">enums</tt>, and <tt class="docutils literal">unions</tt>.</p>
</div>
</div>
<div class="section" id="calling-the-library-from-c">
<h2>Calling the library from C</h2>
<p>With everything in place, it's now time to write the C program. My example C program looks like the
following:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-1"> 1</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-2"> 2</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-3"> 3</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-4"> 4</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-5"> 5</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-6"> 6</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-7"> 7</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-8"> 8</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-9"> 9</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-10">10</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-11">11</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-12">12</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-13">13</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-14">14</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-15">15</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-16">16</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-17">17</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-18">18</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-19">19</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-20">20</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-21">21</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-22">22</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-23">23</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-24">24</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-25">25</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-26">26</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-27">27</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-28">28</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-29">29</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-30">30</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-31">31</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-32">32</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-33">33</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-34">34</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-35">35</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-36">36</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-37">37</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-38">38</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-39">39</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-40">40</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-41">41</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-42">42</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-43">43</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-44">44</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-45">45</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-46">46</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-47">47</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-48">48</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-49">49</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-50">50</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-51">51</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-52">52</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-53">53</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-1"></a><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-2"></a><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-3"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-4"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-5"></a><span class="cp">#include</span> <span class="cpf">"rstruct.h"</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-6"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-7"></a><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-8"></a>  <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span><span class="p">;</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-9"></a>  <span class="n">RStruct</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">data_new</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-10"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">data_free</span><span class="p">)(</span><span class="n">RStruct</span><span class="o">*</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-11"></a>  <span class="kt">char</span><span class="o">*</span> <span class="n">error</span><span class="p">;</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-12"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-13"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Loading librstruct.so...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-14"></a>  <span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-15"></a>    <span class="s">"librstruct.so"</span><span class="p">,</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-16"></a>    <span class="n">RTLD_LAZY</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-17"></a>  <span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-18"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-19"></a>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dlerror</span><span class="p">());</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-20"></a>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-21"></a>  <span class="p">}</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-22"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Done.</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-23"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-24"></a>  <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-25"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-26"></a>  <span class="n">data_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">RStruct</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_new"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-27"></a>  <span class="n">error</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-28"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-29"></a>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-30"></a>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-31"></a>  <span class="p">}</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-32"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-33"></a>  <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-34"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-35"></a>  <span class="n">data_free</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">RStruct</span><span class="o">*</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_free"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-36"></a>  <span class="n">error</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-37"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-38"></a>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-39"></a>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-40"></a>  <span class="p">}</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-41"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-42"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Calling data_new() from main.c...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-43"></a>  <span class="n">RStruct</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">data_new</span><span class="p">)();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-44"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-45"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Back inside main.c. Printing results...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-46"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Name: %s</span><span class="se">\n</span><span class="s">Value: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">_int</span><span class="p">.</span><span class="n">_0</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-47"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-48"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Freeing the RStruct data...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-49"></a>  <span class="p">(</span><span class="o">*</span><span class="n">data_free</span><span class="p">)(</span><span class="n">data</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-50"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-51"></a>  <span class="n">dlclose</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-52"></a>  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-53"></a><span class="p">}</span>
</pre></td>
</tr></table>
<p>This code is based on the example in the <tt class="docutils literal">dlopen()</tt> <a class="reference external" href="https://linux.die.net/man/3/dlopen">man pages</a>. In particular, the library file
is opened and a handle attached to it here:</p>
<pre class="code c"><a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-1"></a><span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span>
<a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-2"></a>  <span class="s">"librstruct.so"</span><span class="p">,</span>
<a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-3"></a>  <span class="n">RTLD_LAZY</span>
<a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-4"></a><span class="p">);</span>
</pre>
<p>A function pointer to <tt class="docutils literal">data_new()</tt> is created with <tt class="docutils literal">dlsym()</tt>, and we use the function to create
the new <tt class="docutils literal">RStruct</tt> instance with the lines</p>
<pre class="code c"><a name="rest_code_9d098eaff0ac46999a9dc26da0977ae6-1"></a><span class="n">data_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">RStruct</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_new"</span><span class="p">);</span>
<a name="rest_code_9d098eaff0ac46999a9dc26da0977ae6-2"></a><span class="c1">// snip</span>
<a name="rest_code_9d098eaff0ac46999a9dc26da0977ae6-3"></a><span class="n">RStruct</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">data_new</span><span class="p">)();</span>
</pre>
<p>Finally, the data is freed by creating another function pointer to <tt class="docutils literal">data_free()</tt> and calling it.</p>
<pre class="code c"><a name="rest_code_cfc11c485be44561b409afeea33674f4-1"></a><span class="n">data_free</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">RStruct</span><span class="o">*</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_free"</span><span class="p">);</span>
<a name="rest_code_cfc11c485be44561b409afeea33674f4-2"></a><span class="c1">// snip</span>
<a name="rest_code_cfc11c485be44561b409afeea33674f4-3"></a><span class="p">(</span><span class="o">*</span><span class="n">data_free</span><span class="p">)(</span><span class="n">data</span><span class="p">);</span>
</pre>
<div class="section" id="running-the-program">
<h3>Running the program</h3>
<p>I wrote a small Makefile to handle compilation of the C and Rust programs while I wrote this
post. I won't include it here because it distracts from the main message about the Rust
FFI. Instead, I will describe how to compile the program from the command line.</p>
<p>I first placed the <tt class="docutils literal">librstruct.so</tt>, <tt class="docutils literal">rstruct.h</tt>, and <tt class="docutils literal">main.c</tt> programs into the following
directory structure:</p>
<pre class="code console"><a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-1"></a><span class="gp">$</span> tree
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-2"></a><span class="go">.</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-3"></a><span class="go">├── include</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-4"></a><span class="go">│   └── rstruct.h</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-5"></a><span class="go">├── lib</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-6"></a><span class="go">│   └── librstruct.so</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-7"></a><span class="go">└── src</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-8"></a><span class="go">    └── main.c</span>
</pre>
<p>Next, I compiled the <tt class="docutils literal">main</tt> binary with gcc.</p>
<pre class="code console"><a name="rest_code_352cf378f2f64574baa4bb2b8fe8a162-1"></a><span class="gp">$</span> gcc -Wall -g -Iinclude -c -o main.o main.c
<a name="rest_code_352cf378f2f64574baa4bb2b8fe8a162-2"></a><span class="gp">$</span> gcc -Wall -g -o main main.o -ldl
</pre>
<p>(<tt class="docutils literal"><span class="pre">-ldl</span></tt> is used to link against libdl for dynamically loading the library from C.) After
compilation I run the <tt class="docutils literal">main</tt> binary. To make it work, I set the <tt class="docutils literal">LD_LIBRARY_PATH</tt> environment
variable so that the program knows to look inside the <tt class="docutils literal">lib</tt> directory for the <tt class="docutils literal">librstruct.so</tt>
library.</p>
<pre class="code console"><a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-1"></a><span class="gp">$</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>lib ./main
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-2"></a><span class="go">Loading librstruct.so...</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-3"></a><span class="go">Done.</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-4"></a>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-5"></a><span class="go">Calling data_new() from main.c...</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-6"></a><span class="go">Inside data_new().</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-7"></a>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-8"></a><span class="go">Back inside main.c. Printing results...</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-9"></a><span class="go">Name: my_rstruct</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-10"></a><span class="go">Value: 42</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-11"></a>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-12"></a><span class="go">Freeing the RStruct data...</span>
</pre>
<p>Nice! From the output you can see the print statements that I placed inside both the Rust and C
code to indicate where the program was as it was running. In summary, the program performs the
following sequence of events:</p>
<ul class="simple">
<li>The main binary is run</li>
<li>The <tt class="docutils literal">librstruct.so</tt> library is opened and pointers to the <tt class="docutils literal">data_new()</tt> and <tt class="docutils literal">data_free()</tt>
functions are created</li>
<li>
<tt class="docutils literal">data_new()</tt> is called, creating our Rust datatype on the heap and returning a pointer to it in
the C code</li>
<li>Information about the data type is printed from C</li>
<li>
<tt class="docutils literal">data_free()</tt> is called, freeing the memory from back inside Rust</li>
</ul>
</div>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>And that's it! I hope you enjoyed this post. It took me several days of reading and trial-and-error
to learn about this feature of Rust. The topics covered here were</p>
<ul class="simple">
<li>the Rust FFI and its purpose</li>
<li>creating a complex data type (a Rust enum nested inside a Rust struct) and exporting it through
the FFI</li>
<li>
<tt class="docutils literal">Box</tt> and <tt class="docutils literal">CString</tt> Rust data types</li>
<li>
<tt class="docutils literal">cbindgen</tt> for automatically creating header files from Rust code</li>
<li>using the Rust library from inside C</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/a-simple-unix-socket-listener-in-rust/" class="u-url">A simple UNIX socket listener in Rust</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/a-simple-unix-socket-listener-in-rust/" rel="bookmark">
            <time class="published dt-published" datetime="2019-02-24T16:25:58+01:00" itemprop="datePublished" title="2019-02-24 16:25">2019-02-24 16:25</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/a-simple-unix-socket-listener-in-rust/#disqus_thread" data-disqus-identifier="cache/posts/a-simple-unix-socket-listener-in-rust.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>I decided that I wanted to learn a new programming language in 2019. After a bit of research, I
settled upon <a class="reference external" href="https://www.rust-lang.org/">Rust</a> due to its speed, novel ideas about memory safety, and <a class="reference external" href="https://blog.rust-lang.org/2018/03/12/roadmap.html#four-target-domains">focus on two areas
that I am interested in</a>: embedded systems and WebAssembly. While I think that <a class="reference external" href="https://doc.rust-lang.org/book/">The Book</a> is the
best place to get started learning the language, nothing is really a substitute for writing code.</p>
<p>With that in mind, I developed an idea for a starting project: a background daemon for Linux
systems like the Raspberry Pi that controls and reads data from the system's peripherals. The
design of this project is inspired by Docker: a daemon process does most of the heavy work while a
command line tool communicates with the Daemon over a Unix socket (typically a file located at
<tt class="docutils literal">/var/run/docker.sock</tt>). The purpose of this post is to demonstrate the most basic realization of
this: reading text from a UNIX socket in Rust. And to emphasize that the UNIX socket is used for
communication between two separate processes, we will send messages from Bash to Rust.</p>
<p>Keep in mind that this is my first-ever Rust program, so it may not be completely idiomatic
Rust. The following was compiled with rustc 1.32.0 (9fda7c223 2019-01-16).</p>
<p>To begin, I created a new Rust project with <tt class="docutils literal">cargo</tt>.</p>
<pre class="code shell"><a name="rest_code_1ac0529c40624732939d365f9657b3e6-1"></a>$ cargo new rust-uds
<a name="rest_code_1ac0529c40624732939d365f9657b3e6-2"></a>$ <span class="nb">cd</span> rust-uds
</pre>
<p>Next, I opened the file that cargo automatically generated in <tt class="docutils literal">src/main.rs</tt>, removed the
auto-generated content, and added the following code, which is largely based on the <a class="reference external" href="https://doc.rust-lang.org/std/os/unix/net/struct.UnixListener.html#examples">example</a>
provided in the Rust documentation but with a few key differences:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-1"> 1</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-2"> 2</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-3"> 3</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-4"> 4</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-5"> 5</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-6"> 6</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-7"> 7</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-8"> 8</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-9"> 9</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-10">10</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-11">11</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-12">12</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-13">13</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-14">14</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-15">15</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-16">16</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-17">17</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-18">18</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-19">19</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-20">20</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-21">21</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-22">22</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-23">23</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-24">24</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-25">25</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-26">26</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_63f11189760146ffaafa8a373168ef4c-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">BufRead</span><span class="p">,</span><span class="w"> </span><span class="n">BufReader</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">net</span>::<span class="p">{</span><span class="n">UnixStream</span><span class="p">,</span><span class="n">UnixListener</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-4"></a>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-5"></a><span class="k">fn</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">stream</span>: <span class="nc">UnixStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">lines</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-8"></a><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-9"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-10"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-11"></a>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-12"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">"/tmp/rust-uds.sock"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-14"></a>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">listener</span><span class="p">.</span><span class="n">incoming</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-16"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-17"></a><span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-18"></a><span class="w">                </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">handle_client</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-19"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-20"></a><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-21"></a><span class="w">                </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-22"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-23"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-24"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-25"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-26"></a><span class="p">}</span><span class="w"></span>
</pre></td>
</tr></table>
<div class="section" id="explanation">
<h2>Explanation</h2>
<p>The first three lines import the necessary modules for this code example.</p>
<pre class="code rust"><a name="rest_code_89c92eb67a9b4302b8ddc395afc1b644-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">BufRead</span><span class="p">,</span><span class="w"> </span><span class="n">BufReader</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_89c92eb67a9b4302b8ddc395afc1b644-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">net</span>::<span class="p">{</span><span class="n">UnixStream</span><span class="p">,</span><span class="n">UnixListener</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_89c92eb67a9b4302b8ddc395afc1b644-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
</pre>
<p><tt class="docutils literal">BufRead</tt> is a trait that enables extra ways of reading data sources; in this case, it has an
internal buffer for reading the socket line-by-line. <tt class="docutils literal">BufReader</tt> is a struct that actually
implements the functionality in <tt class="docutils literal">BufRead</tt>. <tt class="docutils literal">UnixStream</tt> and <tt class="docutils literal">UnixListener</tt> are structs that
provide the functionality for handling the UNIX socket, and the <tt class="docutils literal"><span class="pre">std::thread</span></tt> module is used to
spawn threads.</p>
<p>The next set of lines defines a function named <tt class="docutils literal">handle_client()</tt> that is called whenever new data
arrives in the stream. The explanation for this is best left until after the <tt class="docutils literal">main()</tt> function.</p>
<p>The first line in the <tt class="docutils literal">main()</tt> function creates the UnixListener struct and binds it to the
<tt class="docutils literal">listener</tt> variable.</p>
<pre class="code rust"><a name="rest_code_08622b1f94a34b97b092a438874b4a75-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">"/tmp/rust-uds.sock"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</pre>
<p>The <tt class="docutils literal">bind()</tt> function takes a string argument that is a path to the socket file and <tt class="docutils literal">unwrap()</tt>
moves the value out of the Result that is returned by <tt class="docutils literal">bind()</tt>. (This is a pattern that is
<a class="reference external" href="https://doc.rust-lang.org/std/option/enum.Option.html#method.unwrap">discouraged</a> in Rust but is OK for quick prototypes because it simplifies the error handling.)</p>
<p>After creating the listener, <tt class="docutils literal">listener.incoming()</tt> returns an iterator over the incoming
connections to the socket. The connections are looped over in an infinite for loop; I believe that
this is more-or-less the same as a generator in Python which never raises a <tt class="docutils literal">StopIteration</tt>
exception.</p>
<p>Next, the <tt class="docutils literal">Result</tt> of the incoming streams is matched; if there is an error, it is printed and
the loop it exited:</p>
<pre class="code rust"><a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-1"></a><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-2"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-3"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-4"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>However, if the <tt class="docutils literal">Result</tt> of the connection is <tt class="docutils literal">Ok</tt>, then a new thread is spawned to handle the
new stream:</p>
<pre class="code rust"><a name="rest_code_4452be9a3e7945d6aa40ca833a2c8015-1"></a><span class="nb">Ok</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_4452be9a3e7945d6aa40ca833a2c8015-2"></a><span class="w">    </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">handle_client</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span><span class="w"></span>
<a name="rest_code_4452be9a3e7945d6aa40ca833a2c8015-3"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>Finally, the client handler is called for each connection.</p>
<pre class="code rust"><a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-1"></a><span class="k">fn</span> <span class="nf">handle_client</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">stream</span>: <span class="nc">UnixStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">lines</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-4"></a><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-6"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The handler in this case is fairly straight-forward. It shadows the original <tt class="docutils literal">stream</tt> variable by
binding it to a version of itself that has been converted to a <tt class="docutils literal">BufReader</tt>. Finally, it loops
over the <tt class="docutils literal">lines()</tt> iterator, which blocks until a new line appears in the stream.</p>
</div>
<div class="section" id="sending-messages">
<h2>Sending messages</h2>
<p>As an example, let's send messages to the Rust program via Bash using <a class="reference external" href="http://man.openbsd.org/nc">the OpenBSD version of
netcat</a>. (The OpenBSD version seems to be the default on Ubuntu-based systems.) This should
underscore the fact that the UNIX socket is really being used to communicate between two different
processes.</p>
<p>First, compile and run the Rust program to start the socket listener:</p>
<pre class="code text"><a name="rest_code_1f620754abbe490aa93573b1e8975f6f-1"></a>$ cargo run --release
<a name="rest_code_1f620754abbe490aa93573b1e8975f6f-2"></a>   Compiling rust-uds v0.1.0 (/home/kmd/src/rust-uds)
<a name="rest_code_1f620754abbe490aa93573b1e8975f6f-3"></a>    Finished release [optimized] target(s) in 1.59s
<a name="rest_code_1f620754abbe490aa93573b1e8975f6f-4"></a>     Running `target/release/rust-uds`
</pre>
<p>Open up a new terminal. You should see the socket file /tmp/rust-uds.sock:</p>
<pre class="code text"><a name="rest_code_61d72e4f90db4dbc8015a44633dc3213-1"></a>$ ls /tmp | grep rust
<a name="rest_code_61d72e4f90db4dbc8015a44633dc3213-2"></a>rust-uds.sock
</pre>
<p>Now let's send messages to the rust program. Use the following netcat command to open a connection
to the socket.</p>
<pre class="code text"><a name="rest_code_92ea3b055e0442869c07eb9de52a4eb9-1"></a>$ nc -U /tmp/rust-uds.sock
</pre>
<p>The <tt class="docutils literal"><span class="pre">-U</span></tt> is necessary to indicate to netcat that this is a UNIX stream socket. Now, start typing
text into the same window. Every time you press ENTER, you should see the same text appear in the
terminal window in which the Rust program is running. Press CTRL-C to exit the Rust socket
listener. If you re-run the program, delete the old socket first: <tt class="docutils literal">rm <span class="pre">/tmp/rust-uds.sock</span></tt></p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<ul class="simple">
<li>Use a <tt class="docutils literal">UnixListener</tt> struct to create a UNIX socket and listen to it for connections.</li>
<li>For each new connection, spawn a new thread and read the stream with a <tt class="docutils literal">BufReader</tt>.</li>
<li>Print each new line in the stream by iterating over the <tt class="docutils literal">lines()</tt> iterator of the
<tt class="docutils literal">BufReader</tt>.</li>
<li>Send commands to your Rust program from bash with <tt class="docutils literal">nc <span class="pre">-U</span> "$PATH_TO_SOCKET"</tt>.</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/linking-shared-libraries-in-micro-manager-for-linux/" class="u-url">Linking shared libraries in Micro-Manager for Linux</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/linking-shared-libraries-in-micro-manager-for-linux/" rel="bookmark">
            <time class="published dt-published" datetime="2019-01-19T12:00:37+01:00" itemprop="datePublished" title="2019-01-19 12:00">2019-01-19 12:00</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#disqus_thread" data-disqus-identifier="cache/posts/linking-shared-libraries-in-micro-manager-for-linux.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Lately I have been working on a new <a class="reference external" href="https://github.com/kmdouglass/RPi-DeviceAdapters">Video4Linux2 device adapter</a> for <a class="reference external" href="https://micro-manager.org/">Micro-Manager</a>. I
encountered the following error after adding some functionality that introduced two <a class="reference external" href="https://www.boost.org/">Boost
libraries</a> as new dependencies in my project.</p>
<pre class="code shell"><a name="rest_code_02df986928d44e26886a11efd12ce341-1"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_02df986928d44e26886a11efd12ce341-2"></a>  File <span class="s2">"RPiV4L2.py"</span>, line <span class="m">17</span>, in &lt;module&gt;
<a name="rest_code_02df986928d44e26886a11efd12ce341-3"></a>    mmc.loadDevice<span class="o">(</span><span class="s2">"camera"</span>, <span class="s2">"RPiV4L2"</span>, <span class="s2">"RPiV4L2"</span><span class="o">)</span>
<a name="rest_code_02df986928d44e26886a11efd12ce341-4"></a>  File <span class="s2">"/home/micro-manager/app/lib/micro-manager/MMCorePy.py"</span>, line <span class="m">3515</span>, in loadDevice
<a name="rest_code_02df986928d44e26886a11efd12ce341-5"></a>    <span class="k">return</span> _MMCorePy.CMMCore_loadDevice<span class="o">(</span>self, label, moduleName, deviceName<span class="o">)</span>
<a name="rest_code_02df986928d44e26886a11efd12ce341-6"></a>MMCorePy.CMMError: Failed to load device <span class="s2">"RPiV4L2"</span> from adapter module <span class="s2">"RPiV4L2"</span> <span class="o">[</span> Failed to load device adapter <span class="s2">"RPiV4L2"</span> <span class="o">[</span> Failed to load module <span class="s2">"/home/micro-manager/app/lib/micro-manager/libmmgr_dal_RPiV4L2.so.0"</span> <span class="o">[</span> /home/micro-manager/app/lib/micro-manager/libmmgr_dal_RPiV4L2.so.0: undefined symbol: _ZN5boost10filesystem6detail13dir_itr_closeERPvS3_ <span class="o">]</span> <span class="o">]</span> <span class="o">]</span>
</pre>
<p>I received this error when I tried to load the device in a Python script. At first I was puzzled
because the code compiled without problems, but I soon found that the solution was simple.</p>
<p>The key part of the message is <tt class="docutils literal">undefined symbol:
_ZN5boost10filesystem6detail13dir_itr_closeERPvS3_</tt>. To troubleshoot this, I first demangled the
symbol name by entering it at <a class="reference external" href="https://demangler.com/">https://demangler.com/</a>. I discovered that the symbol was referring to
the function <tt class="docutils literal"><span class="pre">boost::filesystem::detail::dir_itr_close(void*&amp;,</span> <span class="pre">void*&amp;)</span></tt>. I had added both the
Boost filesystem and Boost regex libraries to this device adapter as dependencies, so it was not
surprising that either of their names appeared in the error message.</p>
<p>Next, I used the <a class="reference external" href="http://man7.org/linux/man-pages/man1/ldd.1.html">ldd</a> program to check which libraries my device adapter were linked
against. (libmmgr_dal_RPiV4l2.so.0 is the name of the device adapter library file).</p>
<pre class="code shell"><a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-1"></a>$ ldd libmmgr_dal_RPiV4L2.so.0
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-2"></a>     linux-vdso.so.1 <span class="o">(</span>0x7ec21000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-3"></a>     libdl.so.2 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libdl.so.2 <span class="o">(</span>0x76e9c000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-4"></a>     libstdc++.so.6 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libstdc++.so.6 <span class="o">(</span>0x76d54000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-5"></a>     libm.so.6 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libm.so.6 <span class="o">(</span>0x76cdc000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-6"></a>     libc.so.6 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libc.so.6 <span class="o">(</span>0x76bee000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-7"></a>     libgcc_s.so.1 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libgcc_s.so.1 <span class="o">(</span>0x76bc1000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-8"></a>     libicudata.so.57 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libicudata.so.57 <span class="o">(</span>0x75334000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-9"></a>     libicui18n.so.57 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libicui18n.so.57 <span class="o">(</span>0x75187000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-10"></a>     libicuuc.so.57 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libicuuc.so.57 <span class="o">(</span>0x7505e000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-11"></a>     librt.so.1 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/librt.so.1 <span class="o">(</span>0x75048000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-12"></a>     libpthread.so.0 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libpthread.so.0 <span class="o">(</span>0x75024000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-13"></a>     /lib/ld-linux-armhf.so.3 <span class="o">(</span>0x76fb4000<span class="o">)</span>
</pre>
<p>Neither libboost_filesystem nor libboost_regex are listed, so I knew that they were not linked with
the device adapter.</p>
<p>There is a Makefile.am included in the directory of every device adapter in the Micro-Manager
project. This file is used by Autotools define how the device adapter should be compiled and
linked. Here is what my Makefile.am looked like:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-1">1</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-2">2</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-3">3</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-4">4</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-5">5</a></pre></div></td>
<td class="code"><pre class="code Makefile"><a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-1"></a><span class="nv">AM_CXXFLAGS</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_CXXFLAGS<span class="k">)</span>
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-2"></a><span class="nv">deviceadapter_LTLIBRARIES</span> <span class="o">=</span> libmmgr_dal_RPiV4L2.la
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-3"></a><span class="nv">libmmgr_dal_RPiV4L2_la_SOURCES</span> <span class="o">=</span> RPiV4L2.cpp RPiV4L2.h refactor.h ../../MMDevice/MMDevice.h ../../MMDevice/DeviceBase.h
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-4"></a><span class="nv">libmmgr_dal_RPiV4L2_la_LIBADD</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_LIBADD<span class="k">)</span>
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-5"></a><span class="nv">libmmgr_dal_RPiV4L2_la_LDFLAGS</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_LDFLAGS<span class="k">)</span>
</pre></td>
</tr></table>
<p>After experimenting a bit, I discovered that I could instruct the linker to link against shared
libraries by adding them to the <tt class="docutils literal">libmmgr_dal_RPiV4L2_la_LDFLAGS</tt> variable with the <tt class="docutils literal"><span class="pre">-l</span></tt>
flag. The resulting line now looks like:</p>
<pre class="code Makefile"><a name="rest_code_ca9552344c1245cc91c80ec3737a83d8-1"></a><span class="nv">libmmgr_dal_RPiV4L2_la_LDFLAGS</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_LDFLAGS<span class="k">)</span> -lboost_regex -lboost_filesystem
</pre>
<p>Finally, running <tt class="docutils literal">ldd</tt> on the rebuilt device adapter now shows these two libraries:</p>
<pre class="code shell"><a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-1"></a>$ ldd libmmgr_dal_RPiV4L2.so.0
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-2"></a>     linux-vdso.so.1 <span class="o">(</span>0x7ed74000<span class="o">)</span>
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-3"></a>     libboost_regex.so.1.62.0 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libboost_regex.so.1.62.0 <span class="o">(</span>0x76e3c000<span class="o">)</span>
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-4"></a>     libboost_filesystem.so.1.62.0 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libboost_filesystem.so.1.62.0 <span class="o">(</span>0x76e1b000<span class="o">)</span>
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-5"></a>     ...
</pre>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-2/" class="u-url">Create a custom Raspbian image with pi-gen: part 2</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-2/" rel="bookmark">
            <time class="published dt-published" datetime="2018-07-24T18:25:26+02:00" itemprop="datePublished" title="2018-07-24 18:25">2018-07-24 18:25</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-2/#disqus_thread" data-disqus-identifier="cache/posts/create-a-custom-raspbian-image-with-pi-gen-part-2.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>In my <a class="reference external" href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/">previous post</a>, I discussed how to setup user accounts and
locales in a custom Raspbian image using pi-gen. In this follow-up
post, I will discuss the main problems that I want to solve:
automatically configuring the wireless network and ssh on a new
Raspberry Pi without a terminal attached directly to the Pi.</p>
<div class="section" id="set-up-the-wireless-network">
<h2>Set up the wireless network</h2>
<div class="section" id="the-wpa-supplicant">
<h3>The WPA supplicant</h3>
<p>The Pi's wireless credentials are configured in stage 2 in the file
<strong>stage2/02-net-tweaks/files/wpa_supplicant.conf</strong>. Here's how it
looks by default:</p>
<pre class="literal-block">
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
</pre>
<p>According to the blogs <a class="reference external" href="https://learnthinksolvecreate.wordpress.com/2017/07/25/pi-gen-setting-default-wifi-settings/">Learn Think Solve Create</a> and the <a class="reference external" href="https://www.raspberrypi-spy.co.uk/2017/04/manually-setting-up-pi-wifi-using-wpa_supplicant-conf/">Raspberry
Spy</a>, the first thing we should do is add our country code to the top
of this file with the line <cite>country=CH</cite>. (Use your own country code
for this.) Next, we want to enter the details for our wireless
network, which includes its name and the password. For security
reasons that I hope are obvious, we should not store the password in
this file. Instead, we create a hash of the password and put that
inside the file. The command to create the password hash is</p>
<pre class="code shell"><a name="rest_code_89a8d4ccb392450a8c4277b923f54354-1"></a>wpa_passphrase ESSID PASSWORD &gt; psk
</pre>
<p>where ESSID is our wireless network's name. Note that I also used a
space before the <code class="shell">wpa_passphrase</code> command to prevent the
password being written to my .bash_history file. Now, we copy and
paste the contents of the file <strong>psk</strong> into the wpa_supplicant.conf
and remove the comment that contains the actual password:</p>
<pre class="literal-block">
country=CH
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={
        ssid=YOUR_ESSID_HERE
        psk=YOUR_PSK_HASH_HERE
}
</pre>
</div>
<div class="section" id="configure-the-wireless-network-interfaces">
<h3>Configure the wireless network interfaces</h3>
<p>After having configured the supplicant, we next move on to configuring
the network interfaces used by Raspbian. The appropriate file is found
in <strong>stage1/02-net-tweaks/files/interfaces</strong>. In my post <a class="reference external" href="posts/connecting-a-raspberry-pi-to-a-home-linux-network/">Connecting a
Raspberry Pi to a Home Linux Network</a> I described how to set up the
network interfaces by editing <strong>/etc/network/interfaces</strong>. Much of the
information presented in that post has now been superseded in Raspbian
by the DHCP daemon. For now, we will use the interfaces file to
instruct our Pi to use DHCP and will use <strong>/etc/dhcpcd.conf</strong> at a
later time to set up a static IP address when provisioning the Pi.</p>
<p>We first need to make a few changes to make the interfaces file aware
of the credentials in the wpa supplicant configuration file. According
to the blog <a class="reference external" href="https://kerneldriver.wordpress.com/2012/10/21/configuring-wpa2-using-wpa_supplicant-on-the-raspberry-pi/">kerneldriver</a>, we need modify the
/etc/networe/interfaces file as such:</p>
<pre class="literal-block">
auto lo

iface lo inet loopback
iface eth0 inet dhcp

auto wlan0
iface wlan0 inet manual
     wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
iface default inet dhcp
</pre>
<p>In the first modification, I specify that I want the wirless interface
<strong>wlan0</strong> started automatically with <cite>auto wlan0</cite>. Next, I specify
that the wlan0 interface should use the <a class="reference external" href="https://manpages.debian.org/stretch/ifupdown/interfaces.5.en.html#The_manual_Method">manual inet address family</a>
with the line <cite>iface wlan0 inet manual</cite>.</p>
<p>According to the man pages, "[the manual] method may be used to define
interfaces for which no configuration is done by default." After this
we use the <cite>wpa-roam</cite> command to specify the location of the
wpa_supplicant.conf file that we previously modified. The wireless
ESSID and password are therefore not defined in interfaces, but rather
reference them inside wpa_supplicant.conf.</p>
<p>In case you noticed that wpa-roam doesn't appear as an option in
documentation on the interfaces file and were wondering why, it's
because other programs like wpasupplicant may provide additional
options to the interfaces file. A similar command is <cite>wpa-conf</cite>, but I
do not quite yet understand the difference between these two commands.</p>
<p>Following the wpa-roam command, we configure the default options for
all networks in our wpa_supplicant.conf file with the line <cite>iface
default inet dhcp</cite>. At this point, we save the setup of the static IP
address for a later time.</p>
<p>For more information, see <a class="reference external" href="https://manpages.debian.org/stretch/ifupdown/interfaces.5.en.html">the interfaces man page for Debian
Stretch</a>.</p>
</div>
<div class="section" id="change-the-hostname">
<h3>Change the hostname</h3>
<p>Our Pi's hostname may be changed from the default (raspberrypi) by
modifying the line in <strong>stage1/02-net-tweaks/files/hostname</strong>. See
<a class="reference external" href="https://tools.ietf.org/html/rfc1178">RFC 1178</a> for tips on choosing a hostname.</p>
<p>In addition to modifying the hostname file, we need to update
<strong>stage1/02-net-tweaks/00-patches/01-hosts.diff</strong> and change
raspberrypi to the new hostname:</p>
<pre class="literal-block">
Index: jessie-stage1/rootfs/etc/hosts
===================================================================
--- jessie-stage1.orig/rootfs/etc/hosts
+++ jessie-stage1/rootfs/etc/hosts
@@ -3,3 +3,4 @@
 ff02::1                ip6-allnodes
 ff02::2                ip6-allrouters

+127.0.1.1      NEW_HOSTNAME_HERE
</pre>
</div>
<div class="section" id="set-the-dns-servers">
<h3>Set the DNS servers</h3>
<p>DNS servers are configured in
<strong>export-image/02-network/files/resolv.conf</strong>. By default, mine was
already configured to use one of Google's DNS servers (8.8.8.8). I
added a secondary Google DNS address as well:</p>
<pre class="literal-block">
nameserver 8.8.8.8
nameserver 8.8.4.4
</pre>
</div>
</div>
<div class="section" id="enable-ssh">
<h2>Enable SSH</h2>
<p>Enabling SSH is simple. Open <strong>stage2/01-sys-tweaks/01-run.sh</strong> and
change the line <code class="shell">systemctl disable ssh</code> to <code class="shell">systemctl
<span class="nb">enable</span> ssh</code>.</p>
<p>(I later learned that we can also enable ssh on a headless pi by
adding an empty file named <strong>ssh</strong> to the boot partition of a standard
Raspbian image. See here for more details:
<a class="reference external" href="https://www.raspberrypi.org/documentation/remote-access/ssh/">https://www.raspberrypi.org/documentation/remote-access/ssh/</a>)</p>
<div class="section" id="configuring-ssh-keys-or-not">
<h3>Configuring SSH keys (or not)</h3>
<p>I decided after writing much of this tutorial that pi-gen was not
necessarily the best tool for adding my public SSH keys. So long as I
have network access and SSH enabled, I can easily add my keys using
<code class="shell">ssh-copy-id</code>. Furthermore, after following this tutorial,
there still remains a lot of setup and customization steps. These can
more easily be performed manually or by server automation tools like
<a class="reference external" href="http://www.fabfile.org/">Fabric</a> or <a class="reference external" href="https://www.ansible.com/">Ansible</a>.</p>
<p>Therefore, I think that at this point we can stop with our
customization of the image with pi-gen and move to a different
tool. We have a basic Raspbian image that is already configured for
our home network and that serves as a starting point for more complete
customization.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>This tutorial and my <a class="reference external" href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/">previous post</a> demonstrated how to create a
custom Raspbian image that is pre-configured for</p>
<ul class="simple">
<li>our home wireless network</li>
<li>our locale information</li>
<li>ssh</li>
</ul>
<p>Of course, we can do much, much more with pi-gen, but other tools
exist for the purpose of configuring a server. These tutorials at
least allow you to setup a new Raspberry Pi without having to manually
configure its most basic functionality. Happy Pi'ing!</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/" class="u-url">Create a custom Raspbian image with pi-gen: part 1</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/" rel="bookmark">
            <time class="published dt-published" datetime="2018-07-21T12:31:28+02:00" itemprop="datePublished" title="2018-07-21 12:31">2018-07-21 12:31</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/#disqus_thread" data-disqus-identifier="cache/posts/create-a-custom-raspbian-image-with-pi-gen-part-1.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Docker has been an amazing tool for improving my development
efficiency on the Raspberry Pi. For example, I recently used it to
<a class="reference external" href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/">cross-compile a large C++ and Python library</a> for the Pi's ARM
architecture on my x86_64 laptop. However, in that post I took it for
granted that I had already set up my Raspberry Pi with user accounts,
packages, ssh keys, etc. Performing these steps manually on a fresh
install of the Pi's <a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> operating system can become tedious,
especially because ssh needs to be manually enabled before doing any
remote work.</p>
<p>Fortunately, the Raspberry Pi developers have provided us with
<a class="reference external" href="https://github.com/RPi-Distro/pi-gen">pi-gen</a>, a useful collection of Shell scripts and a Docker container
for creating custom Raspbian images. In this post, I will summarize
the steps that I take in using pi-gen to create my own, personalized
Raspbian image.</p>
<p><em>After I wrote this post, I found a set of posts at</em> <a class="reference external" href="https://learnthinksolvecreate.wordpress.com/category/raspberry-pi/pi-gen/">Learn Think
Solve Create</a> <em>that describe many of the tasks I explain here. Be
sure to check them out for another take on modifying Raspbian images.</em></p>
<div class="section" id="clone-the-pi-gen-repository">
<h2>Clone the pi-gen repository</h2>
<p>This is as easy as cloning the git repository.</p>
<pre class="code shell"><a name="rest_code_db419c32ee174b79bcf51fa6499e641c-1"></a>git clone git@github.com:RPi-Distro/pi-gen.git
</pre>
<p>Alternatively, you can use the https address instead of ssh, which is
<a class="reference external" href="https://github.com/RPi-Distro/pi-gen.git">https://github.com/RPi-Distro/pi-gen.git</a>.</p>
<p>From now on, all directories in this post will be relative to the root
pi-gen directory.</p>
</div>
<div class="section" id="build-the-official-raspbian-images">
<h2>Build the official Raspbian images</h2>
<p>By default, the pi-gen repository will build the official Raspbian
images. Doing this once before making any modifications is probably a
good idea; if you can't build the official images, how will you be
able to build a custom image?</p>
<p>There are two main scripts that you can use to do this: <strong>build.sh</strong>
and <strong>build-docker.sh</strong>. build.sh requires you to install the packages
that are listed in the repository's README.md file, whereas
build-docker.sh requires only that you have Docker already installed
on your computer. I'm going to be using the Docker-based build script
for the rest of this post. If you don't have Docker installed on your
system, you can <a class="reference external" href="https://docs.docker.com/install/">follow the instructions here</a> for the community
edition.</p>
<div class="section" id="name-your-image">
<h3>Name your image</h3>
<p>First we need to give a name to our image, even if we use the default
build. To do this, we assign a name to a variable called <strong>IMG_NAME</strong>
inside a file called <strong>config</strong> that is located inside the root pi-gen
folder.</p>
<pre class="code shell"><a name="rest_code_cac3bac8a65b4d589474934b67cbd8d0-1"></a><span class="nb">echo</span> <span class="s2">"IMG_NAME=my_name"</span> &gt; config
</pre>
</div>
<div class="section" id="build-the-default-image">
<h3>Build the default image</h3>
<p>Once we've named our image, we can go ahead and run the build script.</p>
<pre class="code shell"><a name="rest_code_44c57045177a40a0bc8a08b56f00bd61-1"></a>./build-docker.sh
</pre>
<p>Be prepared to wait a while when running this script; the full build
took well over half an hour on my laptop and with the Docker volume
located on a SSD. It also consumed several GB of space on the SSD.</p>
<div class="section" id="resuming-a-failed-build">
<h4>Resuming a failed build</h4>
<p>The first time I used pi-gen the build failed twice. Once, it hung
without doing anything for several minutes, so I canceled it with a
<strong>Ctrl-C</strong> command. The other time I encountered a hash error when
installing a Debian package.</p>
<p>We can resume a failed build from the point of failure by assigning
the value 1 to the CONTINUE variable when calling build-docker.sh
again.</p>
<pre class="code shell"><a name="rest_code_fd6fe9df7b224f48b1736e341ae377dc-1"></a><span class="nv">CONTINUE</span><span class="o">=</span><span class="m">1</span> ./build-docker.sh
</pre>
<p>If we don't want to run previously built stages, we can simply place a
file inside the corresponding folder named SKIP. For example, if our
build fails at stage2, we can place SKIP files inside the stage0 and
stage1 folders, then rerun the build-docker.sh script with
CONTINUE=1.</p>
<p>Unfortunately, I have sometimes noticed that I have to also rebuild
the stage <em>prior</em> to the one where the build failed. In the worst
case, I had to rebuild all the stages because the fixes I applied to a
file in stage2 were not accounted for when I tried to skip building
stages 0 and 1. YMMV with this; I have no idea how well the SKIP
mechanism works for the normal build.sh script.</p>
<p>After a successful build, we can find our custom images located inside
the <strong>deploy</strong> folder of the pi-gen directory. These may then be
written onto a SD card and used as a standard Raspbian image.</p>
<p>We can ensure that the build container is preserved even after successful
builds using</p>
<pre class="code shell"><a name="rest_code_e379a9311cf54c33806ff733d2694d97-1"></a><span class="nv">PRESERVE_CONTAINER</span><span class="o">=</span><span class="m">1</span> ./build-docker.sh
</pre>
</div>
</div>
</div>
<div class="section" id="custom-raspbian-images">
<h2>Custom Raspbian images</h2>
<p>Now that we've got the default build working, let's start by
customizing the build process. For this post, I have the following
goals:</p>
<ul class="simple">
<li>Build only the <em>lite</em> version of the Raspbian images</li>
<li>Add a custom user account and delete the default <em>pi</em> account</li>
<li>Set the Pi's locale information</li>
</ul>
<p>In a follow-up post, I will discuss the following:</p>
<ul class="simple">
<li>Setup the WiFi for a home network</li>
<li>Setup ssh so that we can log on to the Pi remotely on its first
startup</li>
</ul>
<div class="section" id="building-just-raspbian-lite">
<h3>Building just Raspbian Lite</h3>
<p>Raspbian Lite is a <a class="reference external" href="https://raspberrypi.stackexchange.com/questions/39932/differences-between-raspbian-jessie-and-raspbian-jessie-lite#39933">minimal Raspbian image</a> without the X windows
server and speciality modules that would otherwise make Raspbian more
user friendly. It's an ideal starting point for projects that are
highly specialized, require only a few packages, and do not require a
GUI.</p>
<p>pi-gen creates Raspbian images in sequential steps called stages. At
the time of this writing, there were five stages, with stages 2, 4,
and 5 producing images of the operating system. Building everything
from stage 0 up to and including stage 2 produces a Raspbian Lite
image. We can speed up the build process and save harddrive space by
disabling all the later stages.</p>
<p>To disable the build for a particular a stage, we add an empty file
called <strong>SKIP</strong> inside the corresponding stage folder of the pi-gen
root directory, just as we did above when skipping previously built
stages. We also disable the explicit creation of images by adding an
empty file called <strong>SKIP_IMAGES</strong> to stages 4 and 5. (We don't need to
add a SKIP_IMAGES file to the stage3 folder because no image is
produced at this stage.)</p>
<pre class="code shell"><a name="rest_code_990994ad730949059c3ae65fd240c93d-1"></a>touch ./stage3/SKIP ./stage4/SKIP ./stage5/SKIP
<a name="rest_code_990994ad730949059c3ae65fd240c93d-2"></a>touch ./stage4/SKIP_IMAGES ./stage5/SKIP_IMAGES
</pre>
<p>Now, when we run build-docker.sh, pi-gen will only build and produce
one image for Raspbian Lite in the deploy directory.</p>
</div>
<div class="section" id="add-a-custom-user-account">
<h3>Add a custom user account</h3>
<p>The default user in Raspbian is called <strong>pi</strong>. This account is created
in stage1 in the the script <strong>stage1/01-sys-tweaks/00-run.sh</strong>. This
account is not very secure because it and its password, <em>raspberry</em>,
are the well-known defaults in Raspbian. Let's go ahead and change
them.</p>
<p>The relevant lines in the script look like this:</p>
<pre class="code shell"><a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-1"></a>on_chroot <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-2"></a><span class="s">if ! id -u pi &gt;/dev/null 2&gt;&amp;1; then</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-3"></a><span class="s">     adduser --disabled-password --gecos "" pi</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-4"></a><span class="s">fi</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-5"></a><span class="s">echo "pi:raspberry" | chpasswd</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-6"></a><span class="s">echo "root:root" | chpasswd</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-7"></a><span class="s">EOF</span>
</pre>
<p>The user pi is created with the line
<code class="shell">adduser --disabled-password --gecos <span class="s2">""</span> pi</code> if it doesn't
already exist. According to the <a class="reference external" href="http://manpages.ubuntu.com/manpages/trusty/man8/adduser.8.html">adduser man pages</a>
The --disabled-password flag prevents the program passwd from setting
the account's password when adduser is run, but remote logins without
password authentication to the pi account are still allowed. the
<code class="shell">--gecos <span class="s2">""</span></code> flag simply adds an empty string to the
/etc/passwd file for the pi account.</p>
<p>After the user is created, <em>raspberry</em> is set as pi's password and
<em>root</em> is set as the root password in the lines <code class="shell"><span class="nb">echo</span>
<span class="s2">"pi:raspberry"</span> <span class="p">|</span> chpasswd</code> and <code class="shell"><span class="nb">echo</span> <span class="s2">"root:root"</span> <span class="p">|</span> chpasswd</code>.</p>
<p>Let's start by modifying the pi account. For the sake of this example,
let's change its name to alphapi. For the password, we will generate a
<strong>temporary, random</strong> password and write it to a file in the deploy
directory. We'll do the same for root. The modifications look like the
following:</p>
<pre class="code shell"><a name="rest_code_fbc787ef08fb44148b681cb15056f252-1"></a><span class="nv">user_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-2"></a><span class="nv">root_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-3"></a>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-4"></a><span class="c1"># Write passwords to a file.</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-5"></a>cat <span class="s">&lt;&lt;EOF &gt; /pi-gen/deploy/users</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-6"></a><span class="s">${user_passwd}</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-7"></a><span class="s">${root_passwd}</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-8"></a><span class="s">EOF</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-9"></a>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-10"></a>on_chroot <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-11"></a><span class="s">if ! id -u alphapi &gt;/dev/null 2&gt;&amp;1; then</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-12"></a><span class="s">     adduser --disabled-password --gecos "" alphapi</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-13"></a><span class="s">fi</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-14"></a><span class="s">echo "alphapi:${user_passwd}" | chpasswd</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-15"></a><span class="s">echo "root:${root_passwd}" | chpasswd</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-16"></a><span class="s">EOF</span>
</pre>
<p>The first two lines create random alphanumeric passwords for the users
alphapi and root. They should be changed immediately when the image is
first run.</p>
<pre class="code shell"><a name="rest_code_4e749f4c258b4dc5afda8e0a906eb803-1"></a><span class="nv">user_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
<a name="rest_code_4e749f4c258b4dc5afda8e0a906eb803-2"></a><span class="nv">root_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
</pre>
<p>This way of password generation works by reading random bytes from
/dev/urandom and redirecting them to the standard input of the tr
command, which filters the input so only alphanumeric characters
remain. Next, the output is piped to the head command, which outputs
only the first eight alphanumeric characters produced in this fashion.</p>
<p>The passwords are then written to a file named <strong>users</strong> inside the
deploy directory where the outputs will eventually be placed.</p>
<pre class="code shell"><a name="rest_code_bba80531265646e4bda4259e7755a514-1"></a><span class="c1"># Write passwords to a file.</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-2"></a>cat <span class="s">&lt;&lt;EOF &gt; /pi-gen/deploy/users</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-3"></a><span class="s">${user_passwd}</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-4"></a><span class="s">${root_passwd}</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-5"></a><span class="s">EOF</span>
</pre>
<p>The remaining parts of the script are more-or-less the same as before,
except I changed pi to alphapi and used variable substitution for the
passwords.</p>
<p>Running ./build-docker.sh at this point will raise an error in stage02
because it's at this stage where the user pi is added to the various
groups on the system. We therefore need to open
<strong>stage2/01-sys-tweaks/01-run.sh</strong> and modify the following lines,
replacing pi with alphapi.</p>
<pre class="code shell"><a name="rest_code_7d3b5f0a9ce949949be9de68b5a6e323-1"></a><span class="k">for</span> GRP in adm dialout cdrom audio users sudo video games plugdev input gpio spi i2c netdev<span class="p">;</span> <span class="k">do</span>
<a name="rest_code_7d3b5f0a9ce949949be9de68b5a6e323-2"></a>    adduser alphapi <span class="nv">$GRP</span>
<a name="rest_code_7d3b5f0a9ce949949be9de68b5a6e323-3"></a><span class="k">done</span>
</pre>
</div>
<div class="section" id="set-the-locale-information">
<h3>Set the locale information</h3>
<p>The locale information used by your operating system may be modified
as follows. Open <strong>stage0/01-locale/00-debconf</strong>. I personally changed
every occurence of en_GB.UTF-8 to en_US.UTF-8, but you can set your
locale accordingly.</p>
<pre class="code shell"><a name="rest_code_be5df10afbc9427ca4da70e476c69892-1"></a><span class="c1"># Locales to be generated:</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-2"></a><span class="c1"># Choices: All locales, aa_DJ ISO-8859-1, aa_DJ.UTF-8 UTF-8, ...</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-3"></a>locales locales/locales_to_be_generated multiselect en_US.UTF-8 UTF-8
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-4"></a><span class="c1"># Default locale for the system environment:</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-5"></a><span class="c1"># Choices: None, C.UTF-8, en_US.UTF-8</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-6"></a>locales locales/default_environment_locale   <span class="k">select</span>  en_US.UTF-8
</pre>
<p>Next, we open <strong>stage2/01-sys-tweaks/00-debconf</strong>. I currently live in
Europe, so I made the following changes:</p>
<pre class="literal-block">
tzdata        tzdata/Areas    select  Europe
</pre>
<p>I also made the following changes to switch from the default British
English to American English:</p>
<pre class="code shell"><a name="rest_code_c015bf5c41cb4d11808ed86bad8bfee5-1"></a>keyboard-configuration keyboard-configuration/xkb-keymap <span class="k">select</span> us
<a name="rest_code_c015bf5c41cb4d11808ed86bad8bfee5-2"></a>keyboard-configuration keyboard-configuration/fvariant  <span class="k">select</span>  English <span class="o">(</span>US<span class="o">)</span> - English <span class="o">(</span>US<span class="se">\,</span> international with dead keys<span class="o">)</span>
</pre>
<p>Note that the comment in 00-debconf above the
keyboard-configuration/xkb-keymap line erroneously states that
American English is an option, but it's not. You need to change it
from "gb" to "us" if you want the American layout.</p>
</div>
</div>
<div class="section" id="using-the-custom-image">
<h2>Using the custom image</h2>
<p>With all these changes, we can build our new image by running
<code class="shell">./build-docker.sh</code> and, if successful, find a .zip file inside
the deploy directory with the image name and date.</p>
<p>To use this image, we unzip the file to extract the .img file inside
it. Next, we need to copy it onto a SD card that will plug into the
pi. I have a SD card reader/writer on my laptop for which I check for
its Linux device name by running <code class="shell">lsblk</code> before and after
plugging in the card. (The device that appears in the output of lsblk
after plugging it in is its name, which is <strong>/dev/mmcblk0</strong> on my
laptop). Once I get its device name, I use the Linux <code class="shell">dd</code>
command to copy the contents of the image onto the card. (Be sure to
change /dev/mccblk0 to match the name that your system gives to your
SD card device.)</p>
<pre class="code shell"><a name="rest_code_f7693cac2fa34488bc491db627f3c064-1"></a>sudo dd <span class="k">if</span><span class="o">=</span><span class="m">2018</span>-07-21-my_name-lite.img <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0 <span class="nv">bs</span><span class="o">=</span><span class="m">4096</span><span class="p">;</span> sync
</pre>
<p><strong>Please be EXTREMELY careful that you get the device name right.</strong>
It's not very difficult to write the contents of the image file over
your root partition or other important data.</p>
<p>After writing the image, we can plug the SD card into our pi, boot it
up, and try logging in as alphapi with the random password that was
created in the users file. <strong>Be sure at this point to change your
user's and root's password</strong>. We can also verify that the keyboard was
set to US English by typing Shift-3 and observing whether we get a
hashtag (#) symbol and not the symbol for the British pound currency.</p>
<p>In a follow-up post, I will describe how to setup the network and SSH
so I can continue to setup my Raspberry Pi without ever needing a
terminal.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/" class="u-url">How I built a cross-compilation workflow for the Raspberry Pi</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-29T12:10:26+02:00" itemprop="datePublished" title="2018-04-29 12:10">2018-04-29 12:10</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/#disqus_thread" data-disqus-identifier="cache/posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Some of you may know I tinker with the Raspberry Pi in my free time
and that one of my current projects is to build a lensless microscope
with the Pi as the brains. To control the microscope, I decided a
while ago that I would use <a class="reference external" href="https://micro-manager.org/wiki/Micro-Manager">Micro-Manager</a>, an open-source
software package for microscope control. I made this decision for a
few reasons:</p>
<ol class="arabic simple">
<li>I already knew the Micro-Manager codebase since I use it frequently
at work.</li>
<li>The Micro-Manager core provides a device-independent interface to
hardware.</li>
<li>I've contributed to the project in the past and feel a sense of
loyalty to the project and the people involved. Expanding
Micro-Manager into embedded microscopy would be a great way for me
to give back to the community.</li>
</ol>
<p>Building Micro-Manager from source code presents its own set of
challenges. After ensuring that you have the correct build
environment, you need to actually compile it, and here's where things
get tricky in Raspyberry Pi development. The Pi has an ARM processor,
whereas most laptops and workstations use a x86_64 processor. This
means that code compiled on a typical desktop PC will not work on the
Pi. As I showed in <a class="reference external" href="https://kmdouglass.github.io/posts/micro-manager-on-the-raspberry-pi.html">my earlier post</a>,
you can compile the code directly on the Pi to circumvent this, but
this unfortunately is quite cumbersome because the code base and
dependencies are quite large. (They are nearly 8 GB in
total). Furthermore, compiling the project on the Pi is slow and
requires connecting to it via ssh or working directly on a TV screen
or monitor.</p>
<p>These problems extend beyond Micro-Manager to other large-scale
projects that require code compilation for a specific processor
architecture. In this post, I'll describe the workflow that I
developed for cross-compiling projects for the Raspberry Pi.</p>
<div class="section" id="previous-attempts">
<h2>Previous attempts</h2>
<p>Prior to the workflow that is the main topic of this post, I managed
to cross-compile Micro-Manager using a <cite>chroot</cite> environment and the
<a class="reference external" href="https://www.qemu.org/">QEMU emulator</a>. <a class="reference external" href="https://en.wikipedia.org/wiki/Chroot">chroot</a> is a Linux command that
changes the apparent root (or '/') directory for a running
process. With this approach, I mount an image of the <a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian
operating system</a>
that contains the gcc and g++ compilers and libraries for the ARM
architecture. Then, I chroot into the image and run a setup script
that builds the software. During execution of this script, the QEMU
static libraries run the ARM compilers from within the chroot
environment to build the project. The compiled code remains inside the
image, which I then burn onto a micro SD card to insert into the Pi. I
uploaded <a class="reference external" href="https://gist.github.com/kmdouglass/38e1383c7e62745f3cf522702c21cb49">a gist of the bash script</a>
which orchestrates all this, and my inspiration for this approach came
from a great series of blog posts from <a class="reference external" href="https://disconnected.systems/blog/custom-rpi-image-with-github-travis/">Disconnected Systems</a>.</p>
<p>Ultimately this approach is a huge amount of work. As you can see in
the gist, it's fairly complicated bash scripting that's not easy to
debug. Furthermore, the setup script that is run inside the image
needs to do a lot of work beyond cross-compiling, like setting up the
user, permissions, network, etc. Debugging the final product is also a
challenge because you need to verify that it's working on the Pi,
which requires burning the image to a micro SD card.</p>
</div>
<div class="section" id="cross-compiling-with-docker">
<h2>Cross-compiling with Docker</h2>
<p>After a bit of research I decided I would try instead to use <a class="reference external" href="https://www.docker.com/">Docker</a> for cross-compilation and deployment to
the Pi. I had just started using Docker at work to build reproducible
environments for scientific computing research. In particular, and
unlike my chroot script, I had learned that a Docker container that
built the project could work on nearly any system that had Docker
installed. Furthermore, deploying updates can be done on any Raspberry
Pi that's running Docker.</p>
<p>I liked the idea of a portable cross-compilation workflow, so I dove
into the Docker documentation and managed to get everything working in
a few weeks of tinkering at home.</p>
<div class="section" id="an-overview-of-docker">
<h3>An overview of Docker</h3>
<p>You can find many resources online about Docker, so I won't go into
the details here. The main thing you need to know is that Docker is a
system for creating, running, and sharing <em>containers</em>, which are
something like light weight virtual machines. Containers solve the
problem in software development of how to build and deploy programs
that have a complex set of dependencies. It does this by isolating the
environment in which a program runs from the rest of the operating
system. For example, if you have a computer that has a certain version
of gcc (the GNU C compiler) installed, but your application requires a
different version, then you can install the required gcc along with
your application inside a container and they will not interfere with
the version of gcc that belongs to your operating system. This also
means that you can send your container to any machine that has Docker
installed and it should just run without having to do any setup.</p>
<p>Other important things to know about Docker are:</p>
<ul class="simple">
<li>There are two main types of objects: images and containers. Images
are sort of like blueprints that define what is inside a container,
whereas containers are like the actual buildings specified by the
blueprints. There can be many containers that come from a single
image.</li>
<li>Containers are meant to be immutable. When you stop them and restart
them, they always restart in the same state as when they were first
created.</li>
<li>Since containers are immutable, some of your application data may
need to be placed in a volume, which is either another container or
a folder on the host system. A volume gets connected to your
application container and exists even when your application
container is not running.</li>
</ul>
</div>
</div>
<div class="section" id="the-cross-compilation-workflow">
<h2>The cross-compilation workflow</h2>
<p>Now that we have established the essential background to this project,
let's look at the cross-compilation workflow. Below is a picture that
provides a sense of the entire process, moving in general from
left-to-right.</p>
<img alt="The cross-compilation workflow" class="align-center" src="images/mm_docker_workflow.png"><p>The process involves two Docker containers: one for building
Micro-Manager and the other for running the application. The build
dependencies and the QEMU emulator are both located inside the build
container, having been specified when its image was created. These
allow us to compile Micro-Manager for the ARM architecture.  The
source code is connected to the build container as a <em>bind mount</em>,
which is a folder from the host workstation that is mounted inside the
build container when it is run.</p>
<p>Once the libraries are compiled, they are installed into a folder
inside the bind mount so that the host system will have access to them
after the build container closes. Next, the compiled libraries are
copied directly into an image that defines the application
container. This image defines only the essential run-time requirements
for running Micro-Manager and nothing else. The application image is
stored on the registry server which I set up on my local network. This
makes it easy for the Raspberry Pi to download the latest image and
run the Micro-Manager application container whenever I make changes.</p>
<p>An important aspect of this workflow is how the data is passed between
the systems and containers. Unlike what you will find in many
introductory tutorials on Docker, I do not add the Micro-Manager
source code directly to the build image/containers but instead use a
bind mount. The reason for this is that the source code and 3rd party
libraries are quite large, about 8 GB in total. By using a bind mount,
I avoid needless copying of this data. Another reason for using a bind
mount is that the source code will change frequently during
development. If I add the source code to the image, then I will have
to recreate the image every time the source code changes.</p>
<p>Once the libraries are built, I directly copy them into the
application image because they are much, much smaller than the source
code. I also want the code stored directly in the image so that the
application image is all the Raspberry Pi needs to run the
program. The image is stored in my local <a class="reference external" href="https://docs.docker.com/registry/">Docker registry</a> server so that once I push an
updated image to the server, the Raspberry Pi can download it and use
it immediately.</p>
<div class="section" id="step-0-prerequisites">
<h3>Step 0: Prerequisites</h3>
<p>I am going to assume that you already have installed Docker. (If not,
follow <a class="reference external" href="https://docs.docker.com/install/">these directions</a>.) I am
also going to assume that you are somewhat familiar with how to work
on a Linux system. The Raspberry Pi runs Linux, so you probably
wouldn't be here if you didn't already know at least a little.</p>
<p>For this article, I am working with these versions of Docker and
Ubuntu on my host workstation.:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~$ uname -a
Linux xxxxx 4.13.0-39-generic #44~16.04.1-Ubuntu SMP Thu Apr 5 16:43:10 UTC 2018 x86_64 x86_64
x86_64 GNU/Linux

kmdouglass@xxxxx:~$ docker version
Client:
 Version:      18.03.1-ce
 API version:  1.37
 Go version:   go1.9.5
 Git commit:   9ee9f40
 Built:        Thu Apr 26 07:17:20 2018
 OS/Arch:      linux/amd64
 Experimental: false
 Orchestrator: swarm

Server:
 Engine:
  Version:      18.03.1-ce
  API version:  1.37 (minimum version 1.12)
  Go version:   go1.9.5
  Git commit:   9ee9f40
  Built:        Thu Apr 26 07:15:30 2018
  OS/Arch:      linux/amd64
  Experimental: false
</pre>
<p>Finally, below is how my project directory structure is laid out.:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~/src/alphapi/docker$ tree -L 2
.
└── rpi-micromanager
    ├── 2.0-python
    │   ├── build
    │   └── Dockerfile
    └── build
        ├── build
        ├── Dockerfile
        ├── run
        └── setup
</pre>
<p>I have two folders; build, which contains the files for the build
container, and 2.0-python, which contains the files for creating the
Micro-Manager application container. (In my case, I am going to build
the Python wrapper for Micro-Manager 2.0.) Inside each folder are the
scripts and Dockerfiles that execute the various steps of the
workflow.</p>
<p>The final prerequisite is to register QEMU with the Docker build
agent. First, install a few packages for QEMU. On Ubuntu, this looks
like</p>
<pre class="code shell"><a name="rest_code_deacfa1a9a25439a970acfc38f97963f-1"></a>$ sudo apt update
<a name="rest_code_deacfa1a9a25439a970acfc38f97963f-2"></a>$ sudo install qemu qemu-user-static qemu-user binfmt-support
</pre>
<p>Finally, register the build agent with the command:</p>
<pre class="code shell"><a name="rest_code_e8b8d4d4c8e540d59c38b8017332baba-1"></a>$ docker run --rm --privileged multiarch/qemu-user-static:register --reset
</pre>
</div>
<div class="section" id="step-1-create-the-build-image">
<h3>Step 1: Create the build image</h3>
<p>Inside the build folder, I have a file called Dockerfile. Here are its
contents.</p>
<pre class="code shell"><a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-1"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-2"></a><span class="c1">#</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-3"></a><span class="c1"># Defines a build environment for Micro-Manager on the Raspberry Pi.</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-4"></a><span class="c1">#</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-5"></a><span class="c1"># Usage: docker build \</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-6"></a><span class="c1">#          -t NAME:TAG \</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-7"></a><span class="c1">#         .</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-8"></a><span class="c1">#</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-9"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-10"></a>FROM resin/raspberrypi3-debian:stretch
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-11"></a>MAINTAINER Kyle M. Douglass &lt;kyle.m.douglass@gmail.com&gt;
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-12"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-13"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-start"</span> <span class="o">]</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-14"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-15"></a><span class="c1"># Get the build dependencies.</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-16"></a>RUN apt-get update <span class="o">&amp;&amp;</span> apt-get -y install --no-install-recommends <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-17"></a>autoconf <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-18"></a>automake <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-19"></a>build-essential <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-20"></a>git <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-21"></a>libatlas-base-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-22"></a>libboost-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-23"></a>libboost-all-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-24"></a>libtool <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-25"></a>patch <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-26"></a>pkg-config <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-27"></a>python3-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-28"></a>python3-pip <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-29"></a>python3-setuptools <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-30"></a>python3-wheel <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-31"></a>swig <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-32"></a><span class="o">&amp;&amp;</span> apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-33"></a><span class="o">&amp;&amp;</span> pip3 install numpy
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-34"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-35"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-end"</span> <span class="o">]</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-36"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-37"></a><span class="c1"># Set up the mount point for the source files and setup script.</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-38"></a>ADD setup /micro-manager/
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-39"></a>VOLUME /micro-manager/src
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-40"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-41"></a>WORKDIR /micro-manager/src
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-42"></a>ENTRYPOINT <span class="o">[</span> <span class="s2">"/sbin/tini"</span>, <span class="s2">"-s"</span>, <span class="s2">"--"</span> <span class="o">]</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-43"></a>CMD <span class="o">[</span> <span class="s2">"/micro-manager/setup"</span> <span class="o">]</span>
</pre>
<p>A Dockerfile defines the steps in building an image -- in this case,
the build image. Let's break this file down into pieces. In the first
two lines that follow the comments, I specify that my image is based
on the resin/raspberrypi3-debian:stretch image and that I am the
maintainer.</p>
<pre class="code shell"><a name="rest_code_6f6100ac8b7b4501961496830d326e59-1"></a>FROM resin/raspberrypi3-debian:stretch
<a name="rest_code_6f6100ac8b7b4501961496830d326e59-2"></a>MAINTAINER Kyle M. Douglass &lt;kyle.m.douglass@gmail.com&gt;
</pre>
<p>Images from <a class="reference external" href="https://hub.docker.com/u/resin/">Resin</a> are freely
available and already have the QEMU emulator installed. Next, I
specify what commands should be run for the ARM architecture. Any
commands located between <tt class="docutils literal">RUN [ <span class="pre">"cross-build-start"</span> ]</tt> and <tt class="docutils literal">RUN [
<span class="pre">"cross-build-end"</span> ]</tt> will be run using the emulator. Inside these two
commands, I install the build dependencies for Micro-Manager using
<tt class="docutils literal"><span class="pre">apt-get</span></tt> and <tt class="docutils literal">pip</tt>. (These are just standard commands for
installing software on Debian/Ubuntu Linux machines and from PyPI,
respectively.)</p>
<p>After the installation of the requirements completes, I add the setup
script to the folder /micro-manager inside the image with the <tt class="docutils literal">ADD
setup <span class="pre">/micro-manager/</span></tt> command. The setup script contains the
commands that will actually compile Micro-Manager. I then define a
mount point for the source code with <tt class="docutils literal">VOLUME
<span class="pre">/micro-manager/src</span></tt>. <strong>It's important to realize here that you do not
mount volumes inside images, you mount volumes inside containers.</strong>
This command is just telling the image to expect a folder to be
mounted at this location when the container is run.</p>
<p>The last three lines set the working directory, the entrypoint and the
default container command, respectively.</p>
<pre class="code shell"><a name="rest_code_562074e3cfad486b82873bea18b77684-1"></a>WORKDIR /micro-manager/src
<a name="rest_code_562074e3cfad486b82873bea18b77684-2"></a>ENTRYPOINT <span class="o">[</span> <span class="s2">"/sbin/tini"</span>, <span class="s2">"-s"</span>, <span class="s2">"--"</span> <span class="o">]</span>
<a name="rest_code_562074e3cfad486b82873bea18b77684-3"></a>CMD <span class="o">[</span> <span class="s2">"/micro-manager/setup"</span> <span class="o">]</span>
</pre>
<p>This specific entrypoint tells Docker that any containers built from
this image should first run Tini, which is a lightweight init system
for Docker containers. If you do not specify Tini as the entry point,
then it will not be able to reap zombies. (I don't know what this
means exactly, but it sounds cool and you can read about it here:
<a class="reference external" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a>)</p>
<p>By default, the container will run the setup script, but, since I used
the <tt class="docutils literal">CMD</tt> directive, this can be overriden in case we need to
perform some manual steps. Roughly speaking, you can think of the
entrypoint as the command that can not be overridden and the CMD
command as the one that can be. In other words, Tini will always be
executed when containers created from this image are launched, whereas
you can choose not to run the setup script but instead to enter the
container through a Bash shell, for example.</p>
<p>To build the image, I use the following build script located in the
same directory as the Dockerfile for convenience.</p>
<pre class="code shell"><a name="rest_code_3ac75315a8d942d49bc70301c60b9981-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-2"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-3"></a><span class="c1">#</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-4"></a><span class="c1"># Usage: ./build</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-5"></a><span class="c1">#</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-6"></a>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-7"></a>docker build <span class="se">\</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-8"></a>       -t localhost:5000/rpi-micromanager:build <span class="se">\</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-9"></a>       .
</pre>
<p>By using <tt class="docutils literal"><span class="pre">-t</span> <span class="pre">localhost:5000/rpi-micromanager:build</span></tt> argument I am
giving the image a name of <em>rpi-micromanager</em>, a tag of <em>build</em>, and
specifying that I will eventually host this image on my local registry
server (localhost) on port 5000.</p>
<p>In case you are wondering about the contents of the setup script,
don't worry. I'll explain it in the next section.</p>
</div>
<div class="section" id="step-2-compile-micro-manager">
<h3>Step 2: Compile Micro-Manager</h3>
<p>After the image is built, I create a container and use it to compile
Micro-Manager. For this, I use the run script in the build directory.</p>
<pre class="code shell"><a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-2"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-3"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-4"></a><span class="c1"># Usage: ./run DIR CONFIGURE</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-5"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-6"></a><span class="c1"># DIR is the parent folder containing the micro-manager Git</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-7"></a><span class="c1"># repository, the 3rdpartypublic Subversion repository, and any</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-8"></a><span class="c1"># additional build resources.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-9"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-10"></a><span class="c1"># If CONFIGURE=true, the build system is remade and the configure</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-11"></a><span class="c1"># script is rerun before running 'make' and 'make install'. If</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-12"></a><span class="c1"># CONFIGURE=false, only 'make' and 'make install' are run.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-13"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-14"></a><span class="c1"># The compiled program files are stored in a bind mount volume so that</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-15"></a><span class="c1"># they may be copied into the deployment container.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-16"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-17"></a>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-18"></a><span class="nv">src_dir</span><span class="o">=</span><span class="nv">$1</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-19"></a><span class="nv">cmd</span><span class="o">=</span><span class="s2">"/micro-manager/setup </span><span class="nv">$2</span><span class="s2">"</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-20"></a>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-21"></a><span class="c1"># Remove the build artifacts from previous builds.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-22"></a><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-23"></a>    rm -rf <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>/build <span class="o">||</span> <span class="nb">true</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-24"></a><span class="k">fi</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-25"></a>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-26"></a>docker run --rm <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-27"></a>       -v <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>:/micro-manager/src <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-28"></a>       --name mm-build <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-29"></a>       localhost:5000/rpi-micromanager:build <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-30"></a>       <span class="si">${</span><span class="nv">cmd</span><span class="si">}</span>
</pre>
<p>The script takes two arguments. The first is the path to the folder
containing all the source code (see below for details). The second
argument is either <strong>true</strong> or <strong>false</strong>. (It can actually be
anything, but it will only compile Micro-Manager if either <strong>true</strong> or
<strong>false</strong> are provided.) If true, the full build process is run,
including setting up the configure script; if false, only make and
make install are run, which should recompile and install only recently
updated files.</p>
<p>The run script uses the -v argument to <tt class="docutils literal">docker run</tt> to mount the
source directory into the container at the point specified by the
<tt class="docutils literal">VOLUME</tt> command in the Dockerfile. The directory layout on my host
file system for the source directory looks like this:</p>
<pre class="literal-block">
kmdouglass@xxxxx:/media/kmdouglass/Data/micro-manager$ tree -L 1
.
├── 3rdpartypublic
├── micro-manager
└── patches
</pre>
<p>The patches folder is not necessary and only there to fix <a class="reference external" href="https://github.com/micro-manager/micro-manager/pull/613">a bug</a> in the
WieneckeSinscke device adapter. (This bug may be fixed by now.)
3rdpartypublic is the large Subversion repository of all the required
software to build Micro-Manager, and micro-manager is the <a class="reference external" href="https://github.com/micro-manager/micro-manager">cloned
GitHub repository</a>. Prior to building,
I checkout the mm2 branch because I am interested in developing my
application for Micro-Manager 2.0.</p>
<p>The setup script that is run inside the container and mentioned in the
previous section looks like this.</p>
<pre class="code shell"><a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-2"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-3"></a><span class="c1"># # Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-4"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-5"></a><span class="c1"># Builds Micro-Manager.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-6"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-7"></a><span class="c1"># Usage: ./setup CONFIGURE</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-8"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-9"></a><span class="c1"># If CONFIGURE=true, the build system is remade and the configure</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-10"></a><span class="c1"># script is rerun before running 'make' and 'make install'. If</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-11"></a><span class="c1"># CONFIGURE=false, only 'make' and 'make install' or run.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-12"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-13"></a><span class="c1"># Kyle M. Douglass, 2018</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-14"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-15"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-16"></a><span class="c1"># Move into the source directory.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-17"></a><span class="nb">cd</span> micro-manager
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-18"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-19"></a><span class="c1"># Undo any previous patches.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-20"></a>git checkout -- DeviceAdapters/WieneckeSinske/CAN29.cpp
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-21"></a>git checkout -- DeviceAdapters/WieneckeSinske/WieneckeSinske.cpp
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-22"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-23"></a><span class="c1"># Patch the broken WieneckeSinske device adapter.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-24"></a>patch DeviceAdapters/WieneckeSinske/CAN29.cpp &lt; ../patches/CAN29.cpp.diff <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-25"></a><span class="o">&amp;&amp;</span> patch DeviceAdapters/WieneckeSinske/WieneckeSinske.cpp &lt; ../patches/WieneckeSinske.cpp.diff
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-26"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-27"></a><span class="c1"># Compile MM2.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-28"></a><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-29"></a>    <span class="c1"># Remake the entire build system, then compile from scratch.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-30"></a>    ./autogen.sh
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-31"></a>    <span class="nv">PYTHON</span><span class="o">=</span><span class="s2">"/usr/bin/python3"</span> ./configure <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-32"></a>        --prefix<span class="o">=</span><span class="s2">"/micro-manager/src/build"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-33"></a>        --with-python<span class="o">=</span><span class="s2">"/usr/include/python3.5"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-34"></a>        --with-boost-libdir<span class="o">=</span><span class="s2">"/usr/lib/arm-linux-gnueabihf"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-35"></a>        --with-boost<span class="o">=</span><span class="s2">"/usr/include/boost"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-36"></a>        --disable-java-app <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-37"></a>        --disable-install-dependency-jars <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-38"></a>        --with-java<span class="o">=</span><span class="s2">"no"</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-39"></a>    make
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-40"></a>    make install
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-41"></a>    chmod -R a+w /micro-manager/src/build
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-42"></a><span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-43"></a>    <span class="c1"># Only recompile changed source files.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-44"></a>    make
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-45"></a>    make install
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-46"></a>    chmod -R a+w /micro-manager/src/build
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-47"></a><span class="k">else</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-48"></a>    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2"> : Unrecognized argument."</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-49"></a>    <span class="nb">echo</span> <span class="s2">"Pass \"true\" to run the full build process."</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-50"></a>    <span class="nb">echo</span> <span class="s2">"Pass \"false\" to run only \"make\" and \"make install\"."</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-51"></a><span class="k">fi</span>
</pre>
<p>Most important in this script is the call to <tt class="docutils literal">configure</tt>. You can
see that the compiled libraries and Python wrapper will be written to
the build folder inside the mounted directory. This gives the host
file system access to the compiled artifacts after the container has
stopped.</p>
</div>
<div class="section" id="step-3-build-the-application-image">
<h3>Step 3: Build the application image</h3>
<p>Once the libraries are compiled, we can add them to an application
image that contains only the essentials for running Micro-Manager.</p>
<p>For this, I use a separate Dockerfile inside the 2.0-python
directory.</p>
<pre class="code shell"><a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-1"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-2"></a><span class="c1">#</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-3"></a><span class="c1"># Builds the Micro-Manager 2.0 Python wrapper for the Raspberry Pi.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-4"></a><span class="c1">#</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-5"></a><span class="c1"># Usage: docker build \</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-6"></a><span class="c1">#          -t NAME:TAG \</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-7"></a><span class="c1">#          .</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-8"></a><span class="c1">#</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-9"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-10"></a>FROM resin/raspberrypi3-debian:stretch
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-11"></a>MAINTAINER Kyle M. Douglass &lt;kyle.m.douglass@gmail.com&gt;
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-12"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-13"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-start"</span> <span class="o">]</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-14"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-15"></a><span class="c1"># Install the run-time dependencies.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-16"></a>RUN apt-get update <span class="o">&amp;&amp;</span> apt-get -y install --no-install-recommends <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-17"></a>    libatlas-base-dev <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-18"></a>    libboost-all-dev <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-19"></a>    python3-pip <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-20"></a>    python3-setuptools <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-21"></a>    python3-wheel <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-22"></a>    <span class="o">&amp;&amp;</span> pip3 install numpy <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-23"></a>    <span class="o">&amp;&amp;</span> apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-24"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-25"></a><span class="c1"># Copy in the Micro-Manager source files.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-26"></a>RUN useradd -ms /bin/bash micro-manager
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-27"></a>WORKDIR /home/micro-manager/app
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-28"></a>COPY --chown<span class="o">=</span>micro-manager:micro-manager . .
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-29"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-30"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-end"</span> <span class="o">]</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-31"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-32"></a><span class="c1"># Final environment configuration.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-33"></a>USER micro-manager:micro-manager
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-34"></a>ENV PYTHONPATH /home/micro-manager/app/lib/micro-manager
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-35"></a>ENTRYPOINT <span class="o">[</span><span class="s2">"/sbin/tini"</span>, <span class="s2">"-s"</span>, <span class="s2">"--"</span><span class="o">]</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-36"></a>CMD <span class="o">[</span><span class="s2">"/usr/bin/python3"</span><span class="o">]</span>
</pre>
<p>As before, I use a clean resin base image. However, this time I only
install the essential software to run Micro-Manager.</p>
<p>After apt-getting and pip-installing everything, I create a new user
called <strong>micro-manager</strong> and a new folder called <strong>app</strong> inside this
user's home directory.</p>
<pre class="code shell"><a name="rest_code_429cf0806a154ad1830bf3a72e544697-1"></a><span class="c1"># Copy in the Micro-Manager source files.</span>
<a name="rest_code_429cf0806a154ad1830bf3a72e544697-2"></a>RUN useradd -ms /bin/bash micro-manager
<a name="rest_code_429cf0806a154ad1830bf3a72e544697-3"></a>WORKDIR /home/micro-manager/app
</pre>
<p>Next, I directly copy the compiled libraries into the image with the
COPY command.</p>
<pre class="code shell"><a name="rest_code_669f943f2dbd45fea1871087ea64446f-1"></a>COPY --chown<span class="o">=</span>micro-manager:micro-manager . .
</pre>
<p>The two periods (.) mean that I copy the current host directory's
contents into the container's current working directory
(/home/micro-manager/app). What is the current host directory? Well,
as I explain below, I actually run this Dockerfile from inside the
<strong>build</strong> folder that was created to hold the compiled libraries in
the previous step. But first, I'll end my explanation of the
Dockerfile by saying that I switch the USER so that I do not run the
container as root, add the library to the PYTHONPATH environment
variable, and setup the default command as the python3 interpreter.</p>
<p>To build this image, I use the following build script.</p>
<pre class="code shell"><a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-2"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-3"></a><span class="c1">#</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-4"></a><span class="c1"># Usage: ./build DIR</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-5"></a><span class="c1">#</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-6"></a><span class="c1"># DIR is the root directory containing the Micro-Manager build</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-7"></a><span class="c1"># artifacts. These artifacts will be added to the Docker image.</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-8"></a><span class="c1">#</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-9"></a>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-10"></a><span class="nv">src_dir</span><span class="o">=</span><span class="nv">$1</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-11"></a>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-12"></a>cp Dockerfile <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-13"></a><span class="nb">cd</span> <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-14"></a>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-15"></a>docker build <span class="se">\</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-16"></a>       -t localhost:5000/rpi-micromanager:2.0-python <span class="se">\</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-17"></a>       .
</pre>
<p>This script takes one argument, which is the <strong>build</strong> directory
containing the compiled source code. The script first copies the
Dockerfile into this directory and then changes into it with the cd
command. (This explains the two periods (.) in the COPY command in the
Dockerfile.)</p>
<p>Finally, I build the image and give it a name of
localhost:5000/rpi-micromanager:2.0-python.</p>
</div>
<div class="section" id="step-4-add-the-image-to-the-local-registry-server">
<h3>Step 4: Add the image to the local registry server</h3>
<p>Now we need a way to get the image from the workstation onto the
Raspberry Pi. Of course, I could manually transfer the file with a USB
stick or possibly use ssh, but what if I have multiple Pi's? This
process could become cumbersome. Docker provides a few ways to push
and pull images across a network. The most obvious is <a class="reference external" href="https://hub.docker.com/">Dockerhub</a>, a site for freely sharing images. For the
moment I don't want to use Dockerhub, though, because I have not yet
checked all the software licenses and am unsure as to what my rights
are for putting an image with Micro-Manager software on a public
repository.</p>
<p>A better option, especially for testing, is to use a local registry
server. This server operates only on my home network and already
allows my workstation and Pi's to communicate with one
another. Following the <a class="reference external" href="https://docs.docker.com/registry/deploying/">official registry documentation</a> and <a class="reference external" href="http://zacharykeeton.com/docker-private-registry/">this blog post by
Zachary Keeton</a>,
I managed to setup the registry as follows.</p>
<div class="section" id="host-setup">
<h4>Host setup</h4>
<p>First, we need to setup a transport layer security (TLS)
certificate. It's possible to run the server without one if you don't
expect your network to be attacked, but it's good practice so let's
create one.</p>
<p>To do this, I edit the /etc/ssl/openssl.cnf file and add the following
to the top of the [ v3_ca ] section.:</p>
<pre class="literal-block">
subjectAltName = IP:192.168.XXX.XXX
</pre>
<p>where the IP address is the address of the workstation on the
network. Next, I actually create the certificate. I make a directory
called certs inside my workstation home directory and then use openssl
to make the cerficate. During the prompts, I press ENTER at every step
except the FQDN (fully qualified domain name). For the FQDN, I enter
the same IP address as above.</p>
<pre class="code shell"><a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-1"></a>mkdir certs
<a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-2"></a>openssl req -newkey rsa:4096 -nodes -sha256 <span class="se">\</span>
<a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-3"></a>-keyout certs/domain.key -x509 -days <span class="m">365</span> <span class="se">\</span>
<a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-4"></a>-config /etc/ssl/openssl.cnf -out certs/domain.crt
</pre>
<p><strong>I had to add the ``-config /etc/ssl/openssl.cnf`` argument for the
subject alternative name to be added to the certificate.</strong> This part
was tricky, because if this argument is not included, then the key
generation step will use some other .cnf file (I am not sure
which). This results in the following SAN error when attemptingt to
connect to the registry.:</p>
<pre class="literal-block">
cannot validate certificate for 192.168.XXX.XXX because it doesn't contain any IP SANs
</pre>
<p>After the domain.key and domain.crt files have been created, I run the
official registry server container. (See how handy Docker containers
are? There's no messy installation beyond grabbing the container.)</p>
<pre class="code shell"><a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-1"></a>docker run -d -p <span class="m">5000</span>:5000 <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-2"></a>  --restart<span class="o">=</span>always <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-3"></a>  --name registry <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-4"></a>  -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/certs:/certs <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-5"></a>  -e <span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/domain.crt <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-6"></a>  -e <span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/domain.key <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-7"></a>  registry:2
</pre>
<p>If the registry:2 image is not already downloaded, then it will be
downloaded for automatically when running the container. Note that
the -p 5000:5000 argument indicates that the server is using port 5000
on both the host system and inside the container. Note also that the
certs directory is relative to the current directory because I use the
($pwd) command. You can change this to an absolute path if you wish on
your setup.</p>
<p>Let's go ahead and push the application image to the server now that
it's running.</p>
<pre class="code shell"><a name="rest_code_9f2efb97cc1f4405b31df75762cf0ccd-1"></a>docker push localhost:5000/rpi-micromanager:2.0-python
</pre>
</div>
<div class="section" id="setup-the-pi">
<h4>Setup the Pi</h4>
<p>Now, startup the Pi. I will assume that you have <a class="reference external" href="https://www.raspberrypi.org/blog/docker-comes-to-raspberry-pi/">already installed
Docker</a> on
it and know how to communicate with it via ssh and copy files to it
using scp.</p>
<p>I copy the certificate from the host with scp.</p>
<pre class="code shell"><a name="rest_code_01f2057272c64a55a7dc30a09662f278-1"></a>sudo mkdir -p /etc/docker/certs.d/192.168.XXX.XXX:5000/
<a name="rest_code_01f2057272c64a55a7dc30a09662f278-2"></a>sudo scp kmdouglass@192.168.XXX.XXX:/home/kmdouglass/certs/domain.crt /etc/docker/certs.d/192.168.XXX.XXX:5000/ca.crt
</pre>
<p>The IP address that I am using is the one to the machine where the
registry server is running. After this step, I make the operating
system trust the certificate.</p>
<pre class="code shell"><a name="rest_code_b992be5945ec448c99eb26412ad3fcd8-1"></a>sudo scp kmdouglass@192.168.XXX.XXX:/home/kmdouglass/certs/domain.crt /usr/local/share/ca-certificates/192.168.XXX.XXX.crt
<a name="rest_code_b992be5945ec448c99eb26412ad3fcd8-2"></a>sudo update-ca-certifications
</pre>
<p>Finally, I restart the Docker daemon.</p>
<pre class="code shell"><a name="rest_code_2ad10e9d31d944548082cd85d6f25f6d-1"></a>sudo service docker restart
</pre>
<p>If everything is working, then I should be able to pull the image from
your network's registry server.</p>
<pre class="code shell"><a name="rest_code_f9dbff5d6425426489523f7e12278aab-1"></a>docker pull <span class="m">192</span>.168.XXX.XXX:5000/rpi-micromanager:python2.0
</pre>
</div>
</div>
<div class="section" id="step-5-run-micro-manager">
<h3>Step 5: Run Micro-Manager!</h3>
<p>And now the moment of truth: running the application container. Since
it's setup to run Python automatically, I use a pretty simple <tt class="docutils literal">docker
run</tt> command.</p>
<pre class="code shell"><a name="rest_code_44303c2f70dc4c699fe02dd7140e1c76-1"></a>docker run -it --rm <span class="se">\</span>
<a name="rest_code_44303c2f70dc4c699fe02dd7140e1c76-2"></a>     --name micro-manager <span class="se">\</span>
<a name="rest_code_44303c2f70dc4c699fe02dd7140e1c76-3"></a>     <span class="m">192</span>.168.XXX.XXX:5000/rpi-micromanager:2.0-python
</pre>
<p>I verify that the Micro-Manager Python wrapper is working by trying to
import it and run <a class="reference external" href="https://micro-manager.org/wiki/Using_the_Micro-Manager_python_library">a few basic commands</a>.</p>
<pre class="code python"><a name="rest_code_5bd277414f21415497aef665e01aa4dc-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">MMCorePy</span>
<a name="rest_code_5bd277414f21415497aef665e01aa4dc-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">mmc</span> <span class="o">=</span> <span class="n">MMCorePy</span><span class="o">.</span><span class="n">CMMCore</span><span class="p">()</span>
<a name="rest_code_5bd277414f21415497aef665e01aa4dc-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">mmc</span><span class="o">.</span><span class="n">getVersionInfo</span><span class="p">()</span>
</pre>
<p>If these work without error, then congratulations! You're now ready to
start building your embedded microscopy system ;)</p>
</div>
<div class="section" id="step-6-running-the-whole-process">
<h3>Step 6: Running the whole process</h3>
<p>The beauty of having scripted all these steps is that the full
workflow may be executed quite simply. From the host system's build
folder, run:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~/src/alphapi/docker/rpi-micromanager/build$ ./build
kmdouglass@xxxxx:~/src/alphapi/docker/rpi-micromanager/build$ ./run /path/to/source true
</pre>
<p>From the 2.0-python folder:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~/src/alphapi/docker/rpi-micromanager/2.0-python ./build /path/to/source/artifacts
kmdouglass@xxxxx:~$ docker push localhost:5000/rpi-micromanager:2.0-python
</pre>
<p>And from the Raspberry Pi:</p>
<pre class="literal-block">
pi@yyyyy:~$ docker pull 192.168.XXX.XXX:5000/rpi-micromanager:2.0-python
pi@yyyyy:~$ docker run -it --rm \
                   --name micro-manager \
                   192.168.XXX.XXX:5000/rpi-micromanager:2.0-python
</pre>
<p>Hopefully this is enough to get you started building Micro-Manager for
the Raspberry Pi with Docker. Though I focused on Micro-Manager, the
workflow should be generally applicable to any large scale project in
which you want to isolate the build environment from the host machine.</p>
<p>If you have any questions, just leave them in the comments. Happy
programming!</p>
</div>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-4.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="kmdouglass";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2020         <a href="mailto:kyle.m.douglass@gmail.com">Kyle M. Douglass</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
