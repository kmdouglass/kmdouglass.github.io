<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Optics, programming, and computer vision.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kyle M. Douglass</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<link href="assets/css/custom_notebook.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="rss.xml">
<link rel="canonical" href="http://kmdouglass.github.io/">
<link rel="next" href="index-3.html" type="text/html">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><link rel="prefetch" href="posts/variable-locations-in-rust-during-copy-and-move/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://kmdouglass.github.io/">

                <span id="blog-title">Kyle M. Douglass</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="categories/index.html">Tags</a>
                </li>
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="stories/contact/index.html">Contact</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    


    
<div class="postindex">
    <article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/variable-locations-in-rust-during-copy-and-move/" class="u-url">Variable locations in Rust during copy and move</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/variable-locations-in-rust-during-copy-and-move/" rel="bookmark">
            <time class="published dt-published" datetime="2019-11-24T10:46:20+01:00" itemprop="datePublished" title="2019-11-24 10:46">2019-11-24 10:46</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/variable-locations-in-rust-during-copy-and-move/#disqus_thread" data-disqus-identifier="cache/posts/variable-locations-in-rust-during-copy-and-move.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p><a class="reference external" href="https://doc.rust-lang.org/book/ch04-00-understanding-ownership.html">Ownership</a> is a well-known concept in Rust and is a major reason for the language's memory
safety. Consider the following example of ownership from <a class="reference external" href="https://doc.rust-lang.org/book/ch04-01-what-is-ownership.html#memory-and-allocation">The Rust Programming Language</a>:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9d7d9aaa694c438c943efd0533b865d1-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9d7d9aaa694c438c943efd0533b865d1-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9d7d9aaa694c438c943efd0533b865d1-3">3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9d7d9aaa694c438c943efd0533b865d1-4">4</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_9d7d9aaa694c438c943efd0533b865d1-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"hello"</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_9d7d9aaa694c438c943efd0533b865d1-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s1</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_9d7d9aaa694c438c943efd0533b865d1-3"></a>
<a name="rest_code_9d7d9aaa694c438c943efd0533b865d1-4"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}, world!"</span><span class="p">,</span><span class="w"> </span><span class="n">s1</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p>Compiling this code will produce an error because the <tt class="docutils literal">String</tt> value that is bound to the
variable <tt class="docutils literal">s1</tt> is moved to <tt class="docutils literal">s2</tt>. After a move, you may no longer use the value bound to
<tt class="docutils literal">s1</tt>. (You may, as we will see, re-use its memory by binding a new value of the same type to it.)</p>
<p><tt class="docutils literal">String</tt> is a container type, which means that it contains both metadata and a pointer to data on
the heap. Simple types such as <tt class="docutils literal">i32</tt>, on the other hand, are normally stored on the stack. Types
such as these implement the <a class="reference external" href="https://doc.rust-lang.org/std/marker/trait.Copy.html">Copy</a> trait. This means that variable reassignment does not produce
a compile-time error like it does in the example above:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9a4e04d1e7d942ca964103d7ca23510b-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9a4e04d1e7d942ca964103d7ca23510b-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9a4e04d1e7d942ca964103d7ca23510b-3">3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9a4e04d1e7d942ca964103d7ca23510b-4">4</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_9a4e04d1e7d942ca964103d7ca23510b-5">5</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_9a4e04d1e7d942ca964103d7ca23510b-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_9a4e04d1e7d942ca964103d7ca23510b-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_9a4e04d1e7d942ca964103d7ca23510b-3"></a>
<a name="rest_code_9a4e04d1e7d942ca964103d7ca23510b-4"></a><span class="c1">// The value bound to x is Copy, so no error will be raised.</span>
<a name="rest_code_9a4e04d1e7d942ca964103d7ca23510b-5"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p><tt class="docutils literal">String</tt> is not <tt class="docutils literal">Copy</tt> because it contains a pointer to data on the heap. When a variable that
is bound to a <tt class="docutils literal">String</tt> is dropped, its data is automatically freed from the heap. If a <tt class="docutils literal">String</tt>
were <tt class="docutils literal">Copy</tt>, the compiler would have to determine whether the heap data is still pointed to by
another variable to avoid a <a class="reference external" href="https://stackoverflow.com/questions/21057393/what-does-double-free-mean">double free error</a>.</p>
<div class="section" id="memory-layout-in-copies-and-moves">
<h2>Memory layout in copies and moves</h2>
<p>What's happening inside a program's memory during copies and moves? Consider first a move:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-1"> 1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-2"> 2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-3"> 3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-4"> 4</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-5"> 5</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-6"> 6</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-7"> 7</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-8"> 8</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-9"> 9</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-10">10</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-11">11</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-12">12</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_be160457af804b03b3e72d11b02edf33-13">13</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_be160457af804b03b3e72d11b02edf33-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"foo"</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-2"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-3"></a>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-4"></a><span class="c1">// Move occurs here</span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-6"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of y: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-7"></a>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-8"></a><span class="c1">// Printing the memory address of x is an error because its value was moved.</span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-9"></a><span class="c1">// println!("Memory address of x: {:p}", &amp;x)</span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-10"></a>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-11"></a><span class="c1">// Assign new string to x</span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-12"></a><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="s">"bar"</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_be160457af804b03b3e72d11b02edf33-13"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p>In the above code snippet, addresses of variables are printed by using the pointer formatter
<tt class="docutils literal">:p</tt>. I create a <tt class="docutils literal">String</tt> value and bind it to the variable <tt class="docutils literal">x</tt>. Then, the value is moved to
the variable <tt class="docutils literal">y</tt> which prevents me from using <tt class="docutils literal">x</tt> again in the <tt class="docutils literal">println!</tt> macro.</p>
<p>However, I can assign a new <tt class="docutils literal">String</tt> value to the memory allocated for <tt class="docutils literal">x</tt>. This does not
change its location in memory as seen in the output below:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_2e7a115c1b814b4ca314c900b7a7d715-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_2e7a115c1b814b4ca314c900b7a7d715-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_2e7a115c1b814b4ca314c900b7a7d715-3">3</a></pre></div></td>
<td class="code"><pre class="code console"><a name="rest_code_2e7a115c1b814b4ca314c900b7a7d715-1"></a><span class="go">Memory address of x: 0x7ffded2aa3d0</span>
<a name="rest_code_2e7a115c1b814b4ca314c900b7a7d715-2"></a><span class="go">Memory address of y: 0x7ffded2aa3f0</span>
<a name="rest_code_2e7a115c1b814b4ca314c900b7a7d715-3"></a><span class="go">Memory address of x: 0x7ffded2aa3d0  # Memory address of x is unchanged after reassignment</span>
</pre></td>
</tr></table>
<p>A copy is similar. In the snippet below, an integer that is originally bound to <tt class="docutils literal">x</tt> is copied to
<tt class="docutils literal">y</tt>, which means that I can still refer to <tt class="docutils literal">x</tt> in the <tt class="docutils literal">println!</tt> macro.</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-1"> 1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-2"> 2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-3"> 3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-4"> 4</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-5"> 5</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-6"> 6</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-7"> 7</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-8"> 8</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-9"> 9</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-10">10</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-11">11</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-12">12</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_f7b58f9681784256bc1f0a67f03186b3-13">13</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-1"></a><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-2"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-3"></a>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-4"></a><span class="c1">// Move occurs here</span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-5"></a><span class="kd">let</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-6"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of y: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">y</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-7"></a>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-8"></a><span class="c1">// Printing the memory address of x is not an error because its value was copied.</span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-9"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-10"></a>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-11"></a><span class="c1">// Assign new integer to x</span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-12"></a><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_f7b58f9681784256bc1f0a67f03186b3-13"></a><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Memory address of x: {:p}"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></td>
</tr></table>
<p>Both the copy operation and value reassignment do not change the memory locations of <tt class="docutils literal">x</tt> as seen
in the program's output:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_fbcd103ad81f4bbc845efe0a76d3884a-1">1</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_fbcd103ad81f4bbc845efe0a76d3884a-2">2</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_fbcd103ad81f4bbc845efe0a76d3884a-3">3</a>
<a href="posts/variable-locations-in-rust-during-copy-and-move/#rest_code_fbcd103ad81f4bbc845efe0a76d3884a-4">4</a></pre></div></td>
<td class="code"><pre class="code console"><a name="rest_code_fbcd103ad81f4bbc845efe0a76d3884a-1"></a><span class="go">Memory address of x: 0x7ffee579d544</span>
<a name="rest_code_fbcd103ad81f4bbc845efe0a76d3884a-2"></a><span class="go">Memory address of y: 0x7ffee579d548</span>
<a name="rest_code_fbcd103ad81f4bbc845efe0a76d3884a-3"></a><span class="go">Memory address of x: 0x7ffee579d544  # Memory address of x is unchanged after copy</span>
<a name="rest_code_fbcd103ad81f4bbc845efe0a76d3884a-4"></a><span class="go">Memory address of x: 0x7ffee579d544  # Memory address of x is unchanged after reassignment</span>
</pre></td>
</tr></table>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>Move semantics on container types are one of the reasons for Rust's memory safety. Nothing
mysterious is happening in memory when a value is moved from one location to another. The allocated
memory still exists; its use is simply disallowed by the compiler until a new value is assigned to
it.</p>
<p>The complete program from this post may be found here:
<a class="reference external" href="https://gist.github.com/kmdouglass/e596d0934e15f6b3a96c1eca6f6cd999">https://gist.github.com/kmdouglass/e596d0934e15f6b3a96c1eca6f6cd999</a></p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/a-simple-plugin-interface-for-the-rust-ffi/" class="u-url">A simple plugin interface for the Rust FFI</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/a-simple-plugin-interface-for-the-rust-ffi/" rel="bookmark">
            <time class="published dt-published" datetime="2019-06-16T09:33:33+02:00" itemprop="datePublished" title="2019-06-16 09:33">2019-06-16 09:33</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#disqus_thread" data-disqus-identifier="cache/posts/a-simple-plugin-interface-for-the-rust-ffi.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>In a recent post I explored <a class="reference external" href="http://kmdouglass.github.io/posts/complex-data-types-and-the-rust-ffi/">how to pass complex datatypes through the Rust FFI</a>. (The FFI is the
foreign function interface, a part of the Rust language for calling code written in other
languages.)</p>
<p>I am exploring the Rust FFI because I want to use it in <a class="reference external" href="https://github.com/kmdouglass/kpal">a small web application</a> that I am
writing and that will be used to interact with hardware peripherals connected to a system on a chip
(SoC). One use-case that I have in mind is to monitor readings from moisture and temperature
sensors implanted in the soil of my houseplants. In many cases the general purpose input/output
(GPIO) pins of a SoC are controlled through a C library such as <a class="reference external" href="http://wiringpi.com">WiringPi</a> for the Raspberry Pi,
which means my monitoring system needs to interface with C libraries such as this one.</p>
<p>In this post I will describe my current understanding for how best to integrate C-language plugins
with a Rust application. I have omitted all application-specific logic from the example and will
instead focus on the design of the plugin interface itself.</p>
<p>You may find <a class="reference external" href="https://github.com/kmdouglass/rust-libloading-example">the source code for this post here</a>. I was heavily inspired by both the <a class="reference external" href="http://jakegoulding.com/rust-ffi-omnibus/">Rust FFI
Omnibus</a> and <a class="reference external" href="https://michael-f-bryan.github.io/rust-ffi-guide/">The (unofficial) Rust FFI Guide</a>. This post was written using version 1.35.0 of the
Rust compiler.</p>
<div class="section" id="the-c-plugin">
<h2>The C plugin</h2>
<p>I wrote a very simple of C library that is located in the <a class="reference external" href="https://github.com/kmdouglass/rust-libloading-example/tree/master/ffi-test">ffi-test</a> folder of the example
repository and that will serve the purpose of this demonstration. It consists of two source files
(<tt class="docutils literal"><span class="pre">ffi-test.c</span></tt> and <tt class="docutils literal"><span class="pre">ffi-test.h</span></tt>) and a <tt class="docutils literal">Makefile</tt>. The plugin's interface is defined as usual
in the header file:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-1"> 1</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-2"> 2</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-3"> 3</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-4"> 4</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-5"> 5</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-6"> 6</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-7"> 7</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-8"> 8</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-9"> 9</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-10">10</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-11">11</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-12">12</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-13">13</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-14">14</a>
<a href="posts/a-simple-plugin-interface-for-the-rust-ffi/#rest_code_3229f5ca334f4d2faab09a82f880df02-15">15</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_3229f5ca334f4d2faab09a82f880df02-1"></a><span class="cp">#ifndef FFI_TEST_H</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-2"></a><span class="cp">#define FFI_TEST_H</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-3"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-4"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-5"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-6"></a><span class="k">struct</span> <span class="n">object</span><span class="p">;</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-7"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-8"></a><span class="k">struct</span> <span class="n">object</span><span class="o">*</span> <span class="nf">init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-9"></a><span class="kt">void</span> <span class="nf">free_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span><span class="o">*</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-10"></a><span class="kt">int</span> <span class="nf">get_api_version</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-11"></a><span class="kt">int</span> <span class="nf">get_info</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">object</span><span class="o">*</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-12"></a><span class="kt">void</span> <span class="nf">set_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">object</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-13"></a><span class="kt">size_t</span> <span class="nf">sizeof_obj</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-14"></a>
<a name="rest_code_3229f5ca334f4d2faab09a82f880df02-15"></a><span class="cp">#endif </span><span class="cm">/* FFI_TEST_H */</span><span class="cp"></span>
</pre></td>
</tr></table>
<p>In particular, there is an opaque struct that is declared by the line <code>struct object;</code>. (An
opaque struct is a struct whose definition is hidden from the public API; the definition is
provided in the file <tt class="docutils literal"><span class="pre">ffi-test.c</span></tt>.) This object will hold the data for our plugin, but, because
it is opaque, we will only be able to interact with it through functions such as <tt class="docutils literal">init</tt>,
<tt class="docutils literal">free_object</tt>, etc. that are provided by the API.</p>
<p>To build the C library on UNIX-like systems, simply execute the <tt class="docutils literal">make</tt> command from within the
<tt class="docutils literal"><span class="pre">ffi-test</span></tt> library.</p>
<pre class="code console"><a name="rest_code_d952c6d87ba5421786543314ce9f4b86-1"></a><span class="gp">$</span> make
<a name="rest_code_d952c6d87ba5421786543314ce9f4b86-2"></a><span class="go">gcc -c -o libffi-test.o -fpic ffi-test.c -Wall -Werror</span>
<a name="rest_code_d952c6d87ba5421786543314ce9f4b86-3"></a><span class="go">gcc -shared -o libffi-test.so libffi-test.o</span>
</pre>
</div>
<div class="section" id="the-rust-c-plugin-interface">
<h2>The Rust-C plugin interface</h2>
<p>The Rust code is contained in one source file, <a class="reference external" href="https://github.com/kmdouglass/rust-libloading-example/blob/master/src/main.rs">src/main.rs</a>. The design pattern contained within
consists of three kinds of objects:</p>
<ul class="simple">
<li>type definitions for the functions in the C library</li>
<li>a <tt class="docutils literal">VTable</tt> struct that holds the external function types</li>
<li>a <tt class="docutils literal">Plugin</tt> struct that holds the plugin's library, the <tt class="docutils literal">VTable</tt>, and a raw pointer to the
object provided by the C library</li>
</ul>
<p>Let's take a look at each of these abstractions.</p>
<div class="section" id="external-function-types">
<h3>External function types</h3>
<p>The external function types are defined as follows:</p>
<pre class="code rust"><a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-2"></a><span class="k">struct</span> <span class="nc">Object</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-3"></a><span class="w">    </span><span class="n">_private</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="p">],</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-4"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-5"></a><span class="k">type</span> <span class="nc">FreeObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-6"></a><span class="k">type</span> <span class="nc">Init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-7"></a><span class="k">type</span> <span class="nc">GetApiVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">c_int</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-8"></a><span class="k">type</span> <span class="nc">GetInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Object</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">c_int</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_05f70e3bb46b417f86fb106c3524eed4-9"></a><span class="k">type</span> <span class="nc">SetInfo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">,</span><span class="w"> </span><span class="n">c_int</span><span class="p">);</span><span class="w"></span>
</pre>
<p>The opaque struct from the C library is represented as rust <tt class="docutils literal">struct</tt> with a single, private field
containing an empty array. <a class="reference external" href="https://doc.rust-lang.org/nomicon/ffi.html#representing-opaque-structs">This is currently the recommended way</a> to represent opaque structs in
the Rust FFI. Following the <tt class="docutils literal">struct</tt> definition are the type definitions for the foreign
functions.</p>
<pre class="code rust"><a name="rest_code_4106bf0f510f4ff7b584fb5f36d30624-1"></a><span class="k">type</span> <span class="nc">FreeObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_4106bf0f510f4ff7b584fb5f36d30624-2"></a><span class="k">type</span> <span class="nc">Init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_4106bf0f510f4ff7b584fb5f36d30624-3"></a><span class="c1">// ...</span>
</pre>
<p>For example, the <tt class="docutils literal">Init</tt> type represents a foreign C function that takes no arguments and returns
a mutable raw pointer to an <tt class="docutils literal">Object</tt> instance. This function type therefore represents the
<tt class="docutils literal">Object</tt> constructor in Rust.</p>
</div>
<div class="section" id="the-vtable">
<h3>The VTable</h3>
<p>The <tt class="docutils literal">VTable</tt> serves as a way to collect the types associated with the C library functions into
one place. Furthermore, I added a version number to make it <tt class="docutils literal">VTableV0</tt>. The purpose in doing this
is to easily maintain backwards compatability with and follow changes to the C API.</p>
<p>By looking at its definition, you can see that it contains a few <tt class="docutils literal">RawSymbol</tt> instances:</p>
<pre class="code rust"><a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-1"></a><span class="k">struct</span> <span class="nc">VTableV0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-2"></a><span class="w">    </span><span class="n">free_object</span>: <span class="nc">RawSymbol</span><span class="o">&lt;</span><span class="n">FreeObject</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-3"></a><span class="w">    </span><span class="n">get_info</span>: <span class="nc">RawSymbol</span><span class="o">&lt;</span><span class="n">GetInfo</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-4"></a><span class="w">    </span><span class="n">set_info</span>: <span class="nc">RawSymbol</span><span class="o">&lt;</span><span class="n">SetInfo</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_b183cd639bf6453ea1fc1995ab8211ef-5"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>A <tt class="docutils literal">RawSymbol</tt> is a name that I gave to Unix-specific symbols from the <tt class="docutils literal">libloading</tt> Rust
library. (See the <tt class="docutils literal">use</tt> statements at the top of the source code file.) I am not storing plain
<tt class="docutils literal">Symbols</tt> from that library inside the VTable because the lifetime constraints associated with
plain <tt class="docutils literal">Symbols</tt> and their corresponding <tt class="docutils literal">Library</tt> do not allow me to take ownership of them
inside the struct. (You can find a few attempts in the commit history of this repository where I
tried to own plain <tt class="docutils literal">Symbols</tt>; none of these attempts would compile.)</p>
<p>Instead, if I had used a plain <tt class="docutils literal">Symbol</tt>, then I would have had to lookup the symbols inside the C
library each time that I wanted to call them.</p>
<p>The way to obtain <tt class="docutils literal">RawSymbols</tt> is to use the <tt class="docutils literal">into_raw</tt> method of a plain <tt class="docutils literal">Symbol</tt>. You can
find an example of this inside the <tt class="docutils literal">VTable</tt>'s constructor:</p>
<pre class="code rust"><a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-1"></a><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">library</span>: <span class="kp">&amp;</span><span class="nc">Library</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">VTableV0</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-2"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Loading API version 0..."</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">free_object</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">FreeObject</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"free_object</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">free_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">free_object</span><span class="p">.</span><span class="n">into_raw</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_7af1db91e6a04513b398a87ea82ca3f1-5"></a><span class="w">    </span><span class="c1">// ...</span>
</pre>
<p>First, the <tt class="docutils literal">free_object</tt> <tt class="docutils literal">Symbol</tt> is imported from the library using the <tt class="docutils literal">get()</tt> method from
the library, then it is converted to a <tt class="docutils literal">RawSymbol</tt> in the following line so that it can be stored
inside the <tt class="docutils literal">VTableV0</tt> struct that is returned by the constructor. The whole function is marked as
<tt class="docutils literal">unsafe</tt> because of the multiple calls to the <tt class="docutils literal">get</tt> method.</p>
</div>
<div class="section" id="the-plugin">
<h3>The Plugin</h3>
<p>Finally we reach the top of the hierarchy of the components that comprise this design, the
<tt class="docutils literal">Plugin</tt> struct. Its implementation follows:</p>
<pre class="code rust"><a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-1"></a><span class="k">struct</span> <span class="nc">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-2"></a><span class="w">    </span><span class="cp">#[allow(dead_code)]</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-3"></a><span class="w">    </span><span class="n">library</span>: <span class="nc">Library</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-4"></a><span class="w">    </span><span class="n">object</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-5"></a><span class="w">    </span><span class="n">vtable</span>: <span class="nc">VTableV0</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-6"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-7"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-8"></a><span class="k">impl</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-9"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">library_name</span>: <span class="kp">&amp;</span><span class="nc">OsStr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Library</span>::<span class="n">new</span><span class="p">(</span><span class="n">library_name</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-11"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">get_api_version</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">GetApiVersion</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"get_api_version</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-12"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vtable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">get_api_version</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-13"></a><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">VTableV0</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">library</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-14"></a><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">panic</span><span class="o">!</span><span class="p">(</span><span class="s">"Unrecognized C API version number."</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-15"></a><span class="w">        </span><span class="p">};</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-16"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-17"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">init</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">Init</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"init</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-18"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">object</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-19"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-20"></a><span class="w">        </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-21"></a><span class="w">            </span><span class="n">library</span>: <span class="nc">library</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-22"></a><span class="w">            </span><span class="n">object</span>: <span class="nc">object</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-23"></a><span class="w">            </span><span class="n">vtable</span>: <span class="nc">vtable</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-24"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-25"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-26"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-27"></a>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-28"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-29"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-30"></a><span class="w">        </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">vtable</span><span class="p">.</span><span class="n">free_object</span><span class="p">)(</span><span class="bp">self</span><span class="p">.</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-31"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_a901913759eb4f36bb6ae1f61e1667e1-32"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The interesting parts here are the <tt class="docutils literal">Plugin</tt>'s constructor <tt class="docutils literal">new</tt> and the implementation of the
<tt class="docutils literal">Drop</tt> trait. After loading the library, the constructor calls the C library function that
returns its API version; if the version matches one for which we have a <tt class="docutils literal">VTable</tt>, then we create
the new <tt class="docutils literal">VTable</tt>. Next, we instantiate an <tt class="docutils literal">Object</tt> by calling its constructor to obtain a raw
pointer to it.</p>
<pre class="code rust"><a name="rest_code_3b30d939dcb94bf5b21f9a3e5c261d24-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">init</span>: <span class="nc">Symbol</span><span class="o">&lt;</span><span class="n">Init</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">library</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">b"init</span><span class="se">\0</span><span class="s">"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_3b30d939dcb94bf5b21f9a3e5c261d24-2"></a><span class="kd">let</span><span class="w"> </span><span class="n">object</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">init</span><span class="p">();</span><span class="w"></span>
</pre>
<p>The constructor packs the library, the <tt class="docutils literal">VTable</tt>, and the object pointer into a new <tt class="docutils literal">Plugin</tt>
struct and returns it.</p>
<p>The <tt class="docutils literal">Drop</tt> trait implementation is used to automatically free the memory that has been allocated
when the pointer held by the <tt class="docutils literal">Plugin</tt> struct goes out-of-scope. It does this by calling the
<tt class="docutils literal">free_object</tt> method in the VTable.</p>
<pre class="code rust"><a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-1"></a><span class="k">impl</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-2"></a><span class="w">    </span><span class="k">fn</span> <span class="nf">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-3"></a><span class="w">        </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">vtable</span><span class="p">.</span><span class="n">free_object</span><span class="p">)(</span><span class="bp">self</span><span class="p">.</span><span class="n">object</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-4"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_196c66d6af1f4becae51d4f8eaa00883-5"></a><span class="p">}</span><span class="w"></span>
</pre>
</div>
<div class="section" id="running-the-example">
<h3>Running the example</h3>
<p>To run the example, run the following commands from the root directory of the example repository.</p>
<pre class="code console"><a name="rest_code_60bbc661a2b749749e78afdcefd84448-1"></a><span class="gp">$</span> cargo build
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-2"></a><span class="go">Compiling rust-libloading v0.1.0 (/home/kmdouglass/src/rust-libloading-example)</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-3"></a><span class="go"> Finished dev [unoptimized + debuginfo] target(s) in 0.27s</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-4"></a><span class="gp">$</span> cargo run
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-5"></a><span class="go"> Finished dev [unoptimized + debuginfo] target(s) in 0.01s</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-6"></a><span class="go">  Running `target/debug/rust-libloading`</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-7"></a><span class="go">Loading API version 0...</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-8"></a><span class="go">Original value: 0</span>
<a name="rest_code_60bbc661a2b749749e78afdcefd84448-9"></a><span class="go">New value: 42</span>
</pre>
<p>The <tt class="docutils literal">main</tt> method of the Rust code creates the plugin, prints the default value of the data held
by the object (which is instantiated by the C library), and then mutates the data to the value
<tt class="docutils literal">42</tt>.</p>
<p>It then prints this value, demonstrating that the FFI calls work.</p>
</div>
</div>
<div class="section" id="discussion">
<h2>Discussion</h2>
<p>The most difficult part of developing this design was finding a way to own the symbols exposed by
the plugin library. For me, it was not completely evident from the <a class="reference external" href="https://docs.rs/libloading/0.5.1/libloading/">libloading documentation</a> that
this was the purpose of the <tt class="docutils literal">into_raw</tt> method on a <tt class="docutils literal">Symbol</tt>.</p>
<p>What I like about this design is that the whole plugin interface fits nicely within a simple
hierarchy with a collection of foreign method types at its base. It also supports changes to the C
API because a new <tt class="docutils literal">VTable</tt> can be created each time the API changes.</p>
<p>One current disadvantage of the design is that <tt class="docutils literal">free_object</tt> is exposed through the VTable. I
think that this opens the possibility for a double-free error. One way to prevent this is to hide
the <tt class="docutils literal">free_object</tt> method, loading its corresponding symbol only when the <tt class="docutils literal">drop</tt> method is
called.</p>
<p>Another disadvantage of this design is that it relies on the particular C API exposed by the
library. C programmers have a large amount of freedom in designing APIs for their libraries. They
are not forced to use opaque structs or to version their APIs. As a result, I don't believe that
the plugin design presented here can be completely generalized to any C library.</p>
<p>The <tt class="docutils literal">Plugin</tt> struct is almost certainly not thread safe. To make it thread safe, it may be
necessary to wrap the raw pointer in a <tt class="docutils literal">Mutex</tt>. It may even be simpler to wrap the entire struct
in a <tt class="docutils literal">Mutex</tt>.</p>
<p>Finally, owning raw symbols is not platform independent. You can see at the top of the Rust source
code that I am importing the <tt class="docutils literal">Symbol</tt> object specific to UNIX systems. One would need to change
this if it was intended to work on Windows.</p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<ul class="simple">
<li>I presented a design pattern for managing C-language plugins in Rust.</li>
<li>The design pattern consists of a collection of foreign object function types, the
<tt class="docutils literal">VTable</tt>. This collection is part of a larger collection which owns pointers to the opaque data
types exposed by the library, as well as the plugin library itself.</li>
<li>The trick to owning symbols (instead of looking them up in the library each time you want to use
them), is to use <tt class="docutils literal">into_raw</tt> method that is implemented on libloading's <tt class="docutils literal">Symbol</tt>.</li>
<li>This design cannot be completely generalized to any C library, but should provide a good starting
point to work with FFI plugins in Rust.</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/complex-data-types-and-the-rust-ffi/" class="u-url">Complex data types and the Rust FFI</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/complex-data-types-and-the-rust-ffi/" rel="bookmark">
            <time class="published dt-published" datetime="2019-04-04T19:51:55+02:00" itemprop="datePublished" title="2019-04-04 19:51">2019-04-04 19:51</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/complex-data-types-and-the-rust-ffi/#disqus_thread" data-disqus-identifier="cache/posts/complex-data-types-and-the-rust-ffi.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>The <a class="reference external" href="https://doc.rust-lang.org/nomicon/ffi.html">Rust Foreign Function Interface</a> (FFI, for short) is a feature of Rust that enables the
sharing of data and functions between parts of code that have been written in different
languages. I am interested in the FFI because many libraries used in embedded systems are written
in C, and I would like to leverage them for my embedded work with Rust.</p>
<p>I quickly learned from my initial experiments with the Rust FFI that one of its challenges is
casting data types into a form that may be consumed by other languages. This challenge is not
unique to the Rust FFI, and there are numerous reasons for it. For one, different languages use
different mechanisms to layout data in the computer's memory. What's more, names for functions and
data types are often mangled, which means that the symbol in a library that maps to a function may
be different than the name that you give to the function in your code. As far as I know, C
compilers do not mangle symbol names, and partly for this reason the C language is often used as an
intermediary language in FFIs. Converting Rust to C is therefore an important skill when using Rust
for multi-language work.</p>
<p>There are a few good resources on the internet about using the Rust FFI to expose functions written
in Rust to other languages. However, I found little information about passing data types between
languages. To help remedy this situation, I describe in this post a simple Rust library that I
wrote to explore how to pass complex data types from Rust to C.</p>
<div class="section" id="an-example-ffi-project">
<h2>An example FFI project</h2>
<p>I created the Rust library in the typical way by first starting a new project with Cargo:</p>
<pre class="code shell"><a name="rest_code_372b84d1c7254bbaa80260de2378dbce-1"></a>$ cargo new --lib rstruct
<a name="rest_code_372b84d1c7254bbaa80260de2378dbce-2"></a>$ <span class="nb">cd</span> rstruct
</pre>
<p>Inside, I modified the contents of <tt class="docutils literal">Cargo.toml</tt> to the following:</p>
<pre class="code text"><a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-1"></a>[package]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-2"></a>name = "rstruct"
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-3"></a>version = "0.1.0"
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-4"></a>authors = ["Kyle M. Douglass"]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-5"></a>edition = "2018"
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-6"></a>
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-7"></a>[lib]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-8"></a>crate-type = ["cdylib"]
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-9"></a>
<a name="rest_code_5fbba1c3a9fd47cd91f5cd370105ecf6-10"></a>[dependencies]
</pre>
<p>The only lines that I added were <tt class="docutils literal">[lib]</tt> and <tt class="docutils literal"><span class="pre">crate-type</span> = ["cdylib"]</tt>. As described in the
<a class="reference external" href="https://doc.rust-lang.org/edition-guide/rust-2018/platform-and-target-support/cdylib-crates-for-c-interoperability.html">2018 edition guide</a>, this type of crate produces a binary that has no Rust-specific information
in it and is intended for use through a C FFI.</p>
<p>Next, I opened the <tt class="docutils literal">src/lib.rs</tt> source file, removed the auto-generated content, and added the
following source.</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-1"> 1</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-2"> 2</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-3"> 3</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-4"> 4</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-5"> 5</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-6"> 6</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-7"> 7</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-8"> 8</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-9"> 9</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-10">10</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-11">11</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-12">12</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-13">13</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-14">14</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-15">15</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-16">16</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-17">17</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-18">18</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-19">19</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-20">20</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-21">21</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-22">22</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-23">23</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-24">24</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-25">25</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-26">26</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-27">27</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-28">28</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-29">29</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-30">30</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-31">31</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-32">32</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-33">33</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-34">34</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-35">35</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-36">36</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_d724c2d6c3244a979b169b4a559585b7-37">37</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_d724c2d6c3244a979b169b4a559585b7-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">boxed</span>::<span class="nb">Box</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">CString</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">raw</span>::<span class="n">c_char</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-4"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-5"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-6"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-7"></a><span class="w">    </span><span class="n">name</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_char</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-8"></a><span class="w">    </span><span class="n">value</span>: <span class="nc">Value</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-9"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-10"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-11"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-12"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-13"></a><span class="w">    </span><span class="n">_Int</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-14"></a><span class="w">    </span><span class="n">_Float</span><span class="p">(</span><span class="kt">f64</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-15"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-16"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-17"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-18"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-19"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="s">"Inside data_new()."</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-20"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-21"></a><span class="w">    </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-22"></a><span class="w">        </span><span class="n">name</span>: <span class="nc">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"my_rstruct"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-23"></a><span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error: CString::new()"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-24"></a><span class="w">            </span><span class="p">.</span><span class="n">into_raw</span><span class="p">(),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-25"></a><span class="w">        </span><span class="n">value</span>: <span class="nc">Value</span>::<span class="n">_Int</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-26"></a><span class="w">    </span><span class="p">}))</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-27"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-28"></a>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-29"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-30"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_free</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-31"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-32"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-33"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-34"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-35"></a><span class="w">        </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-36"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_d724c2d6c3244a979b169b4a559585b7-37"></a><span class="p">}</span><span class="w"></span>
</pre></td>
</tr></table>
<p>Roughly speaking, this simple library does two things. First, it defines two data types, a struct
called <tt class="docutils literal">RStruct</tt> and a Rust enum (not to be confused with a C enum!) called <tt class="docutils literal">Value</tt>. Second, it
exposes two functions that may be used to access instances of these data types from C:
<tt class="docutils literal">data_new()</tt> and <tt class="docutils literal">data_free()</tt>.</p>
<p>Let's take closer look now at what the code is doing.</p>
</div>
<div class="section" id="defining-structs-and-enums-for-use-in-c">
<h2>Defining structs and enums for use in C</h2>
<p>I want to expose instances of the RStruct type to C code. The definition of <tt class="docutils literal">RStruct</tt> is</p>
<pre class="code rust"><a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-3"></a><span class="w">    </span><span class="n">name</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">c_char</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-4"></a><span class="w">    </span><span class="n">value</span>: <span class="nc">Value</span><span class="p">,</span><span class="w"></span>
<a name="rest_code_1b6b309db3de40e3b9da5e9c3a097dbf-5"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The first line here is <tt class="docutils literal">[repr(C)]</tt>. This is an attribute that modifies the layout of the struct
in memory to "do what C does." As described in the <a class="reference external" href="https://doc.rust-lang.org/nomicon/other-reprs.html">Rustonomicon</a>,</p>
<blockquote>
The order, size, and alignment of fields is exactly what you would expect from C or C++. Any
type you expect to pass through an FFI boundary should have repr(C), as C is the lingua-franca
of the programming world.</blockquote>
<p>Next, we define a public struct just as we would if we were writing typical Rust code. In this
example, the struct has two fields. The first is a field called <tt class="docutils literal">name</tt>, which has a type <tt class="docutils literal">*const
c_char</tt>. The Rust data types <tt class="docutils literal">String</tt> and <tt class="docutils literal">&amp;str</tt> cannot be interpreted in C, so instead we
define the data type as a <a class="reference external" href="https://doc.rust-lang.org/std/primitive.pointer.html">raw pointer</a> to a <tt class="docutils literal">c_char</tt>. (In this case, <tt class="docutils literal">*</tt> is not dereferencing
the pointer but is <a class="reference external" href="https://doc.rust-lang.org/beta/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer">part of the type name</a> <tt class="docutils literal">*const T</tt>.)</p>
<p>The second field is an enum whose definition follows:</p>
<pre class="code rust"><a name="rest_code_50968308faa5491b9ed28adbef50b95c-1"></a><span class="cp">#[repr(C)]</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Value</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-3"></a><span class="w">    </span><span class="n">_Int</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-4"></a><span class="w">    </span><span class="n">_Float</span><span class="p">(</span><span class="kt">f64</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_50968308faa5491b9ed28adbef50b95c-5"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>Again we use <tt class="docutils literal">#[repr(C)]</tt> to indicate that we want the enum to be laid out in memory in the same
manner as in C. The enum <tt class="docutils literal">Value</tt> has two variants, <tt class="docutils literal">_Int</tt> and <tt class="docutils literal">_Float</tt>, that each contain a
value of <tt class="docutils literal">i32</tt> and <tt class="docutils literal">f64</tt>, respectively. If you're familiar with C, then you may have already
noticed that C enums are differnt from Rust enums in that they do not hold any data themselves. How
this minor annoyance is solved will be seen later when we generate the C header for this library.</p>
<p>The data types i32 and f64 are easily translated into C's equivalent numeric data types, so there
is no need to do anything special with them.</p>
<div class="section" id="instantiating-and-freeing-memory">
<h3>Instantiating and freeing Memory</h3>
<p>Following the data type definitions, there are two functions that are exposed through the FFI
boundary, one for instantiating an <tt class="docutils literal">RStruct</tt> and one for freeing the memory associated with an
<tt class="docutils literal">RStruct</tt>. The method for instantiation is first:</p>
<pre class="code rust"><a name="rest_code_c5c45d679080471fa4e88d3ba112337f-1"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-3"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="s">"Inside data_new()."</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-4"></a>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-5"></a><span class="w">    </span><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-6"></a><span class="w">        </span><span class="n">name</span>: <span class="nc">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"my_rstruct"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-7"></a><span class="w">            </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error: CString::new()"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-8"></a><span class="w">            </span><span class="p">.</span><span class="n">into_raw</span><span class="p">(),</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-9"></a><span class="w">        </span><span class="n">value</span>: <span class="nc">Value</span>::<span class="n">_Int</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-10"></a><span class="w">    </span><span class="p">}))</span><span class="w"></span>
<a name="rest_code_c5c45d679080471fa4e88d3ba112337f-11"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The first line contains an attribute called <tt class="docutils literal">#[no_mangle]</tt>. As defined in <a class="reference external" href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#calling-rust-functions-from-other-languages">the Book</a>:</p>
<blockquote>
Mangling is when a compiler changes the name we’ve given a function to a different name that
contains more information for other parts of the compilation process to consume but is less
human readable.</blockquote>
<p>Placing the <tt class="docutils literal">#[no_mangle]</tt> attribute before the function definition ensures that the function
name matches that of the corresponding symbol in the library.</p>
<p>Next is the function definition <tt class="docutils literal">pub extern "C" fn data_new() <span class="pre">-&gt;</span> *mut RStruct</tt>. Let's break this
down into parts to understand it better:</p>
<ul class="simple">
<li>
<tt class="docutils literal">pub</tt> : The function will be callable from outside the library</li>
<li>
<tt class="docutils literal">extern "C"</tt> : This line serves two different purposes in Rust, both related to FFI. In my
case, I use it specify that the function should be exposed with the <a class="reference external" href="https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#using-extern-functions-to-call-external-code">application binary interface
from C</a>.</li>
<li>
<tt class="docutils literal">fn data_new()</tt> : This is just the usual <tt class="docutils literal">fn</tt> keyword and the name of the function</li>
<li>
<tt class="docutils literal"><span class="pre">-&gt;</span> *mut RStruct</tt> : Here I specify that the function will return a mutable, raw pointer to an
<tt class="docutils literal">RStruct instance</tt>.</li>
</ul>
<p>The purpose of this function is to create a <tt class="docutils literal">RStruct</tt> instance and return a pointer to it. The
<tt class="docutils literal">RStruct</tt> is created just as we would any other struct in Rust, with the exception of the
<tt class="docutils literal">name</tt> field:</p>
<pre class="code rust"><a name="rest_code_db22fa28688d448aa57c1b463f3b296e-1"></a><span class="n">RStruct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-2"></a><span class="w">    </span><span class="n">name</span>: <span class="nc">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"my_rstruct"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-3"></a><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"Error: CString::new()"</span><span class="p">)</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-4"></a><span class="w">        </span><span class="p">.</span><span class="n">into_raw</span><span class="p">(),</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-5"></a><span class="w">    </span><span class="n">value</span>: <span class="nc">Value</span>::<span class="n">_Int</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span><span class="w"></span>
<a name="rest_code_db22fa28688d448aa57c1b463f3b296e-6"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The <tt class="docutils literal">CString</tt> is first created with the <tt class="docutils literal">new()</tt> constructor and contains the value
<tt class="docutils literal">"my_rstruct"</tt>. After unpacking the result with <tt class="docutils literal">expect()</tt>, I call the <tt class="docutils literal">into_raw()</tt> method to
create a raw pointer to the C string whose <a class="reference external" href="https://doc.rust-lang.org/std/ffi/struct.CString.html#method.into_raw">ownership will be passed off to the calling C
code</a>. (If I had used <tt class="docutils literal">as_ptr()</tt> instead, the pointer would have been dropped immediately after
the function call because the <tt class="docutils literal">CString</tt> <a class="reference external" href="https://doc.rust-lang.org/std/ffi/struct.CString.html#method.as_ptr">would have been deallocated</a>.) The <tt class="docutils literal">value</tt> field is
instantiated as it would be in normal Rust.</p>
<p>What is perhaps new in this method is the <tt class="docutils literal">Box</tt> type that wraps the <tt class="docutils literal">RStruct</tt> instance.</p>
<pre class="code rust"><a name="rest_code_23022038f17b42e8a9a6086151a67fda-1"></a><span class="nb">Box</span>::<span class="n">into_raw</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">))</span><span class="w"></span>
</pre>
<p>A <tt class="docutils literal">Box</tt> is one of Rust's smart pointers that is used to <a class="reference external" href="https://doc.rust-lang.org/book/ch15-01-box.html">allocate memory for a data type on the
heap</a>. When <tt class="docutils literal"><span class="pre">Box::new()</span></tt> is called it creates a pointer to the newly created <tt class="docutils literal">RStruct</tt>
instance. Normally, this pointer would be dropped and the memory automatically deallocated when the
<tt class="docutils literal">data_new()</tt> function returns. However, the <tt class="docutils literal"><span class="pre">Box::into_raw()</span></tt> function serves the same purpose
here as the corresponding function for <tt class="docutils literal">CString</tt>: it hands off ownership of the pointer to the
calling code so that the memory is not deallocated.</p>
<p>There is a rule-of-thumb that memory allocated by Rust should be freed by Rust. For this reason, we
provide the <tt class="docutils literal">data_free()</tt> method that C code may use to deallocate the memory that is allocated
by <tt class="docutils literal">data_new()</tt>.</p>
<pre class="code rust"><a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-1"></a><span class="cp">#[no_mangle]</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">data_free</span><span class="p">(</span><span class="n">ptr</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RStruct</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-6"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-7"></a><span class="w">        </span><span class="nb">Box</span>::<span class="n">from_raw</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-8"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_1afd7c46e2284749bb2edc66c6b7c732-9"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>This function accepts a mutable pointer to an RStruct. First, it checks whether the pointer is null
and if it is, the function returns without doing anything. Assuming that the pointer is not null,
the <tt class="docutils literal">Box</tt> is reconstructed from it inside an <tt class="docutils literal">unsafe</tt> block because <tt class="docutils literal">from_raw()</tt> <a class="reference external" href="https://doc.rust-lang.org/std/boxed/struct.Box.html#method.from_raw">is
unsafe</a>. Importantly, this new Box pointer will go out of scope at the end of the function so that
it will automatically be dropped when the function returns.</p>
<p>Building the library is simple. I run <tt class="docutils literal">cargo build <span class="pre">--release</span></tt> to build a release version. The
library itself will be found at <tt class="docutils literal">target/release/librstruct.so</tt>. On Linux, one can verify that it
contains the <tt class="docutils literal">data_new()</tt> and <tt class="docutils literal">data_free()</tt> methods by displaying its symbols with the <tt class="docutils literal">nm
<span class="pre">-g</span></tt> command:</p>
<pre class="code console"><a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-1"></a><span class="gp">$</span> nm -g target/release/librstruct.so
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-2"></a><span class="gp">#</span> snip
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-3"></a><span class="go">00000000000046c0 T data_free</span>
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-4"></a><span class="go">00000000000044e0 T data_new</span>
<a name="rest_code_a6e2baa52ded42a6a1932c5ec125de45-5"></a><span class="gp">#</span> snip
</pre>
</div>
<div class="section" id="generating-the-header-for-the-library">
<h3>Generating the header for the library</h3>
<p>Now that I have a shared library, I want to access the functions that it exposes from C. To do
this, I first need a header file that I can use to import the library's declarations into the C
code. Moreover, generating the header can help in understanding how Rust translates its data types
to C.</p>
<p>I will use <a class="reference external" href="https://github.com/eqrion/cbindgen">cbindgen</a> to automatically generate the header. <tt class="docutils literal">cbindgen</tt> is installed with the
command</p>
<pre class="code console"><a name="rest_code_ac72fd56120b497b9d8d1c1be7dbf49e-1"></a><span class="gp">$</span> cargo install cbindgen
</pre>
<p><tt class="docutils literal">cbindgen</tt> is highly configurable, but for the project described here I only need its most basic
functionality. Assuming that I am in the root directory of my Rust project, I generate the header
<tt class="docutils literal">rstruct.h</tt> with the following</p>
<pre class="code console"><a name="rest_code_dabad64b9038496cba08a30fc4e7f836-1"></a><span class="gp">$</span> cbindgen --lang C -o rstruct.h .
</pre>
<p>After running <tt class="docutils literal">cbindgen</tt> there is a new file called <tt class="docutils literal">rstruct.h</tt> in the project folder. Here are
its contents:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-1"> 1</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-2"> 2</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-3"> 3</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-4"> 4</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-5"> 5</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-6"> 6</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-7"> 7</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-8"> 8</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-9"> 9</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-10">10</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-11">11</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-12">12</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-13">13</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-14">14</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-15">15</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-16">16</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-17">17</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-18">18</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-19">19</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-20">20</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-21">21</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-22">22</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-23">23</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-24">24</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-25">25</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-26">26</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-27">27</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-28">28</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-29">29</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-30">30</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-31">31</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-32">32</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-33">33</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_b88b49909bea49c7a9bf9730597ecdd9-34">34</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-1"></a><span class="cp">#include</span> <span class="cpf">&lt;stdarg.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-2"></a><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-3"></a><span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-4"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-5"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-6"></a><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-7"></a>  <span class="n">_Int</span><span class="p">,</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-8"></a>  <span class="n">_Float</span><span class="p">,</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-9"></a><span class="p">}</span> <span class="n">Value_Tag</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-10"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-11"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-12"></a>  <span class="kt">int32_t</span> <span class="n">_0</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-13"></a><span class="p">}</span> <span class="n">_Int_Body</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-14"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-15"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-16"></a>  <span class="kt">double</span> <span class="n">_0</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-17"></a><span class="p">}</span> <span class="n">_Float_Body</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-18"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-19"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-20"></a>  <span class="n">Value_Tag</span> <span class="n">tag</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-21"></a>  <span class="k">union</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-22"></a>    <span class="n">_Int_Body</span> <span class="n">_int</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-23"></a>    <span class="n">_Float_Body</span> <span class="n">_float</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-24"></a>  <span class="p">};</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-25"></a><span class="p">}</span> <span class="n">Value</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-26"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-27"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-28"></a>  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-29"></a>  <span class="n">Value</span> <span class="n">value</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-30"></a><span class="p">}</span> <span class="n">RStruct</span><span class="p">;</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-31"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-32"></a><span class="kt">void</span> <span class="nf">data_free</span><span class="p">(</span><span class="n">RStruct</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-33"></a>
<a name="rest_code_b88b49909bea49c7a9bf9730597ecdd9-34"></a><span class="n">RStruct</span> <span class="o">*</span><span class="nf">data_new</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></td>
</tr></table>
<p>First, you can see the <tt class="docutils literal">enum</tt> that contains the variations of the <tt class="docutils literal">Value</tt> data type that is
stored in the <tt class="docutils literal">RStruct</tt> and that was defined in Rust. The name of this new type is <tt class="docutils literal">Value_Tag</tt>,
and it is used to define the current type of a value.</p>
<pre class="code c"><a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-1"></a><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-2"></a>  <span class="n">Value_Tag</span> <span class="n">tag</span><span class="p">;</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-3"></a>  <span class="k">union</span> <span class="p">{</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-4"></a>    <span class="n">_Int_Body</span> <span class="n">_int</span><span class="p">;</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-5"></a>    <span class="n">_Float_Body</span> <span class="n">_float</span><span class="p">;</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-6"></a>  <span class="p">};</span>
<a name="rest_code_1aaaccaac05d4839adbe9f7cff192874-7"></a><span class="p">}</span> <span class="n">Value</span><span class="p">;</span>
</pre>
<p>A <tt class="docutils literal">Value</tt> is just another struct that contains a <tt class="docutils literal">Value_Tag</tt> field to identify which variant of
the <tt class="docutils literal">enum</tt> it is holding and a <tt class="docutils literal">union</tt> field that holds the actual value.</p>
<p>The important thing to understand here is that <tt class="docutils literal">cbindgen</tt> effectively uses nested C data types to
represent complex Rust data structures. In particular, Rust <tt class="docutils literal">enums</tt> are a combination of C
<tt class="docutils literal">structs</tt>, <tt class="docutils literal">enums</tt>, and <tt class="docutils literal">unions</tt>.</p>
</div>
</div>
<div class="section" id="calling-the-library-from-c">
<h2>Calling the library from C</h2>
<p>With everything in place, it's now time to write the C program. My example C program looks like the
following:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-1"> 1</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-2"> 2</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-3"> 3</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-4"> 4</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-5"> 5</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-6"> 6</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-7"> 7</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-8"> 8</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-9"> 9</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-10">10</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-11">11</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-12">12</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-13">13</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-14">14</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-15">15</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-16">16</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-17">17</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-18">18</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-19">19</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-20">20</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-21">21</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-22">22</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-23">23</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-24">24</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-25">25</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-26">26</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-27">27</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-28">28</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-29">29</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-30">30</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-31">31</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-32">32</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-33">33</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-34">34</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-35">35</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-36">36</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-37">37</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-38">38</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-39">39</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-40">40</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-41">41</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-42">42</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-43">43</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-44">44</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-45">45</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-46">46</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-47">47</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-48">48</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-49">49</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-50">50</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-51">51</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-52">52</a>
<a href="posts/complex-data-types-and-the-rust-ffi/#rest_code_8334087a10e5400082a4f596ff8b5e4e-53">53</a></pre></div></td>
<td class="code"><pre class="code c"><a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-1"></a><span class="cp">#include</span> <span class="cpf">&lt;dlfcn.h&gt;</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-2"></a><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-3"></a><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-4"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-5"></a><span class="cp">#include</span> <span class="cpf">"rstruct.h"</span><span class="cp"></span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-6"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-7"></a><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-8"></a>  <span class="kt">void</span><span class="o">*</span> <span class="n">handle</span><span class="p">;</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-9"></a>  <span class="n">RStruct</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">data_new</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-10"></a>  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">data_free</span><span class="p">)(</span><span class="n">RStruct</span><span class="o">*</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-11"></a>  <span class="kt">char</span><span class="o">*</span> <span class="n">error</span><span class="p">;</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-12"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-13"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Loading librstruct.so...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-14"></a>  <span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-15"></a>    <span class="s">"librstruct.so"</span><span class="p">,</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-16"></a>    <span class="n">RTLD_LAZY</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-17"></a>  <span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-18"></a>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-19"></a>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">dlerror</span><span class="p">());</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-20"></a>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-21"></a>  <span class="p">}</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-22"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Done.</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-23"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-24"></a>  <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-25"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-26"></a>  <span class="n">data_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">RStruct</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_new"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-27"></a>  <span class="n">error</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-28"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-29"></a>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-30"></a>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-31"></a>  <span class="p">}</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-32"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-33"></a>  <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-34"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-35"></a>  <span class="n">data_free</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">RStruct</span><span class="o">*</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_free"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-36"></a>  <span class="n">error</span> <span class="o">=</span> <span class="n">dlerror</span><span class="p">();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-37"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-38"></a>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-39"></a>    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-40"></a>  <span class="p">}</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-41"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-42"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Calling data_new() from main.c...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-43"></a>  <span class="n">RStruct</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">data_new</span><span class="p">)();</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-44"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-45"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Back inside main.c. Printing results...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-46"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"Name: %s</span><span class="se">\n</span><span class="s">Value: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">_int</span><span class="p">.</span><span class="n">_0</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-47"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-48"></a>  <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Freeing the RStruct data...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-49"></a>  <span class="p">(</span><span class="o">*</span><span class="n">data_free</span><span class="p">)(</span><span class="n">data</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-50"></a>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-51"></a>  <span class="n">dlclose</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-52"></a>  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<a name="rest_code_8334087a10e5400082a4f596ff8b5e4e-53"></a><span class="p">}</span>
</pre></td>
</tr></table>
<p>This code is based on the example in the <tt class="docutils literal">dlopen()</tt> <a class="reference external" href="https://linux.die.net/man/3/dlopen">man pages</a>. In particular, the library file
is opened and a handle attached to it here:</p>
<pre class="code c"><a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-1"></a><span class="n">handle</span> <span class="o">=</span> <span class="n">dlopen</span><span class="p">(</span>
<a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-2"></a>  <span class="s">"librstruct.so"</span><span class="p">,</span>
<a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-3"></a>  <span class="n">RTLD_LAZY</span>
<a name="rest_code_75b6eb5344ab4584ba11de255bdcc2c9-4"></a><span class="p">);</span>
</pre>
<p>A function pointer to <tt class="docutils literal">data_new()</tt> is created with <tt class="docutils literal">dlsym()</tt>, and we use the function to create
the new <tt class="docutils literal">RStruct</tt> instance with the lines</p>
<pre class="code c"><a name="rest_code_9d098eaff0ac46999a9dc26da0977ae6-1"></a><span class="n">data_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">RStruct</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_new"</span><span class="p">);</span>
<a name="rest_code_9d098eaff0ac46999a9dc26da0977ae6-2"></a><span class="c1">// snip</span>
<a name="rest_code_9d098eaff0ac46999a9dc26da0977ae6-3"></a><span class="n">RStruct</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">data_new</span><span class="p">)();</span>
</pre>
<p>Finally, the data is freed by creating another function pointer to <tt class="docutils literal">data_free()</tt> and calling it.</p>
<pre class="code c"><a name="rest_code_cfc11c485be44561b409afeea33674f4-1"></a><span class="n">data_free</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">RStruct</span><span class="o">*</span><span class="p">))</span> <span class="n">dlsym</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">"data_free"</span><span class="p">);</span>
<a name="rest_code_cfc11c485be44561b409afeea33674f4-2"></a><span class="c1">// snip</span>
<a name="rest_code_cfc11c485be44561b409afeea33674f4-3"></a><span class="p">(</span><span class="o">*</span><span class="n">data_free</span><span class="p">)(</span><span class="n">data</span><span class="p">);</span>
</pre>
<div class="section" id="running-the-program">
<h3>Running the program</h3>
<p>I wrote a small Makefile to handle compilation of the C and Rust programs while I wrote this
post. I won't include it here because it distracts from the main message about the Rust
FFI. Instead, I will describe how to compile the program from the command line.</p>
<p>I first placed the <tt class="docutils literal">librstruct.so</tt>, <tt class="docutils literal">rstruct.h</tt>, and <tt class="docutils literal">main.c</tt> programs into the following
directory structure:</p>
<pre class="code console"><a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-1"></a><span class="gp">$</span> tree
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-2"></a><span class="go">.</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-3"></a><span class="go">├── include</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-4"></a><span class="go">│   └── rstruct.h</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-5"></a><span class="go">├── lib</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-6"></a><span class="go">│   └── librstruct.so</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-7"></a><span class="go">└── src</span>
<a name="rest_code_b9fe2fa483ec4a63910b11cc01c136b4-8"></a><span class="go">    └── main.c</span>
</pre>
<p>Next, I compiled the <tt class="docutils literal">main</tt> binary with gcc.</p>
<pre class="code console"><a name="rest_code_352cf378f2f64574baa4bb2b8fe8a162-1"></a><span class="gp">$</span> gcc -Wall -g -Iinclude -c -o main.o main.c
<a name="rest_code_352cf378f2f64574baa4bb2b8fe8a162-2"></a><span class="gp">$</span> gcc -Wall -g -o main main.o -ldl
</pre>
<p>(<tt class="docutils literal"><span class="pre">-ldl</span></tt> is used to link against libdl for dynamically loading the library from C.) After
compilation I run the <tt class="docutils literal">main</tt> binary. To make it work, I set the <tt class="docutils literal">LD_LIBRARY_PATH</tt> environment
variable so that the program knows to look inside the <tt class="docutils literal">lib</tt> directory for the <tt class="docutils literal">librstruct.so</tt>
library.</p>
<pre class="code console"><a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-1"></a><span class="gp">$</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>lib ./main
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-2"></a><span class="go">Loading librstruct.so...</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-3"></a><span class="go">Done.</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-4"></a>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-5"></a><span class="go">Calling data_new() from main.c...</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-6"></a><span class="go">Inside data_new().</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-7"></a>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-8"></a><span class="go">Back inside main.c. Printing results...</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-9"></a><span class="go">Name: my_rstruct</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-10"></a><span class="go">Value: 42</span>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-11"></a>
<a name="rest_code_be0943b0540b421ea0a59802a0f60cb7-12"></a><span class="go">Freeing the RStruct data...</span>
</pre>
<p>Nice! From the output you can see the print statements that I placed inside both the Rust and C
code to indicate where the program was as it was running. In summary, the program performs the
following sequence of events:</p>
<ul class="simple">
<li>The main binary is run</li>
<li>The <tt class="docutils literal">librstruct.so</tt> library is opened and pointers to the <tt class="docutils literal">data_new()</tt> and <tt class="docutils literal">data_free()</tt>
functions are created</li>
<li>
<tt class="docutils literal">data_new()</tt> is called, creating our Rust datatype on the heap and returning a pointer to it in
the C code</li>
<li>Information about the data type is printed from C</li>
<li>
<tt class="docutils literal">data_free()</tt> is called, freeing the memory from back inside Rust</li>
</ul>
</div>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<p>And that's it! I hope you enjoyed this post. It took me several days of reading and trial-and-error
to learn about this feature of Rust. The topics covered here were</p>
<ul class="simple">
<li>the Rust FFI and its purpose</li>
<li>creating a complex data type (a Rust enum nested inside a Rust struct) and exporting it through
the FFI</li>
<li>
<tt class="docutils literal">Box</tt> and <tt class="docutils literal">CString</tt> Rust data types</li>
<li>
<tt class="docutils literal">cbindgen</tt> for automatically creating header files from Rust code</li>
<li>using the Rust library from inside C</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/a-simple-unix-socket-listener-in-rust/" class="u-url">A simple UNIX socket listener in Rust</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/a-simple-unix-socket-listener-in-rust/" rel="bookmark">
            <time class="published dt-published" datetime="2019-02-24T16:25:58+01:00" itemprop="datePublished" title="2019-02-24 16:25">2019-02-24 16:25</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/a-simple-unix-socket-listener-in-rust/#disqus_thread" data-disqus-identifier="cache/posts/a-simple-unix-socket-listener-in-rust.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>I decided that I wanted to learn a new programming language in 2019. After a bit of research, I
settled upon <a class="reference external" href="https://www.rust-lang.org/">Rust</a> due to its speed, novel ideas about memory safety, and <a class="reference external" href="https://blog.rust-lang.org/2018/03/12/roadmap.html#four-target-domains">focus on two areas
that I am interested in</a>: embedded systems and WebAssembly. While I think that <a class="reference external" href="https://doc.rust-lang.org/book/">The Book</a> is the
best place to get started learning the language, nothing is really a substitute for writing code.</p>
<p>With that in mind, I developed an idea for a starting project: a background daemon for Linux
systems like the Raspberry Pi that controls and reads data from the system's peripherals. The
design of this project is inspired by Docker: a daemon process does most of the heavy work while a
command line tool communicates with the Daemon over a Unix socket (typically a file located at
<tt class="docutils literal">/var/run/docker.sock</tt>). The purpose of this post is to demonstrate the most basic realization of
this: reading text from a UNIX socket in Rust. And to emphasize that the UNIX socket is used for
communication between two separate processes, we will send messages from Bash to Rust.</p>
<p>Keep in mind that this is my first-ever Rust program, so it may not be completely idiomatic
Rust. The following was compiled with rustc 1.32.0 (9fda7c223 2019-01-16).</p>
<p>To begin, I created a new Rust project with <tt class="docutils literal">cargo</tt>.</p>
<pre class="code shell"><a name="rest_code_1ac0529c40624732939d365f9657b3e6-1"></a>$ cargo new rust-uds
<a name="rest_code_1ac0529c40624732939d365f9657b3e6-2"></a>$ <span class="nb">cd</span> rust-uds
</pre>
<p>Next, I opened the file that cargo automatically generated in <tt class="docutils literal">src/main.rs</tt>, removed the
auto-generated content, and added the following code, which is largely based on the <a class="reference external" href="https://doc.rust-lang.org/std/os/unix/net/struct.UnixListener.html#examples">example</a>
provided in the Rust documentation but with a few key differences:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-1"> 1</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-2"> 2</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-3"> 3</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-4"> 4</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-5"> 5</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-6"> 6</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-7"> 7</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-8"> 8</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-9"> 9</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-10">10</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-11">11</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-12">12</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-13">13</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-14">14</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-15">15</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-16">16</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-17">17</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-18">18</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-19">19</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-20">20</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-21">21</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-22">22</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-23">23</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-24">24</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-25">25</a>
<a href="posts/a-simple-unix-socket-listener-in-rust/#rest_code_63f11189760146ffaafa8a373168ef4c-26">26</a></pre></div></td>
<td class="code"><pre class="code rust"><a name="rest_code_63f11189760146ffaafa8a373168ef4c-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">BufRead</span><span class="p">,</span><span class="w"> </span><span class="n">BufReader</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">net</span>::<span class="p">{</span><span class="n">UnixStream</span><span class="p">,</span><span class="n">UnixListener</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-4"></a>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-5"></a><span class="k">fn</span> <span class="nf">handle_client</span><span class="p">(</span><span class="n">stream</span>: <span class="nc">UnixStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">lines</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-8"></a><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-9"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-10"></a><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-11"></a>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-12"></a><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">"/tmp/rust-uds.sock"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-14"></a>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">listener</span><span class="p">.</span><span class="n">incoming</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-16"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-17"></a><span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-18"></a><span class="w">                </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">handle_client</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-19"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-20"></a><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-21"></a><span class="w">                </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-22"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-23"></a><span class="w">            </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-24"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-25"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_63f11189760146ffaafa8a373168ef4c-26"></a><span class="p">}</span><span class="w"></span>
</pre></td>
</tr></table>
<div class="section" id="explanation">
<h2>Explanation</h2>
<p>The first three lines import the necessary modules for this code example.</p>
<pre class="code rust"><a name="rest_code_89c92eb67a9b4302b8ddc395afc1b644-1"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="n">BufRead</span><span class="p">,</span><span class="w"> </span><span class="n">BufReader</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_89c92eb67a9b4302b8ddc395afc1b644-2"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">os</span>::<span class="n">unix</span>::<span class="n">net</span>::<span class="p">{</span><span class="n">UnixStream</span><span class="p">,</span><span class="n">UnixListener</span><span class="p">};</span><span class="w"></span>
<a name="rest_code_89c92eb67a9b4302b8ddc395afc1b644-3"></a><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w"></span>
</pre>
<p><tt class="docutils literal">BufRead</tt> is a trait that enables extra ways of reading data sources; in this case, it has an
internal buffer for reading the socket line-by-line. <tt class="docutils literal">BufReader</tt> is a struct that actually
implements the functionality in <tt class="docutils literal">BufRead</tt>. <tt class="docutils literal">UnixStream</tt> and <tt class="docutils literal">UnixListener</tt> are structs that
provide the functionality for handling the UNIX socket, and the <tt class="docutils literal"><span class="pre">std::thread</span></tt> module is used to
spawn threads.</p>
<p>The next set of lines defines a function named <tt class="docutils literal">handle_client()</tt> that is called whenever new data
arrives in the stream. The explanation for this is best left until after the <tt class="docutils literal">main()</tt> function.</p>
<p>The first line in the <tt class="docutils literal">main()</tt> function creates the UnixListener struct and binds it to the
<tt class="docutils literal">listener</tt> variable.</p>
<pre class="code rust"><a name="rest_code_08622b1f94a34b97b092a438874b4a75-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UnixListener</span>::<span class="n">bind</span><span class="p">(</span><span class="s">"/tmp/rust-uds.sock"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
</pre>
<p>The <tt class="docutils literal">bind()</tt> function takes a string argument that is a path to the socket file and <tt class="docutils literal">unwrap()</tt>
moves the value out of the Result that is returned by <tt class="docutils literal">bind()</tt>. (This is a pattern that is
<a class="reference external" href="https://doc.rust-lang.org/std/option/enum.Option.html#method.unwrap">discouraged</a> in Rust but is OK for quick prototypes because it simplifies the error handling.)</p>
<p>After creating the listener, <tt class="docutils literal">listener.incoming()</tt> returns an iterator over the incoming
connections to the socket. The connections are looped over in an infinite for loop; I believe that
this is more-or-less the same as a generator in Python which never raises a <tt class="docutils literal">StopIteration</tt>
exception.</p>
<p>Next, the <tt class="docutils literal">Result</tt> of the incoming streams is matched; if there is an error, it is printed and
the loop it exited:</p>
<pre class="code rust"><a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-1"></a><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-2"></a><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"Error: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-3"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a name="rest_code_6b902f1cd3d0440b9c7ff54253aa714a-4"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>However, if the <tt class="docutils literal">Result</tt> of the connection is <tt class="docutils literal">Ok</tt>, then a new thread is spawned to handle the
new stream:</p>
<pre class="code rust"><a name="rest_code_4452be9a3e7945d6aa40ca833a2c8015-1"></a><span class="nb">Ok</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_4452be9a3e7945d6aa40ca833a2c8015-2"></a><span class="w">    </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">handle_client</span><span class="p">(</span><span class="n">stream</span><span class="p">));</span><span class="w"></span>
<a name="rest_code_4452be9a3e7945d6aa40ca833a2c8015-3"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>Finally, the client handler is called for each connection.</p>
<pre class="code rust"><a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-1"></a><span class="k">fn</span> <span class="nf">handle_client</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">stream</span>: <span class="nc">UnixStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BufReader</span>::<span class="n">new</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">stream</span><span class="p">.</span><span class="n">lines</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-4"></a><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="rest_code_5635c4196bd54613bf4f6a243c0f0023-6"></a><span class="p">}</span><span class="w"></span>
</pre>
<p>The handler in this case is fairly straight-forward. It shadows the original <tt class="docutils literal">stream</tt> variable by
binding it to a version of itself that has been converted to a <tt class="docutils literal">BufReader</tt>. Finally, it loops
over the <tt class="docutils literal">lines()</tt> iterator, which blocks until a new line appears in the stream.</p>
</div>
<div class="section" id="sending-messages">
<h2>Sending messages</h2>
<p>As an example, let's send messages to the Rust program via Bash using <a class="reference external" href="http://man.openbsd.org/nc">the OpenBSD version of
netcat</a>. (The OpenBSD version seems to be the default on Ubuntu-based systems.) This should
underscore the fact that the UNIX socket is really being used to communicate between two different
processes.</p>
<p>First, compile and run the Rust program to start the socket listener:</p>
<pre class="code text"><a name="rest_code_1f620754abbe490aa93573b1e8975f6f-1"></a>$ cargo run --release
<a name="rest_code_1f620754abbe490aa93573b1e8975f6f-2"></a>   Compiling rust-uds v0.1.0 (/home/kmd/src/rust-uds)
<a name="rest_code_1f620754abbe490aa93573b1e8975f6f-3"></a>    Finished release [optimized] target(s) in 1.59s
<a name="rest_code_1f620754abbe490aa93573b1e8975f6f-4"></a>     Running `target/release/rust-uds`
</pre>
<p>Open up a new terminal. You should see the socket file /tmp/rust-uds.sock:</p>
<pre class="code text"><a name="rest_code_61d72e4f90db4dbc8015a44633dc3213-1"></a>$ ls /tmp | grep rust
<a name="rest_code_61d72e4f90db4dbc8015a44633dc3213-2"></a>rust-uds.sock
</pre>
<p>Now let's send messages to the rust program. Use the following netcat command to open a connection
to the socket.</p>
<pre class="code text"><a name="rest_code_92ea3b055e0442869c07eb9de52a4eb9-1"></a>$ nc -U /tmp/rust-uds.sock
</pre>
<p>The <tt class="docutils literal"><span class="pre">-U</span></tt> is necessary to indicate to netcat that this is a UNIX stream socket. Now, start typing
text into the same window. Every time you press ENTER, you should see the same text appear in the
terminal window in which the Rust program is running. Press CTRL-C to exit the Rust socket
listener. If you re-run the program, delete the old socket first: <tt class="docutils literal">rm <span class="pre">/tmp/rust-uds.sock</span></tt></p>
</div>
<div class="section" id="summary">
<h2>Summary</h2>
<ul class="simple">
<li>Use a <tt class="docutils literal">UnixListener</tt> struct to create a UNIX socket and listen to it for connections.</li>
<li>For each new connection, spawn a new thread and read the stream with a <tt class="docutils literal">BufReader</tt>.</li>
<li>Print each new line in the stream by iterating over the <tt class="docutils literal">lines()</tt> iterator of the
<tt class="docutils literal">BufReader</tt>.</li>
<li>Send commands to your Rust program from bash with <tt class="docutils literal">nc <span class="pre">-U</span> "$PATH_TO_SOCKET"</tt>.</li>
</ul>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/linking-shared-libraries-in-micro-manager-for-linux/" class="u-url">Linking shared libraries in Micro-Manager for Linux</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/linking-shared-libraries-in-micro-manager-for-linux/" rel="bookmark">
            <time class="published dt-published" datetime="2019-01-19T12:00:37+01:00" itemprop="datePublished" title="2019-01-19 12:00">2019-01-19 12:00</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#disqus_thread" data-disqus-identifier="cache/posts/linking-shared-libraries-in-micro-manager-for-linux.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Lately I have been working on a new <a class="reference external" href="https://github.com/kmdouglass/RPi-DeviceAdapters">Video4Linux2 device adapter</a> for <a class="reference external" href="https://micro-manager.org/">Micro-Manager</a>. I
encountered the following error after adding some functionality that introduced two <a class="reference external" href="https://www.boost.org/">Boost
libraries</a> as new dependencies in my project.</p>
<pre class="code shell"><a name="rest_code_02df986928d44e26886a11efd12ce341-1"></a>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
<a name="rest_code_02df986928d44e26886a11efd12ce341-2"></a>  File <span class="s2">"RPiV4L2.py"</span>, line <span class="m">17</span>, in &lt;module&gt;
<a name="rest_code_02df986928d44e26886a11efd12ce341-3"></a>    mmc.loadDevice<span class="o">(</span><span class="s2">"camera"</span>, <span class="s2">"RPiV4L2"</span>, <span class="s2">"RPiV4L2"</span><span class="o">)</span>
<a name="rest_code_02df986928d44e26886a11efd12ce341-4"></a>  File <span class="s2">"/home/micro-manager/app/lib/micro-manager/MMCorePy.py"</span>, line <span class="m">3515</span>, in loadDevice
<a name="rest_code_02df986928d44e26886a11efd12ce341-5"></a>    <span class="k">return</span> _MMCorePy.CMMCore_loadDevice<span class="o">(</span>self, label, moduleName, deviceName<span class="o">)</span>
<a name="rest_code_02df986928d44e26886a11efd12ce341-6"></a>MMCorePy.CMMError: Failed to load device <span class="s2">"RPiV4L2"</span> from adapter module <span class="s2">"RPiV4L2"</span> <span class="o">[</span> Failed to load device adapter <span class="s2">"RPiV4L2"</span> <span class="o">[</span> Failed to load module <span class="s2">"/home/micro-manager/app/lib/micro-manager/libmmgr_dal_RPiV4L2.so.0"</span> <span class="o">[</span> /home/micro-manager/app/lib/micro-manager/libmmgr_dal_RPiV4L2.so.0: undefined symbol: _ZN5boost10filesystem6detail13dir_itr_closeERPvS3_ <span class="o">]</span> <span class="o">]</span> <span class="o">]</span>
</pre>
<p>I received this error when I tried to load the device in a Python script. At first I was puzzled
because the code compiled without problems, but I soon found that the solution was simple.</p>
<p>The key part of the message is <tt class="docutils literal">undefined symbol:
_ZN5boost10filesystem6detail13dir_itr_closeERPvS3_</tt>. To troubleshoot this, I first demangled the
symbol name by entering it at <a class="reference external" href="https://demangler.com/">https://demangler.com/</a>. I discovered that the symbol was referring to
the function <tt class="docutils literal"><span class="pre">boost::filesystem::detail::dir_itr_close(void*&amp;,</span> <span class="pre">void*&amp;)</span></tt>. I had added both the
Boost filesystem and Boost regex libraries to this device adapter as dependencies, so it was not
surprising that either of their names appeared in the error message.</p>
<p>Next, I used the <a class="reference external" href="http://man7.org/linux/man-pages/man1/ldd.1.html">ldd</a> program to check which libraries my device adapter were linked
against. (libmmgr_dal_RPiV4l2.so.0 is the name of the device adapter library file).</p>
<pre class="code shell"><a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-1"></a>$ ldd libmmgr_dal_RPiV4L2.so.0
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-2"></a>     linux-vdso.so.1 <span class="o">(</span>0x7ec21000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-3"></a>     libdl.so.2 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libdl.so.2 <span class="o">(</span>0x76e9c000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-4"></a>     libstdc++.so.6 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libstdc++.so.6 <span class="o">(</span>0x76d54000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-5"></a>     libm.so.6 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libm.so.6 <span class="o">(</span>0x76cdc000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-6"></a>     libc.so.6 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libc.so.6 <span class="o">(</span>0x76bee000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-7"></a>     libgcc_s.so.1 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libgcc_s.so.1 <span class="o">(</span>0x76bc1000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-8"></a>     libicudata.so.57 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libicudata.so.57 <span class="o">(</span>0x75334000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-9"></a>     libicui18n.so.57 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libicui18n.so.57 <span class="o">(</span>0x75187000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-10"></a>     libicuuc.so.57 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libicuuc.so.57 <span class="o">(</span>0x7505e000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-11"></a>     librt.so.1 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/librt.so.1 <span class="o">(</span>0x75048000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-12"></a>     libpthread.so.0 <span class="o">=</span>&gt; /lib/arm-linux-gnueabihf/libpthread.so.0 <span class="o">(</span>0x75024000<span class="o">)</span>
<a name="rest_code_f8dbd5a6b4be4049acdcc6c3b0b209cc-13"></a>     /lib/ld-linux-armhf.so.3 <span class="o">(</span>0x76fb4000<span class="o">)</span>
</pre>
<p>Neither libboost_filesystem nor libboost_regex are listed, so I knew that they were not linked with
the device adapter.</p>
<p>There is a Makefile.am included in the directory of every device adapter in the Micro-Manager
project. This file is used by Autotools define how the device adapter should be compiled and
linked. Here is what my Makefile.am looked like:</p>
<table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-1">1</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-2">2</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-3">3</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-4">4</a>
<a href="posts/linking-shared-libraries-in-micro-manager-for-linux/#rest_code_00c81f3febaa4837baf55d9bec9ab8e9-5">5</a></pre></div></td>
<td class="code"><pre class="code Makefile"><a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-1"></a><span class="nv">AM_CXXFLAGS</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_CXXFLAGS<span class="k">)</span>
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-2"></a><span class="nv">deviceadapter_LTLIBRARIES</span> <span class="o">=</span> libmmgr_dal_RPiV4L2.la
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-3"></a><span class="nv">libmmgr_dal_RPiV4L2_la_SOURCES</span> <span class="o">=</span> RPiV4L2.cpp RPiV4L2.h refactor.h ../../MMDevice/MMDevice.h ../../MMDevice/DeviceBase.h
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-4"></a><span class="nv">libmmgr_dal_RPiV4L2_la_LIBADD</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_LIBADD<span class="k">)</span>
<a name="rest_code_00c81f3febaa4837baf55d9bec9ab8e9-5"></a><span class="nv">libmmgr_dal_RPiV4L2_la_LDFLAGS</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_LDFLAGS<span class="k">)</span>
</pre></td>
</tr></table>
<p>After experimenting a bit, I discovered that I could instruct the linker to link against shared
libraries by adding them to the <tt class="docutils literal">libmmgr_dal_RPiV4L2_la_LDFLAGS</tt> variable with the <tt class="docutils literal"><span class="pre">-l</span></tt>
flag. The resulting line now looks like:</p>
<pre class="code Makefile"><a name="rest_code_ca9552344c1245cc91c80ec3737a83d8-1"></a><span class="nv">libmmgr_dal_RPiV4L2_la_LDFLAGS</span> <span class="o">=</span> <span class="k">$(</span>MMDEVAPI_LDFLAGS<span class="k">)</span> -lboost_regex -lboost_filesystem
</pre>
<p>Finally, running <tt class="docutils literal">ldd</tt> on the rebuilt device adapter now shows these two libraries:</p>
<pre class="code shell"><a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-1"></a>$ ldd libmmgr_dal_RPiV4L2.so.0
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-2"></a>     linux-vdso.so.1 <span class="o">(</span>0x7ed74000<span class="o">)</span>
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-3"></a>     libboost_regex.so.1.62.0 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libboost_regex.so.1.62.0 <span class="o">(</span>0x76e3c000<span class="o">)</span>
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-4"></a>     libboost_filesystem.so.1.62.0 <span class="o">=</span>&gt; /usr/lib/arm-linux-gnueabihf/libboost_filesystem.so.1.62.0 <span class="o">(</span>0x76e1b000<span class="o">)</span>
<a name="rest_code_6daa273d04d74cfaae49c56c46a05fbf-5"></a>     ...
</pre>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-2/" class="u-url">Create a custom Raspbian image with pi-gen: part 2</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-2/" rel="bookmark">
            <time class="published dt-published" datetime="2018-07-24T18:25:26+02:00" itemprop="datePublished" title="2018-07-24 18:25">2018-07-24 18:25</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-2/#disqus_thread" data-disqus-identifier="cache/posts/create-a-custom-raspbian-image-with-pi-gen-part-2.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>In my <a class="reference external" href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/">previous post</a>, I discussed how to setup user accounts and
locales in a custom Raspbian image using pi-gen. In this follow-up
post, I will discuss the main problems that I want to solve:
automatically configuring the wireless network and ssh on a new
Raspberry Pi without a terminal attached directly to the Pi.</p>
<div class="section" id="set-up-the-wireless-network">
<h2>Set up the wireless network</h2>
<div class="section" id="the-wpa-supplicant">
<h3>The WPA supplicant</h3>
<p>The Pi's wireless credentials are configured in stage 2 in the file
<strong>stage2/02-net-tweaks/files/wpa_supplicant.conf</strong>. Here's how it
looks by default:</p>
<pre class="literal-block">
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
</pre>
<p>According to the blogs <a class="reference external" href="https://learnthinksolvecreate.wordpress.com/2017/07/25/pi-gen-setting-default-wifi-settings/">Learn Think Solve Create</a> and the <a class="reference external" href="https://www.raspberrypi-spy.co.uk/2017/04/manually-setting-up-pi-wifi-using-wpa_supplicant-conf/">Raspberry
Spy</a>, the first thing we should do is add our country code to the top
of this file with the line <cite>country=CH</cite>. (Use your own country code
for this.) Next, we want to enter the details for our wireless
network, which includes its name and the password. For security
reasons that I hope are obvious, we should not store the password in
this file. Instead, we create a hash of the password and put that
inside the file. The command to create the password hash is</p>
<pre class="code shell"><a name="rest_code_89a8d4ccb392450a8c4277b923f54354-1"></a>wpa_passphrase ESSID PASSWORD &gt; psk
</pre>
<p>where ESSID is our wireless network's name. Note that I also used a
space before the <code class="shell">wpa_passphrase</code> command to prevent the
password being written to my .bash_history file. Now, we copy and
paste the contents of the file <strong>psk</strong> into the wpa_supplicant.conf
and remove the comment that contains the actual password:</p>
<pre class="literal-block">
country=CH
ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
network={
        ssid=YOUR_ESSID_HERE
        psk=YOUR_PSK_HASH_HERE
}
</pre>
</div>
<div class="section" id="configure-the-wireless-network-interfaces">
<h3>Configure the wireless network interfaces</h3>
<p>After having configured the supplicant, we next move on to configuring
the network interfaces used by Raspbian. The appropriate file is found
in <strong>stage1/02-net-tweaks/files/interfaces</strong>. In my post <a class="reference external" href="posts/connecting-a-raspberry-pi-to-a-home-linux-network/">Connecting a
Raspberry Pi to a Home Linux Network</a> I described how to set up the
network interfaces by editing <strong>/etc/network/interfaces</strong>. Much of the
information presented in that post has now been superseded in Raspbian
by the DHCP daemon. For now, we will use the interfaces file to
instruct our Pi to use DHCP and will use <strong>/etc/dhcpcd.conf</strong> at a
later time to set up a static IP address when provisioning the Pi.</p>
<p>We first need to make a few changes to make the interfaces file aware
of the credentials in the wpa supplicant configuration file. According
to the blog <a class="reference external" href="https://kerneldriver.wordpress.com/2012/10/21/configuring-wpa2-using-wpa_supplicant-on-the-raspberry-pi/">kerneldriver</a>, we need modify the
/etc/networe/interfaces file as such:</p>
<pre class="literal-block">
auto lo

iface lo inet loopback
iface eth0 inet dhcp

auto wlan0
iface wlan0 inet manual
     wpa-roam /etc/wpa_supplicant/wpa_supplicant.conf
iface default inet dhcp
</pre>
<p>In the first modification, I specify that I want the wirless interface
<strong>wlan0</strong> started automatically with <cite>auto wlan0</cite>. Next, I specify
that the wlan0 interface should use the <a class="reference external" href="https://manpages.debian.org/stretch/ifupdown/interfaces.5.en.html#The_manual_Method">manual inet address family</a>
with the line <cite>iface wlan0 inet manual</cite>.</p>
<p>According to the man pages, "[the manual] method may be used to define
interfaces for which no configuration is done by default." After this
we use the <cite>wpa-roam</cite> command to specify the location of the
wpa_supplicant.conf file that we previously modified. The wireless
ESSID and password are therefore not defined in interfaces, but rather
reference them inside wpa_supplicant.conf.</p>
<p>In case you noticed that wpa-roam doesn't appear as an option in
documentation on the interfaces file and were wondering why, it's
because other programs like wpasupplicant may provide additional
options to the interfaces file. A similar command is <cite>wpa-conf</cite>, but I
do not quite yet understand the difference between these two commands.</p>
<p>Following the wpa-roam command, we configure the default options for
all networks in our wpa_supplicant.conf file with the line <cite>iface
default inet dhcp</cite>. At this point, we save the setup of the static IP
address for a later time.</p>
<p>For more information, see <a class="reference external" href="https://manpages.debian.org/stretch/ifupdown/interfaces.5.en.html">the interfaces man page for Debian
Stretch</a>.</p>
</div>
<div class="section" id="change-the-hostname">
<h3>Change the hostname</h3>
<p>Our Pi's hostname may be changed from the default (raspberrypi) by
modifying the line in <strong>stage1/02-net-tweaks/files/hostname</strong>. See
<a class="reference external" href="https://tools.ietf.org/html/rfc1178">RFC 1178</a> for tips on choosing a hostname.</p>
<p>In addition to modifying the hostname file, we need to update
<strong>stage1/02-net-tweaks/00-patches/01-hosts.diff</strong> and change
raspberrypi to the new hostname:</p>
<pre class="literal-block">
Index: jessie-stage1/rootfs/etc/hosts
===================================================================
--- jessie-stage1.orig/rootfs/etc/hosts
+++ jessie-stage1/rootfs/etc/hosts
@@ -3,3 +3,4 @@
 ff02::1                ip6-allnodes
 ff02::2                ip6-allrouters

+127.0.1.1      NEW_HOSTNAME_HERE
</pre>
</div>
<div class="section" id="set-the-dns-servers">
<h3>Set the DNS servers</h3>
<p>DNS servers are configured in
<strong>export-image/02-network/files/resolv.conf</strong>. By default, mine was
already configured to use one of Google's DNS servers (8.8.8.8). I
added a secondary Google DNS address as well:</p>
<pre class="literal-block">
nameserver 8.8.8.8
nameserver 8.8.4.4
</pre>
</div>
</div>
<div class="section" id="enable-ssh">
<h2>Enable SSH</h2>
<p>Enabling SSH is simple. Open <strong>stage2/01-sys-tweaks/01-run.sh</strong> and
change the line <code class="shell">systemctl disable ssh</code> to <code class="shell">systemctl
<span class="nb">enable</span> ssh</code>.</p>
<p>(I later learned that we can also enable ssh on a headless pi by
adding an empty file named <strong>ssh</strong> to the boot partition of a standard
Raspbian image. See here for more details:
<a class="reference external" href="https://www.raspberrypi.org/documentation/remote-access/ssh/">https://www.raspberrypi.org/documentation/remote-access/ssh/</a>)</p>
<div class="section" id="configuring-ssh-keys-or-not">
<h3>Configuring SSH keys (or not)</h3>
<p>I decided after writing much of this tutorial that pi-gen was not
necessarily the best tool for adding my public SSH keys. So long as I
have network access and SSH enabled, I can easily add my keys using
<code class="shell">ssh-copy-id</code>. Furthermore, after following this tutorial,
there still remains a lot of setup and customization steps. These can
more easily be performed manually or by server automation tools like
<a class="reference external" href="http://www.fabfile.org/">Fabric</a> or <a class="reference external" href="https://www.ansible.com/">Ansible</a>.</p>
<p>Therefore, I think that at this point we can stop with our
customization of the image with pi-gen and move to a different
tool. We have a basic Raspbian image that is already configured for
our home network and that serves as a starting point for more complete
customization.</p>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>This tutorial and my <a class="reference external" href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/">previous post</a> demonstrated how to create a
custom Raspbian image that is pre-configured for</p>
<ul class="simple">
<li>our home wireless network</li>
<li>our locale information</li>
<li>ssh</li>
</ul>
<p>Of course, we can do much, much more with pi-gen, but other tools
exist for the purpose of configuring a server. These tutorials at
least allow you to setup a new Raspberry Pi without having to manually
configure its most basic functionality. Happy Pi'ing!</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/" class="u-url">Create a custom Raspbian image with pi-gen: part 1</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/" rel="bookmark">
            <time class="published dt-published" datetime="2018-07-21T12:31:28+02:00" itemprop="datePublished" title="2018-07-21 12:31">2018-07-21 12:31</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/create-a-custom-raspbian-image-with-pi-gen-part-1/#disqus_thread" data-disqus-identifier="cache/posts/create-a-custom-raspbian-image-with-pi-gen-part-1.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Docker has been an amazing tool for improving my development
efficiency on the Raspberry Pi. For example, I recently used it to
<a class="reference external" href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/">cross-compile a large C++ and Python library</a> for the Pi's ARM
architecture on my x86_64 laptop. However, in that post I took it for
granted that I had already set up my Raspberry Pi with user accounts,
packages, ssh keys, etc. Performing these steps manually on a fresh
install of the Pi's <a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> operating system can become tedious,
especially because ssh needs to be manually enabled before doing any
remote work.</p>
<p>Fortunately, the Raspberry Pi developers have provided us with
<a class="reference external" href="https://github.com/RPi-Distro/pi-gen">pi-gen</a>, a useful collection of Shell scripts and a Docker container
for creating custom Raspbian images. In this post, I will summarize
the steps that I take in using pi-gen to create my own, personalized
Raspbian image.</p>
<p><em>After I wrote this post, I found a set of posts at</em> <a class="reference external" href="https://learnthinksolvecreate.wordpress.com/category/raspberry-pi/pi-gen/">Learn Think
Solve Create</a> <em>that describe many of the tasks I explain here. Be
sure to check them out for another take on modifying Raspbian images.</em></p>
<div class="section" id="clone-the-pi-gen-repository">
<h2>Clone the pi-gen repository</h2>
<p>This is as easy as cloning the git repository.</p>
<pre class="code shell"><a name="rest_code_db419c32ee174b79bcf51fa6499e641c-1"></a>git clone git@github.com:RPi-Distro/pi-gen.git
</pre>
<p>Alternatively, you can use the https address instead of ssh, which is
<a class="reference external" href="https://github.com/RPi-Distro/pi-gen.git">https://github.com/RPi-Distro/pi-gen.git</a>.</p>
<p>From now on, all directories in this post will be relative to the root
pi-gen directory.</p>
</div>
<div class="section" id="build-the-official-raspbian-images">
<h2>Build the official Raspbian images</h2>
<p>By default, the pi-gen repository will build the official Raspbian
images. Doing this once before making any modifications is probably a
good idea; if you can't build the official images, how will you be
able to build a custom image?</p>
<p>There are two main scripts that you can use to do this: <strong>build.sh</strong>
and <strong>build-docker.sh</strong>. build.sh requires you to install the packages
that are listed in the repository's README.md file, whereas
build-docker.sh requires only that you have Docker already installed
on your computer. I'm going to be using the Docker-based build script
for the rest of this post. If you don't have Docker installed on your
system, you can <a class="reference external" href="https://docs.docker.com/install/">follow the instructions here</a> for the community
edition.</p>
<div class="section" id="name-your-image">
<h3>Name your image</h3>
<p>First we need to give a name to our image, even if we use the default
build. To do this, we assign a name to a variable called <strong>IMG_NAME</strong>
inside a file called <strong>config</strong> that is located inside the root pi-gen
folder.</p>
<pre class="code shell"><a name="rest_code_cac3bac8a65b4d589474934b67cbd8d0-1"></a><span class="nb">echo</span> <span class="s2">"IMG_NAME=my_name"</span> &gt; config
</pre>
</div>
<div class="section" id="build-the-default-image">
<h3>Build the default image</h3>
<p>Once we've named our image, we can go ahead and run the build script.</p>
<pre class="code shell"><a name="rest_code_44c57045177a40a0bc8a08b56f00bd61-1"></a>./build-docker.sh
</pre>
<p>Be prepared to wait a while when running this script; the full build
took well over half an hour on my laptop and with the Docker volume
located on a SSD. It also consumed several GB of space on the SSD.</p>
<div class="section" id="resuming-a-failed-build">
<h4>Resuming a failed build</h4>
<p>The first time I used pi-gen the build failed twice. Once, it hung
without doing anything for several minutes, so I canceled it with a
<strong>Ctrl-C</strong> command. The other time I encountered a hash error when
installing a Debian package.</p>
<p>We can resume a failed build from the point of failure by assigning
the value 1 to the CONTINUE variable when calling build-docker.sh
again.</p>
<pre class="code shell"><a name="rest_code_fd6fe9df7b224f48b1736e341ae377dc-1"></a><span class="nv">CONTINUE</span><span class="o">=</span><span class="m">1</span> ./build-docker.sh
</pre>
<p>If we don't want to run previously built stages, we can simply place a
file inside the corresponding folder named SKIP. For example, if our
build fails at stage2, we can place SKIP files inside the stage0 and
stage1 folders, then rerun the build-docker.sh script with
CONTINUE=1.</p>
<p>Unfortunately, I have sometimes noticed that I have to also rebuild
the stage <em>prior</em> to the one where the build failed. In the worst
case, I had to rebuild all the stages because the fixes I applied to a
file in stage2 were not accounted for when I tried to skip building
stages 0 and 1. YMMV with this; I have no idea how well the SKIP
mechanism works for the normal build.sh script.</p>
<p>After a successful build, we can find our custom images located inside
the <strong>deploy</strong> folder of the pi-gen directory. These may then be
written onto a SD card and used as a standard Raspbian image.</p>
<p>We can ensure that the build container is preserved even after successful
builds using</p>
<pre class="code shell"><a name="rest_code_e379a9311cf54c33806ff733d2694d97-1"></a><span class="nv">PRESERVE_CONTAINER</span><span class="o">=</span><span class="m">1</span> ./build-docker.sh
</pre>
</div>
</div>
</div>
<div class="section" id="custom-raspbian-images">
<h2>Custom Raspbian images</h2>
<p>Now that we've got the default build working, let's start by
customizing the build process. For this post, I have the following
goals:</p>
<ul class="simple">
<li>Build only the <em>lite</em> version of the Raspbian images</li>
<li>Add a custom user account and delete the default <em>pi</em> account</li>
<li>Set the Pi's locale information</li>
</ul>
<p>In a follow-up post, I will discuss the following:</p>
<ul class="simple">
<li>Setup the WiFi for a home network</li>
<li>Setup ssh so that we can log on to the Pi remotely on its first
startup</li>
</ul>
<div class="section" id="building-just-raspbian-lite">
<h3>Building just Raspbian Lite</h3>
<p>Raspbian Lite is a <a class="reference external" href="https://raspberrypi.stackexchange.com/questions/39932/differences-between-raspbian-jessie-and-raspbian-jessie-lite#39933">minimal Raspbian image</a> without the X windows
server and speciality modules that would otherwise make Raspbian more
user friendly. It's an ideal starting point for projects that are
highly specialized, require only a few packages, and do not require a
GUI.</p>
<p>pi-gen creates Raspbian images in sequential steps called stages. At
the time of this writing, there were five stages, with stages 2, 4,
and 5 producing images of the operating system. Building everything
from stage 0 up to and including stage 2 produces a Raspbian Lite
image. We can speed up the build process and save harddrive space by
disabling all the later stages.</p>
<p>To disable the build for a particular a stage, we add an empty file
called <strong>SKIP</strong> inside the corresponding stage folder of the pi-gen
root directory, just as we did above when skipping previously built
stages. We also disable the explicit creation of images by adding an
empty file called <strong>SKIP_IMAGES</strong> to stages 4 and 5. (We don't need to
add a SKIP_IMAGES file to the stage3 folder because no image is
produced at this stage.)</p>
<pre class="code shell"><a name="rest_code_990994ad730949059c3ae65fd240c93d-1"></a>touch ./stage3/SKIP ./stage4/SKIP ./stage5/SKIP
<a name="rest_code_990994ad730949059c3ae65fd240c93d-2"></a>touch ./stage4/SKIP_IMAGES ./stage5/SKIP_IMAGES
</pre>
<p>Now, when we run build-docker.sh, pi-gen will only build and produce
one image for Raspbian Lite in the deploy directory.</p>
</div>
<div class="section" id="add-a-custom-user-account">
<h3>Add a custom user account</h3>
<p>The default user in Raspbian is called <strong>pi</strong>. This account is created
in stage1 in the the script <strong>stage1/01-sys-tweaks/00-run.sh</strong>. This
account is not very secure because it and its password, <em>raspberry</em>,
are the well-known defaults in Raspbian. Let's go ahead and change
them.</p>
<p>The relevant lines in the script look like this:</p>
<pre class="code shell"><a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-1"></a>on_chroot <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-2"></a><span class="s">if ! id -u pi &gt;/dev/null 2&gt;&amp;1; then</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-3"></a><span class="s">     adduser --disabled-password --gecos "" pi</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-4"></a><span class="s">fi</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-5"></a><span class="s">echo "pi:raspberry" | chpasswd</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-6"></a><span class="s">echo "root:root" | chpasswd</span>
<a name="rest_code_f342c92a6d6c4693ad1676a0ec27cfc1-7"></a><span class="s">EOF</span>
</pre>
<p>The user pi is created with the line
<code class="shell">adduser --disabled-password --gecos <span class="s2">""</span> pi</code> if it doesn't
already exist. According to the <a class="reference external" href="http://manpages.ubuntu.com/manpages/trusty/man8/adduser.8.html">adduser man pages</a>
The --disabled-password flag prevents the program passwd from setting
the account's password when adduser is run, but remote logins without
password authentication to the pi account are still allowed. the
<code class="shell">--gecos <span class="s2">""</span></code> flag simply adds an empty string to the
/etc/passwd file for the pi account.</p>
<p>After the user is created, <em>raspberry</em> is set as pi's password and
<em>root</em> is set as the root password in the lines <code class="shell"><span class="nb">echo</span>
<span class="s2">"pi:raspberry"</span> <span class="p">|</span> chpasswd</code> and <code class="shell"><span class="nb">echo</span> <span class="s2">"root:root"</span> <span class="p">|</span> chpasswd</code>.</p>
<p>Let's start by modifying the pi account. For the sake of this example,
let's change its name to alphapi. For the password, we will generate a
<strong>temporary, random</strong> password and write it to a file in the deploy
directory. We'll do the same for root. The modifications look like the
following:</p>
<pre class="code shell"><a name="rest_code_fbc787ef08fb44148b681cb15056f252-1"></a><span class="nv">user_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-2"></a><span class="nv">root_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-3"></a>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-4"></a><span class="c1"># Write passwords to a file.</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-5"></a>cat <span class="s">&lt;&lt;EOF &gt; /pi-gen/deploy/users</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-6"></a><span class="s">${user_passwd}</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-7"></a><span class="s">${root_passwd}</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-8"></a><span class="s">EOF</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-9"></a>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-10"></a>on_chroot <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-11"></a><span class="s">if ! id -u alphapi &gt;/dev/null 2&gt;&amp;1; then</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-12"></a><span class="s">     adduser --disabled-password --gecos "" alphapi</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-13"></a><span class="s">fi</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-14"></a><span class="s">echo "alphapi:${user_passwd}" | chpasswd</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-15"></a><span class="s">echo "root:${root_passwd}" | chpasswd</span>
<a name="rest_code_fbc787ef08fb44148b681cb15056f252-16"></a><span class="s">EOF</span>
</pre>
<p>The first two lines create random alphanumeric passwords for the users
alphapi and root. They should be changed immediately when the image is
first run.</p>
<pre class="code shell"><a name="rest_code_4e749f4c258b4dc5afda8e0a906eb803-1"></a><span class="nv">user_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
<a name="rest_code_4e749f4c258b4dc5afda8e0a906eb803-2"></a><span class="nv">root_passwd</span><span class="o">=</span><span class="k">$(</span>&lt; /dev/urandom tr -dc _A-Z-a-z-0-9 <span class="p">|</span> head -c<span class="si">${</span><span class="nv">1</span><span class="k">:-</span><span class="nv">8</span><span class="si">}</span><span class="k">)</span>
</pre>
<p>This way of password generation works by reading random bytes from
/dev/urandom and redirecting them to the standard input of the tr
command, which filters the input so only alphanumeric characters
remain. Next, the output is piped to the head command, which outputs
only the first eight alphanumeric characters produced in this fashion.</p>
<p>The passwords are then written to a file named <strong>users</strong> inside the
deploy directory where the outputs will eventually be placed.</p>
<pre class="code shell"><a name="rest_code_bba80531265646e4bda4259e7755a514-1"></a><span class="c1"># Write passwords to a file.</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-2"></a>cat <span class="s">&lt;&lt;EOF &gt; /pi-gen/deploy/users</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-3"></a><span class="s">${user_passwd}</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-4"></a><span class="s">${root_passwd}</span>
<a name="rest_code_bba80531265646e4bda4259e7755a514-5"></a><span class="s">EOF</span>
</pre>
<p>The remaining parts of the script are more-or-less the same as before,
except I changed pi to alphapi and used variable substitution for the
passwords.</p>
<p>Running ./build-docker.sh at this point will raise an error in stage02
because it's at this stage where the user pi is added to the various
groups on the system. We therefore need to open
<strong>stage2/01-sys-tweaks/01-run.sh</strong> and modify the following lines,
replacing pi with alphapi.</p>
<pre class="code shell"><a name="rest_code_7d3b5f0a9ce949949be9de68b5a6e323-1"></a><span class="k">for</span> GRP in adm dialout cdrom audio users sudo video games plugdev input gpio spi i2c netdev<span class="p">;</span> <span class="k">do</span>
<a name="rest_code_7d3b5f0a9ce949949be9de68b5a6e323-2"></a>    adduser alphapi <span class="nv">$GRP</span>
<a name="rest_code_7d3b5f0a9ce949949be9de68b5a6e323-3"></a><span class="k">done</span>
</pre>
</div>
<div class="section" id="set-the-locale-information">
<h3>Set the locale information</h3>
<p>The locale information used by your operating system may be modified
as follows. Open <strong>stage0/01-locale/00-debconf</strong>. I personally changed
every occurence of en_GB.UTF-8 to en_US.UTF-8, but you can set your
locale accordingly.</p>
<pre class="code shell"><a name="rest_code_be5df10afbc9427ca4da70e476c69892-1"></a><span class="c1"># Locales to be generated:</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-2"></a><span class="c1"># Choices: All locales, aa_DJ ISO-8859-1, aa_DJ.UTF-8 UTF-8, ...</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-3"></a>locales locales/locales_to_be_generated multiselect en_US.UTF-8 UTF-8
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-4"></a><span class="c1"># Default locale for the system environment:</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-5"></a><span class="c1"># Choices: None, C.UTF-8, en_US.UTF-8</span>
<a name="rest_code_be5df10afbc9427ca4da70e476c69892-6"></a>locales locales/default_environment_locale   <span class="k">select</span>  en_US.UTF-8
</pre>
<p>Next, we open <strong>stage2/01-sys-tweaks/00-debconf</strong>. I currently live in
Europe, so I made the following changes:</p>
<pre class="literal-block">
tzdata        tzdata/Areas    select  Europe
</pre>
<p>I also made the following changes to switch from the default British
English to American English:</p>
<pre class="code shell"><a name="rest_code_c015bf5c41cb4d11808ed86bad8bfee5-1"></a>keyboard-configuration keyboard-configuration/xkb-keymap <span class="k">select</span> us
<a name="rest_code_c015bf5c41cb4d11808ed86bad8bfee5-2"></a>keyboard-configuration keyboard-configuration/fvariant  <span class="k">select</span>  English <span class="o">(</span>US<span class="o">)</span> - English <span class="o">(</span>US<span class="se">\,</span> international with dead keys<span class="o">)</span>
</pre>
<p>Note that the comment in 00-debconf above the
keyboard-configuration/xkb-keymap line erroneously states that
American English is an option, but it's not. You need to change it
from "gb" to "us" if you want the American layout.</p>
</div>
</div>
<div class="section" id="using-the-custom-image">
<h2>Using the custom image</h2>
<p>With all these changes, we can build our new image by running
<code class="shell">./build-docker.sh</code> and, if successful, find a .zip file inside
the deploy directory with the image name and date.</p>
<p>To use this image, we unzip the file to extract the .img file inside
it. Next, we need to copy it onto a SD card that will plug into the
pi. I have a SD card reader/writer on my laptop for which I check for
its Linux device name by running <code class="shell">lsblk</code> before and after
plugging in the card. (The device that appears in the output of lsblk
after plugging it in is its name, which is <strong>/dev/mmcblk0</strong> on my
laptop). Once I get its device name, I use the Linux <code class="shell">dd</code>
command to copy the contents of the image onto the card. (Be sure to
change /dev/mccblk0 to match the name that your system gives to your
SD card device.)</p>
<pre class="code shell"><a name="rest_code_f7693cac2fa34488bc491db627f3c064-1"></a>sudo dd <span class="k">if</span><span class="o">=</span><span class="m">2018</span>-07-21-my_name-lite.img <span class="nv">of</span><span class="o">=</span>/dev/mmcblk0 <span class="nv">bs</span><span class="o">=</span><span class="m">4096</span><span class="p">;</span> sync
</pre>
<p><strong>Please be EXTREMELY careful that you get the device name right.</strong>
It's not very difficult to write the contents of the image file over
your root partition or other important data.</p>
<p>After writing the image, we can plug the SD card into our pi, boot it
up, and try logging in as alphapi with the random password that was
created in the users file. <strong>Be sure at this point to change your
user's and root's password</strong>. We can also verify that the keyboard was
set to US English by typing Shift-3 and observing whether we get a
hashtag (#) symbol and not the symbol for the British pound currency.</p>
<p>In a follow-up post, I will describe how to setup the network and SSH
so I can continue to setup my Raspberry Pi without ever needing a
terminal.</p>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/" class="u-url">How I built a cross-compilation workflow for the Raspberry Pi</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/" rel="bookmark">
            <time class="published dt-published" datetime="2018-04-29T12:10:26+02:00" itemprop="datePublished" title="2018-04-29 12:10">2018-04-29 12:10</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi/#disqus_thread" data-disqus-identifier="cache/posts/how-i-built-a-cross-compilation-workflow-for-the-raspberry-pi.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p>Some of you may know I tinker with the Raspberry Pi in my free time
and that one of my current projects is to build a lensless microscope
with the Pi as the brains. To control the microscope, I decided a
while ago that I would use <a class="reference external" href="https://micro-manager.org/wiki/Micro-Manager">Micro-Manager</a>, an open-source
software package for microscope control. I made this decision for a
few reasons:</p>
<ol class="arabic simple">
<li>I already knew the Micro-Manager codebase since I use it frequently
at work.</li>
<li>The Micro-Manager core provides a device-independent interface to
hardware.</li>
<li>I've contributed to the project in the past and feel a sense of
loyalty to the project and the people involved. Expanding
Micro-Manager into embedded microscopy would be a great way for me
to give back to the community.</li>
</ol>
<p>Building Micro-Manager from source code presents its own set of
challenges. After ensuring that you have the correct build
environment, you need to actually compile it, and here's where things
get tricky in Raspyberry Pi development. The Pi has an ARM processor,
whereas most laptops and workstations use a x86_64 processor. This
means that code compiled on a typical desktop PC will not work on the
Pi. As I showed in <a class="reference external" href="https://kmdouglass.github.io/posts/micro-manager-on-the-raspberry-pi.html">my earlier post</a>,
you can compile the code directly on the Pi to circumvent this, but
this unfortunately is quite cumbersome because the code base and
dependencies are quite large. (They are nearly 8 GB in
total). Furthermore, compiling the project on the Pi is slow and
requires connecting to it via ssh or working directly on a TV screen
or monitor.</p>
<p>These problems extend beyond Micro-Manager to other large-scale
projects that require code compilation for a specific processor
architecture. In this post, I'll describe the workflow that I
developed for cross-compiling projects for the Raspberry Pi.</p>
<div class="section" id="previous-attempts">
<h2>Previous attempts</h2>
<p>Prior to the workflow that is the main topic of this post, I managed
to cross-compile Micro-Manager using a <cite>chroot</cite> environment and the
<a class="reference external" href="https://www.qemu.org/">QEMU emulator</a>. <a class="reference external" href="https://en.wikipedia.org/wiki/Chroot">chroot</a> is a Linux command that
changes the apparent root (or '/') directory for a running
process. With this approach, I mount an image of the <a class="reference external" href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian
operating system</a>
that contains the gcc and g++ compilers and libraries for the ARM
architecture. Then, I chroot into the image and run a setup script
that builds the software. During execution of this script, the QEMU
static libraries run the ARM compilers from within the chroot
environment to build the project. The compiled code remains inside the
image, which I then burn onto a micro SD card to insert into the Pi. I
uploaded <a class="reference external" href="https://gist.github.com/kmdouglass/38e1383c7e62745f3cf522702c21cb49">a gist of the bash script</a>
which orchestrates all this, and my inspiration for this approach came
from a great series of blog posts from <a class="reference external" href="https://disconnected.systems/blog/custom-rpi-image-with-github-travis/">Disconnected Systems</a>.</p>
<p>Ultimately this approach is a huge amount of work. As you can see in
the gist, it's fairly complicated bash scripting that's not easy to
debug. Furthermore, the setup script that is run inside the image
needs to do a lot of work beyond cross-compiling, like setting up the
user, permissions, network, etc. Debugging the final product is also a
challenge because you need to verify that it's working on the Pi,
which requires burning the image to a micro SD card.</p>
</div>
<div class="section" id="cross-compiling-with-docker">
<h2>Cross-compiling with Docker</h2>
<p>After a bit of research I decided I would try instead to use <a class="reference external" href="https://www.docker.com/">Docker</a> for cross-compilation and deployment to
the Pi. I had just started using Docker at work to build reproducible
environments for scientific computing research. In particular, and
unlike my chroot script, I had learned that a Docker container that
built the project could work on nearly any system that had Docker
installed. Furthermore, deploying updates can be done on any Raspberry
Pi that's running Docker.</p>
<p>I liked the idea of a portable cross-compilation workflow, so I dove
into the Docker documentation and managed to get everything working in
a few weeks of tinkering at home.</p>
<div class="section" id="an-overview-of-docker">
<h3>An overview of Docker</h3>
<p>You can find many resources online about Docker, so I won't go into
the details here. The main thing you need to know is that Docker is a
system for creating, running, and sharing <em>containers</em>, which are
something like light weight virtual machines. Containers solve the
problem in software development of how to build and deploy programs
that have a complex set of dependencies. It does this by isolating the
environment in which a program runs from the rest of the operating
system. For example, if you have a computer that has a certain version
of gcc (the GNU C compiler) installed, but your application requires a
different version, then you can install the required gcc along with
your application inside a container and they will not interfere with
the version of gcc that belongs to your operating system. This also
means that you can send your container to any machine that has Docker
installed and it should just run without having to do any setup.</p>
<p>Other important things to know about Docker are:</p>
<ul class="simple">
<li>There are two main types of objects: images and containers. Images
are sort of like blueprints that define what is inside a container,
whereas containers are like the actual buildings specified by the
blueprints. There can be many containers that come from a single
image.</li>
<li>Containers are meant to be immutable. When you stop them and restart
them, they always restart in the same state as when they were first
created.</li>
<li>Since containers are immutable, some of your application data may
need to be placed in a volume, which is either another container or
a folder on the host system. A volume gets connected to your
application container and exists even when your application
container is not running.</li>
</ul>
</div>
</div>
<div class="section" id="the-cross-compilation-workflow">
<h2>The cross-compilation workflow</h2>
<p>Now that we have established the essential background to this project,
let's look at the cross-compilation workflow. Below is a picture that
provides a sense of the entire process, moving in general from
left-to-right.</p>
<img alt="The cross-compilation workflow" class="align-center" src="images/mm_docker_workflow.png"><p>The process involves two Docker containers: one for building
Micro-Manager and the other for running the application. The build
dependencies and the QEMU emulator are both located inside the build
container, having been specified when its image was created. These
allow us to compile Micro-Manager for the ARM architecture.  The
source code is connected to the build container as a <em>bind mount</em>,
which is a folder from the host workstation that is mounted inside the
build container when it is run.</p>
<p>Once the libraries are compiled, they are installed into a folder
inside the bind mount so that the host system will have access to them
after the build container closes. Next, the compiled libraries are
copied directly into an image that defines the application
container. This image defines only the essential run-time requirements
for running Micro-Manager and nothing else. The application image is
stored on the registry server which I set up on my local network. This
makes it easy for the Raspberry Pi to download the latest image and
run the Micro-Manager application container whenever I make changes.</p>
<p>An important aspect of this workflow is how the data is passed between
the systems and containers. Unlike what you will find in many
introductory tutorials on Docker, I do not add the Micro-Manager
source code directly to the build image/containers but instead use a
bind mount. The reason for this is that the source code and 3rd party
libraries are quite large, about 8 GB in total. By using a bind mount,
I avoid needless copying of this data. Another reason for using a bind
mount is that the source code will change frequently during
development. If I add the source code to the image, then I will have
to recreate the image every time the source code changes.</p>
<p>Once the libraries are built, I directly copy them into the
application image because they are much, much smaller than the source
code. I also want the code stored directly in the image so that the
application image is all the Raspberry Pi needs to run the
program. The image is stored in my local <a class="reference external" href="https://docs.docker.com/registry/">Docker registry</a> server so that once I push an
updated image to the server, the Raspberry Pi can download it and use
it immediately.</p>
<div class="section" id="step-0-prerequisites">
<h3>Step 0: Prerequisites</h3>
<p>I am going to assume that you already have installed Docker. (If not,
follow <a class="reference external" href="https://docs.docker.com/install/">these directions</a>.) I am
also going to assume that you are somewhat familiar with how to work
on a Linux system. The Raspberry Pi runs Linux, so you probably
wouldn't be here if you didn't already know at least a little.</p>
<p>For this article, I am working with these versions of Docker and
Ubuntu on my host workstation.:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~$ uname -a
Linux xxxxx 4.13.0-39-generic #44~16.04.1-Ubuntu SMP Thu Apr 5 16:43:10 UTC 2018 x86_64 x86_64
x86_64 GNU/Linux

kmdouglass@xxxxx:~$ docker version
Client:
 Version:      18.03.1-ce
 API version:  1.37
 Go version:   go1.9.5
 Git commit:   9ee9f40
 Built:        Thu Apr 26 07:17:20 2018
 OS/Arch:      linux/amd64
 Experimental: false
 Orchestrator: swarm

Server:
 Engine:
  Version:      18.03.1-ce
  API version:  1.37 (minimum version 1.12)
  Go version:   go1.9.5
  Git commit:   9ee9f40
  Built:        Thu Apr 26 07:15:30 2018
  OS/Arch:      linux/amd64
  Experimental: false
</pre>
<p>Finally, below is how my project directory structure is laid out.:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~/src/alphapi/docker$ tree -L 2
.
└── rpi-micromanager
    ├── 2.0-python
    │   ├── build
    │   └── Dockerfile
    └── build
        ├── build
        ├── Dockerfile
        ├── run
        └── setup
</pre>
<p>I have two folders; build, which contains the files for the build
container, and 2.0-python, which contains the files for creating the
Micro-Manager application container. (In my case, I am going to build
the Python wrapper for Micro-Manager 2.0.) Inside each folder are the
scripts and Dockerfiles that execute the various steps of the
workflow.</p>
<p>The final prerequisite is to register QEMU with the Docker build
agent. First, install a few packages for QEMU. On Ubuntu, this looks
like</p>
<pre class="code shell"><a name="rest_code_deacfa1a9a25439a970acfc38f97963f-1"></a>$ sudo apt update
<a name="rest_code_deacfa1a9a25439a970acfc38f97963f-2"></a>$ sudo install qemu qemu-user-static qemu-user binfmt-support
</pre>
<p>Finally, register the build agent with the command:</p>
<pre class="code shell"><a name="rest_code_e8b8d4d4c8e540d59c38b8017332baba-1"></a>$ docker run --rm --privileged multiarch/qemu-user-static:register --reset
</pre>
</div>
<div class="section" id="step-1-create-the-build-image">
<h3>Step 1: Create the build image</h3>
<p>Inside the build folder, I have a file called Dockerfile. Here are its
contents.</p>
<pre class="code shell"><a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-1"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-2"></a><span class="c1">#</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-3"></a><span class="c1"># Defines a build environment for Micro-Manager on the Raspberry Pi.</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-4"></a><span class="c1">#</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-5"></a><span class="c1"># Usage: docker build \</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-6"></a><span class="c1">#          -t NAME:TAG \</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-7"></a><span class="c1">#         .</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-8"></a><span class="c1">#</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-9"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-10"></a>FROM resin/raspberrypi3-debian:stretch
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-11"></a>MAINTAINER Kyle M. Douglass &lt;kyle.m.douglass@gmail.com&gt;
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-12"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-13"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-start"</span> <span class="o">]</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-14"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-15"></a><span class="c1"># Get the build dependencies.</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-16"></a>RUN apt-get update <span class="o">&amp;&amp;</span> apt-get -y install --no-install-recommends <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-17"></a>autoconf <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-18"></a>automake <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-19"></a>build-essential <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-20"></a>git <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-21"></a>libatlas-base-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-22"></a>libboost-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-23"></a>libboost-all-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-24"></a>libtool <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-25"></a>patch <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-26"></a>pkg-config <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-27"></a>python3-dev <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-28"></a>python3-pip <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-29"></a>python3-setuptools <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-30"></a>python3-wheel <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-31"></a>swig <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-32"></a><span class="o">&amp;&amp;</span> apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* <span class="se">\</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-33"></a><span class="o">&amp;&amp;</span> pip3 install numpy
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-34"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-35"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-end"</span> <span class="o">]</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-36"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-37"></a><span class="c1"># Set up the mount point for the source files and setup script.</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-38"></a>ADD setup /micro-manager/
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-39"></a>VOLUME /micro-manager/src
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-40"></a>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-41"></a>WORKDIR /micro-manager/src
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-42"></a>ENTRYPOINT <span class="o">[</span> <span class="s2">"/sbin/tini"</span>, <span class="s2">"-s"</span>, <span class="s2">"--"</span> <span class="o">]</span>
<a name="rest_code_c0a4d4086a554bd99c3d67b732f508f6-43"></a>CMD <span class="o">[</span> <span class="s2">"/micro-manager/setup"</span> <span class="o">]</span>
</pre>
<p>A Dockerfile defines the steps in building an image -- in this case,
the build image. Let's break this file down into pieces. In the first
two lines that follow the comments, I specify that my image is based
on the resin/raspberrypi3-debian:stretch image and that I am the
maintainer.</p>
<pre class="code shell"><a name="rest_code_6f6100ac8b7b4501961496830d326e59-1"></a>FROM resin/raspberrypi3-debian:stretch
<a name="rest_code_6f6100ac8b7b4501961496830d326e59-2"></a>MAINTAINER Kyle M. Douglass &lt;kyle.m.douglass@gmail.com&gt;
</pre>
<p>Images from <a class="reference external" href="https://hub.docker.com/u/resin/">Resin</a> are freely
available and already have the QEMU emulator installed. Next, I
specify what commands should be run for the ARM architecture. Any
commands located between <tt class="docutils literal">RUN [ <span class="pre">"cross-build-start"</span> ]</tt> and <tt class="docutils literal">RUN [
<span class="pre">"cross-build-end"</span> ]</tt> will be run using the emulator. Inside these two
commands, I install the build dependencies for Micro-Manager using
<tt class="docutils literal"><span class="pre">apt-get</span></tt> and <tt class="docutils literal">pip</tt>. (These are just standard commands for
installing software on Debian/Ubuntu Linux machines and from PyPI,
respectively.)</p>
<p>After the installation of the requirements completes, I add the setup
script to the folder /micro-manager inside the image with the <tt class="docutils literal">ADD
setup <span class="pre">/micro-manager/</span></tt> command. The setup script contains the
commands that will actually compile Micro-Manager. I then define a
mount point for the source code with <tt class="docutils literal">VOLUME
<span class="pre">/micro-manager/src</span></tt>. <strong>It's important to realize here that you do not
mount volumes inside images, you mount volumes inside containers.</strong>
This command is just telling the image to expect a folder to be
mounted at this location when the container is run.</p>
<p>The last three lines set the working directory, the entrypoint and the
default container command, respectively.</p>
<pre class="code shell"><a name="rest_code_562074e3cfad486b82873bea18b77684-1"></a>WORKDIR /micro-manager/src
<a name="rest_code_562074e3cfad486b82873bea18b77684-2"></a>ENTRYPOINT <span class="o">[</span> <span class="s2">"/sbin/tini"</span>, <span class="s2">"-s"</span>, <span class="s2">"--"</span> <span class="o">]</span>
<a name="rest_code_562074e3cfad486b82873bea18b77684-3"></a>CMD <span class="o">[</span> <span class="s2">"/micro-manager/setup"</span> <span class="o">]</span>
</pre>
<p>This specific entrypoint tells Docker that any containers built from
this image should first run Tini, which is a lightweight init system
for Docker containers. If you do not specify Tini as the entry point,
then it will not be able to reap zombies. (I don't know what this
means exactly, but it sounds cool and you can read about it here:
<a class="reference external" href="https://github.com/krallin/tini">https://github.com/krallin/tini</a>)</p>
<p>By default, the container will run the setup script, but, since I used
the <tt class="docutils literal">CMD</tt> directive, this can be overriden in case we need to
perform some manual steps. Roughly speaking, you can think of the
entrypoint as the command that can not be overridden and the CMD
command as the one that can be. In other words, Tini will always be
executed when containers created from this image are launched, whereas
you can choose not to run the setup script but instead to enter the
container through a Bash shell, for example.</p>
<p>To build the image, I use the following build script located in the
same directory as the Dockerfile for convenience.</p>
<pre class="code shell"><a name="rest_code_3ac75315a8d942d49bc70301c60b9981-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-2"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-3"></a><span class="c1">#</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-4"></a><span class="c1"># Usage: ./build</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-5"></a><span class="c1">#</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-6"></a>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-7"></a>docker build <span class="se">\</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-8"></a>       -t localhost:5000/rpi-micromanager:build <span class="se">\</span>
<a name="rest_code_3ac75315a8d942d49bc70301c60b9981-9"></a>       .
</pre>
<p>By using <tt class="docutils literal"><span class="pre">-t</span> <span class="pre">localhost:5000/rpi-micromanager:build</span></tt> argument I am
giving the image a name of <em>rpi-micromanager</em>, a tag of <em>build</em>, and
specifying that I will eventually host this image on my local registry
server (localhost) on port 5000.</p>
<p>In case you are wondering about the contents of the setup script,
don't worry. I'll explain it in the next section.</p>
</div>
<div class="section" id="step-2-compile-micro-manager">
<h3>Step 2: Compile Micro-Manager</h3>
<p>After the image is built, I create a container and use it to compile
Micro-Manager. For this, I use the run script in the build directory.</p>
<pre class="code shell"><a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-2"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-3"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-4"></a><span class="c1"># Usage: ./run DIR CONFIGURE</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-5"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-6"></a><span class="c1"># DIR is the parent folder containing the micro-manager Git</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-7"></a><span class="c1"># repository, the 3rdpartypublic Subversion repository, and any</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-8"></a><span class="c1"># additional build resources.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-9"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-10"></a><span class="c1"># If CONFIGURE=true, the build system is remade and the configure</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-11"></a><span class="c1"># script is rerun before running 'make' and 'make install'. If</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-12"></a><span class="c1"># CONFIGURE=false, only 'make' and 'make install' are run.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-13"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-14"></a><span class="c1"># The compiled program files are stored in a bind mount volume so that</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-15"></a><span class="c1"># they may be copied into the deployment container.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-16"></a><span class="c1">#</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-17"></a>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-18"></a><span class="nv">src_dir</span><span class="o">=</span><span class="nv">$1</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-19"></a><span class="nv">cmd</span><span class="o">=</span><span class="s2">"/micro-manager/setup </span><span class="nv">$2</span><span class="s2">"</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-20"></a>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-21"></a><span class="c1"># Remove the build artifacts from previous builds.</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-22"></a><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">==</span> <span class="nb">true</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-23"></a>    rm -rf <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>/build <span class="o">||</span> <span class="nb">true</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-24"></a><span class="k">fi</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-25"></a>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-26"></a>docker run --rm <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-27"></a>       -v <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>:/micro-manager/src <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-28"></a>       --name mm-build <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-29"></a>       localhost:5000/rpi-micromanager:build <span class="se">\</span>
<a name="rest_code_9aac600ac9774ed1b1899fa4c2e3c8fb-30"></a>       <span class="si">${</span><span class="nv">cmd</span><span class="si">}</span>
</pre>
<p>The script takes two arguments. The first is the path to the folder
containing all the source code (see below for details). The second
argument is either <strong>true</strong> or <strong>false</strong>. (It can actually be
anything, but it will only compile Micro-Manager if either <strong>true</strong> or
<strong>false</strong> are provided.) If true, the full build process is run,
including setting up the configure script; if false, only make and
make install are run, which should recompile and install only recently
updated files.</p>
<p>The run script uses the -v argument to <tt class="docutils literal">docker run</tt> to mount the
source directory into the container at the point specified by the
<tt class="docutils literal">VOLUME</tt> command in the Dockerfile. The directory layout on my host
file system for the source directory looks like this:</p>
<pre class="literal-block">
kmdouglass@xxxxx:/media/kmdouglass/Data/micro-manager$ tree -L 1
.
├── 3rdpartypublic
├── micro-manager
└── patches
</pre>
<p>The patches folder is not necessary and only there to fix <a class="reference external" href="https://github.com/micro-manager/micro-manager/pull/613">a bug</a> in the
WieneckeSinscke device adapter. (This bug may be fixed by now.)
3rdpartypublic is the large Subversion repository of all the required
software to build Micro-Manager, and micro-manager is the <a class="reference external" href="https://github.com/micro-manager/micro-manager">cloned
GitHub repository</a>. Prior to building,
I checkout the mm2 branch because I am interested in developing my
application for Micro-Manager 2.0.</p>
<p>The setup script that is run inside the container and mentioned in the
previous section looks like this.</p>
<pre class="code shell"><a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-2"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-3"></a><span class="c1"># # Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-4"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-5"></a><span class="c1"># Builds Micro-Manager.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-6"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-7"></a><span class="c1"># Usage: ./setup CONFIGURE</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-8"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-9"></a><span class="c1"># If CONFIGURE=true, the build system is remade and the configure</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-10"></a><span class="c1"># script is rerun before running 'make' and 'make install'. If</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-11"></a><span class="c1"># CONFIGURE=false, only 'make' and 'make install' or run.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-12"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-13"></a><span class="c1"># Kyle M. Douglass, 2018</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-14"></a><span class="c1">#</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-15"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-16"></a><span class="c1"># Move into the source directory.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-17"></a><span class="nb">cd</span> micro-manager
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-18"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-19"></a><span class="c1"># Undo any previous patches.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-20"></a>git checkout -- DeviceAdapters/WieneckeSinske/CAN29.cpp
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-21"></a>git checkout -- DeviceAdapters/WieneckeSinske/WieneckeSinske.cpp
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-22"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-23"></a><span class="c1"># Patch the broken WieneckeSinske device adapter.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-24"></a>patch DeviceAdapters/WieneckeSinske/CAN29.cpp &lt; ../patches/CAN29.cpp.diff <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-25"></a><span class="o">&amp;&amp;</span> patch DeviceAdapters/WieneckeSinske/WieneckeSinske.cpp &lt; ../patches/WieneckeSinske.cpp.diff
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-26"></a>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-27"></a><span class="c1"># Compile MM2.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-28"></a><span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">true</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-29"></a>    <span class="c1"># Remake the entire build system, then compile from scratch.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-30"></a>    ./autogen.sh
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-31"></a>    <span class="nv">PYTHON</span><span class="o">=</span><span class="s2">"/usr/bin/python3"</span> ./configure <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-32"></a>        --prefix<span class="o">=</span><span class="s2">"/micro-manager/src/build"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-33"></a>        --with-python<span class="o">=</span><span class="s2">"/usr/include/python3.5"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-34"></a>        --with-boost-libdir<span class="o">=</span><span class="s2">"/usr/lib/arm-linux-gnueabihf"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-35"></a>        --with-boost<span class="o">=</span><span class="s2">"/usr/include/boost"</span> <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-36"></a>        --disable-java-app <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-37"></a>        --disable-install-dependency-jars <span class="se">\</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-38"></a>        --with-java<span class="o">=</span><span class="s2">"no"</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-39"></a>    make
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-40"></a>    make install
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-41"></a>    chmod -R a+w /micro-manager/src/build
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-42"></a><span class="k">elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">=</span> <span class="nb">false</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-43"></a>    <span class="c1"># Only recompile changed source files.</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-44"></a>    make
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-45"></a>    make install
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-46"></a>    chmod -R a+w /micro-manager/src/build
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-47"></a><span class="k">else</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-48"></a>    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2"> : Unrecognized argument."</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-49"></a>    <span class="nb">echo</span> <span class="s2">"Pass \"true\" to run the full build process."</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-50"></a>    <span class="nb">echo</span> <span class="s2">"Pass \"false\" to run only \"make\" and \"make install\"."</span>
<a name="rest_code_c4bdae05ce3949a29a977ba64ad474a1-51"></a><span class="k">fi</span>
</pre>
<p>Most important in this script is the call to <tt class="docutils literal">configure</tt>. You can
see that the compiled libraries and Python wrapper will be written to
the build folder inside the mounted directory. This gives the host
file system access to the compiled artifacts after the container has
stopped.</p>
</div>
<div class="section" id="step-3-build-the-application-image">
<h3>Step 3: Build the application image</h3>
<p>Once the libraries are compiled, we can add them to an application
image that contains only the essentials for running Micro-Manager.</p>
<p>For this, I use a separate Dockerfile inside the 2.0-python
directory.</p>
<pre class="code shell"><a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-1"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-2"></a><span class="c1">#</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-3"></a><span class="c1"># Builds the Micro-Manager 2.0 Python wrapper for the Raspberry Pi.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-4"></a><span class="c1">#</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-5"></a><span class="c1"># Usage: docker build \</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-6"></a><span class="c1">#          -t NAME:TAG \</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-7"></a><span class="c1">#          .</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-8"></a><span class="c1">#</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-9"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-10"></a>FROM resin/raspberrypi3-debian:stretch
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-11"></a>MAINTAINER Kyle M. Douglass &lt;kyle.m.douglass@gmail.com&gt;
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-12"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-13"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-start"</span> <span class="o">]</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-14"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-15"></a><span class="c1"># Install the run-time dependencies.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-16"></a>RUN apt-get update <span class="o">&amp;&amp;</span> apt-get -y install --no-install-recommends <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-17"></a>    libatlas-base-dev <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-18"></a>    libboost-all-dev <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-19"></a>    python3-pip <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-20"></a>    python3-setuptools <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-21"></a>    python3-wheel <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-22"></a>    <span class="o">&amp;&amp;</span> pip3 install numpy <span class="se">\</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-23"></a>    <span class="o">&amp;&amp;</span> apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-24"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-25"></a><span class="c1"># Copy in the Micro-Manager source files.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-26"></a>RUN useradd -ms /bin/bash micro-manager
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-27"></a>WORKDIR /home/micro-manager/app
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-28"></a>COPY --chown<span class="o">=</span>micro-manager:micro-manager . .
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-29"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-30"></a>RUN <span class="o">[</span> <span class="s2">"cross-build-end"</span> <span class="o">]</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-31"></a>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-32"></a><span class="c1"># Final environment configuration.</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-33"></a>USER micro-manager:micro-manager
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-34"></a>ENV PYTHONPATH /home/micro-manager/app/lib/micro-manager
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-35"></a>ENTRYPOINT <span class="o">[</span><span class="s2">"/sbin/tini"</span>, <span class="s2">"-s"</span>, <span class="s2">"--"</span><span class="o">]</span>
<a name="rest_code_d2c39a585a2c4f18b05c576e91c7b9e5-36"></a>CMD <span class="o">[</span><span class="s2">"/usr/bin/python3"</span><span class="o">]</span>
</pre>
<p>As before, I use a clean resin base image. However, this time I only
install the essential software to run Micro-Manager.</p>
<p>After apt-getting and pip-installing everything, I create a new user
called <strong>micro-manager</strong> and a new folder called <strong>app</strong> inside this
user's home directory.</p>
<pre class="code shell"><a name="rest_code_429cf0806a154ad1830bf3a72e544697-1"></a><span class="c1"># Copy in the Micro-Manager source files.</span>
<a name="rest_code_429cf0806a154ad1830bf3a72e544697-2"></a>RUN useradd -ms /bin/bash micro-manager
<a name="rest_code_429cf0806a154ad1830bf3a72e544697-3"></a>WORKDIR /home/micro-manager/app
</pre>
<p>Next, I directly copy the compiled libraries into the image with the
COPY command.</p>
<pre class="code shell"><a name="rest_code_669f943f2dbd45fea1871087ea64446f-1"></a>COPY --chown<span class="o">=</span>micro-manager:micro-manager . .
</pre>
<p>The two periods (.) mean that I copy the current host directory's
contents into the container's current working directory
(/home/micro-manager/app). What is the current host directory? Well,
as I explain below, I actually run this Dockerfile from inside the
<strong>build</strong> folder that was created to hold the compiled libraries in
the previous step. But first, I'll end my explanation of the
Dockerfile by saying that I switch the USER so that I do not run the
container as root, add the library to the PYTHONPATH environment
variable, and setup the default command as the python3 interpreter.</p>
<p>To build this image, I use the following build script.</p>
<pre class="code shell"><a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-1"></a><span class="ch">#!/bin/bash</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-2"></a><span class="c1"># Copyright (C) 2018 Kyle M. Douglass</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-3"></a><span class="c1">#</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-4"></a><span class="c1"># Usage: ./build DIR</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-5"></a><span class="c1">#</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-6"></a><span class="c1"># DIR is the root directory containing the Micro-Manager build</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-7"></a><span class="c1"># artifacts. These artifacts will be added to the Docker image.</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-8"></a><span class="c1">#</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-9"></a>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-10"></a><span class="nv">src_dir</span><span class="o">=</span><span class="nv">$1</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-11"></a>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-12"></a>cp Dockerfile <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-13"></a><span class="nb">cd</span> <span class="si">${</span><span class="nv">src_dir</span><span class="si">}</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-14"></a>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-15"></a>docker build <span class="se">\</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-16"></a>       -t localhost:5000/rpi-micromanager:2.0-python <span class="se">\</span>
<a name="rest_code_dc3a0e2e3f174899a0f46febdbac5215-17"></a>       .
</pre>
<p>This script takes one argument, which is the <strong>build</strong> directory
containing the compiled source code. The script first copies the
Dockerfile into this directory and then changes into it with the cd
command. (This explains the two periods (.) in the COPY command in the
Dockerfile.)</p>
<p>Finally, I build the image and give it a name of
localhost:5000/rpi-micromanager:2.0-python.</p>
</div>
<div class="section" id="step-4-add-the-image-to-the-local-registry-server">
<h3>Step 4: Add the image to the local registry server</h3>
<p>Now we need a way to get the image from the workstation onto the
Raspberry Pi. Of course, I could manually transfer the file with a USB
stick or possibly use ssh, but what if I have multiple Pi's? This
process could become cumbersome. Docker provides a few ways to push
and pull images across a network. The most obvious is <a class="reference external" href="https://hub.docker.com/">Dockerhub</a>, a site for freely sharing images. For the
moment I don't want to use Dockerhub, though, because I have not yet
checked all the software licenses and am unsure as to what my rights
are for putting an image with Micro-Manager software on a public
repository.</p>
<p>A better option, especially for testing, is to use a local registry
server. This server operates only on my home network and already
allows my workstation and Pi's to communicate with one
another. Following the <a class="reference external" href="https://docs.docker.com/registry/deploying/">official registry documentation</a> and <a class="reference external" href="http://zacharykeeton.com/docker-private-registry/">this blog post by
Zachary Keeton</a>,
I managed to setup the registry as follows.</p>
<div class="section" id="host-setup">
<h4>Host setup</h4>
<p>First, we need to setup a transport layer security (TLS)
certificate. It's possible to run the server without one if you don't
expect your network to be attacked, but it's good practice so let's
create one.</p>
<p>To do this, I edit the /etc/ssl/openssl.cnf file and add the following
to the top of the [ v3_ca ] section.:</p>
<pre class="literal-block">
subjectAltName = IP:192.168.XXX.XXX
</pre>
<p>where the IP address is the address of the workstation on the
network. Next, I actually create the certificate. I make a directory
called certs inside my workstation home directory and then use openssl
to make the cerficate. During the prompts, I press ENTER at every step
except the FQDN (fully qualified domain name). For the FQDN, I enter
the same IP address as above.</p>
<pre class="code shell"><a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-1"></a>mkdir certs
<a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-2"></a>openssl req -newkey rsa:4096 -nodes -sha256 <span class="se">\</span>
<a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-3"></a>-keyout certs/domain.key -x509 -days <span class="m">365</span> <span class="se">\</span>
<a name="rest_code_86887feb6b394f85a6cb2b2087c05d36-4"></a>-config /etc/ssl/openssl.cnf -out certs/domain.crt
</pre>
<p><strong>I had to add the ``-config /etc/ssl/openssl.cnf`` argument for the
subject alternative name to be added to the certificate.</strong> This part
was tricky, because if this argument is not included, then the key
generation step will use some other .cnf file (I am not sure
which). This results in the following SAN error when attemptingt to
connect to the registry.:</p>
<pre class="literal-block">
cannot validate certificate for 192.168.XXX.XXX because it doesn't contain any IP SANs
</pre>
<p>After the domain.key and domain.crt files have been created, I run the
official registry server container. (See how handy Docker containers
are? There's no messy installation beyond grabbing the container.)</p>
<pre class="code shell"><a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-1"></a>docker run -d -p <span class="m">5000</span>:5000 <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-2"></a>  --restart<span class="o">=</span>always <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-3"></a>  --name registry <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-4"></a>  -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/certs:/certs <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-5"></a>  -e <span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/domain.crt <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-6"></a>  -e <span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/domain.key <span class="se">\</span>
<a name="rest_code_0a9896e55c0d4f90aeeca6488c13fa6a-7"></a>  registry:2
</pre>
<p>If the registry:2 image is not already downloaded, then it will be
downloaded for automatically when running the container. Note that
the -p 5000:5000 argument indicates that the server is using port 5000
on both the host system and inside the container. Note also that the
certs directory is relative to the current directory because I use the
($pwd) command. You can change this to an absolute path if you wish on
your setup.</p>
<p>Let's go ahead and push the application image to the server now that
it's running.</p>
<pre class="code shell"><a name="rest_code_9f2efb97cc1f4405b31df75762cf0ccd-1"></a>docker push localhost:5000/rpi-micromanager:2.0-python
</pre>
</div>
<div class="section" id="setup-the-pi">
<h4>Setup the Pi</h4>
<p>Now, startup the Pi. I will assume that you have <a class="reference external" href="https://www.raspberrypi.org/blog/docker-comes-to-raspberry-pi/">already installed
Docker</a> on
it and know how to communicate with it via ssh and copy files to it
using scp.</p>
<p>I copy the certificate from the host with scp.</p>
<pre class="code shell"><a name="rest_code_01f2057272c64a55a7dc30a09662f278-1"></a>sudo mkdir -p /etc/docker/certs.d/192.168.XXX.XXX:5000/
<a name="rest_code_01f2057272c64a55a7dc30a09662f278-2"></a>sudo scp kmdouglass@192.168.XXX.XXX:/home/kmdouglass/certs/domain.crt /etc/docker/certs.d/192.168.XXX.XXX:5000/ca.crt
</pre>
<p>The IP address that I am using is the one to the machine where the
registry server is running. After this step, I make the operating
system trust the certificate.</p>
<pre class="code shell"><a name="rest_code_b992be5945ec448c99eb26412ad3fcd8-1"></a>sudo scp kmdouglass@192.168.XXX.XXX:/home/kmdouglass/certs/domain.crt /usr/local/share/ca-certificates/192.168.XXX.XXX.crt
<a name="rest_code_b992be5945ec448c99eb26412ad3fcd8-2"></a>sudo update-ca-certifications
</pre>
<p>Finally, I restart the Docker daemon.</p>
<pre class="code shell"><a name="rest_code_2ad10e9d31d944548082cd85d6f25f6d-1"></a>sudo service docker restart
</pre>
<p>If everything is working, then I should be able to pull the image from
your network's registry server.</p>
<pre class="code shell"><a name="rest_code_f9dbff5d6425426489523f7e12278aab-1"></a>docker pull <span class="m">192</span>.168.XXX.XXX:5000/rpi-micromanager:python2.0
</pre>
</div>
</div>
<div class="section" id="step-5-run-micro-manager">
<h3>Step 5: Run Micro-Manager!</h3>
<p>And now the moment of truth: running the application container. Since
it's setup to run Python automatically, I use a pretty simple <tt class="docutils literal">docker
run</tt> command.</p>
<pre class="code shell"><a name="rest_code_44303c2f70dc4c699fe02dd7140e1c76-1"></a>docker run -it --rm <span class="se">\</span>
<a name="rest_code_44303c2f70dc4c699fe02dd7140e1c76-2"></a>     --name micro-manager <span class="se">\</span>
<a name="rest_code_44303c2f70dc4c699fe02dd7140e1c76-3"></a>     <span class="m">192</span>.168.XXX.XXX:5000/rpi-micromanager:2.0-python
</pre>
<p>I verify that the Micro-Manager Python wrapper is working by trying to
import it and run <a class="reference external" href="https://micro-manager.org/wiki/Using_the_Micro-Manager_python_library">a few basic commands</a>.</p>
<pre class="code python"><a name="rest_code_5bd277414f21415497aef665e01aa4dc-1"></a><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">MMCorePy</span>
<a name="rest_code_5bd277414f21415497aef665e01aa4dc-2"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">mmc</span> <span class="o">=</span> <span class="n">MMCorePy</span><span class="o">.</span><span class="n">CMMCore</span><span class="p">()</span>
<a name="rest_code_5bd277414f21415497aef665e01aa4dc-3"></a><span class="o">&gt;&gt;&gt;</span> <span class="n">mmc</span><span class="o">.</span><span class="n">getVersionInfo</span><span class="p">()</span>
</pre>
<p>If these work without error, then congratulations! You're now ready to
start building your embedded microscopy system ;)</p>
</div>
<div class="section" id="step-6-running-the-whole-process">
<h3>Step 6: Running the whole process</h3>
<p>The beauty of having scripted all these steps is that the full
workflow may be executed quite simply. From the host system's build
folder, run:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~/src/alphapi/docker/rpi-micromanager/build$ ./build
kmdouglass@xxxxx:~/src/alphapi/docker/rpi-micromanager/build$ ./run /path/to/source true
</pre>
<p>From the 2.0-python folder:</p>
<pre class="literal-block">
kmdouglass@xxxxx:~/src/alphapi/docker/rpi-micromanager/2.0-python ./build /path/to/source/artifacts
kmdouglass@xxxxx:~$ docker push localhost:5000/rpi-micromanager:2.0-python
</pre>
<p>And from the Raspberry Pi:</p>
<pre class="literal-block">
pi@yyyyy:~$ docker pull 192.168.XXX.XXX:5000/rpi-micromanager:2.0-python
pi@yyyyy:~$ docker run -it --rm \
                   --name micro-manager \
                   192.168.XXX.XXX:5000/rpi-micromanager:2.0-python
</pre>
<p>Hopefully this is enough to get you started building Micro-Manager for
the Raspberry Pi with Docker. Though I focused on Micro-Manager, the
workflow should be generally applicable to any large scale project in
which you want to isolate the build environment from the host machine.</p>
<p>If you have any questions, just leave them in the comments. Happy
programming!</p>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/" class="u-url">Implementing a fast Gibson-Lanni PSF solver in Python</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/" rel="bookmark">
            <time class="published dt-published" datetime="2017-10-20T07:25:54+02:00" itemprop="datePublished" title="2017-10-20 07:25">2017-10-20 07:25</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#disqus_thread" data-disqus-identifier="cache/posts/implementing-a-fast-gibson-lanni-psf-solver-in-python.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Many techniques in modern fluorescence microscopy--such as deconvolution and single molecule localization microscopy--rely on the computation of accurate microscope point spread functions (PSFs). Several models exist for these purposes with varying degrees of accuracy and generality. One such model, the so-called Gibson-Lanni model, approximates the PSF of an immersion microscope objective by accounting for the different refractive indexes of the immersion medium, coverslip, and sample, as well as variations in the thicknesses of the different layers. This post describes a Python implementation of a fast computational approach to the G&amp;L PSF that was presented in <strong>Fast and accurate three-dimensional point spread function computation for fluorescence microscopy</strong> by Li, Xue, and Blu. The approach is fast because it avoids the need to perform any explicit integration of the Kirchhoff diffraction integral, such as is done in <a href="http://bigwww.epfl.ch/algorithms/psfgenerator/">PSF Generator</a>. The prototype is based on the manuscript and the associated MATLAB code at <a href="http://www.ee.cuhk.edu.hk/~tblu/monsite/phps/fastPSF.php">http://www.ee.cuhk.edu.hk/~tblu/monsite/phps/fastPSF.php</a></p>
<h2 id="References">References<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#References">¶</a>
</h2>
<ul>
<li><a href="https://www.osapublishing.org/josaa/abstract.cfm?uri=josaa-9-1-154">Gibson, S. F., &amp; Lanni, F. (1992). Experimental test of an analytical model of aberration in an oil-immersion objective lens used in three-dimensional light microscopy. JOSA A, 9(1), 154-166.</a></li>
<li><a href="https://www.osapublishing.org/josaa/fulltext.cfm?uri=josaa-34-6-1029&amp;id=367116">Li, J., Xue, F., &amp; Blu, T. (2017). Fast and accurate three-dimensional point spread function computation for fluorescence microscopy. JOSA A, 34(6), 1029-1034.</a></li>
<li><a href="http://bigwww.epfl.ch/algorithms/psfgenerator/">Kirshner, H. &amp; Sage, D. (Accessed on October 20, 2017) PSF Generator</a></li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="o">%</span><span class="k">pylab</span> inline
<span class="kn">import</span> <span class="nn">scipy.special</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">animation</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">'dark_background'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'figure.facecolor'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'#272b30'</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'image.cmap'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'viridis'</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Python </span><span class="si">{}</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'NumPy</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'matplotlib</span><span class="se">\t</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'SciPy</span><span class="se">\t\t</span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Populating the interactive namespace from numpy and matplotlib
Python 3.5.2 |Continuum Analytics, Inc.| (default, Jul  2 2016, 17:53:06) 
[GCC 4.4.7 20120313 (Red Hat 4.4.7-1)]

NumPy		1.13.3
matplotlib	2.1.0
SciPy		0.19.1
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Simulation-setup">Simulation setup<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Simulation-setup">¶</a>
</h2>
<h3 id="Define-the-simulation-parameters">Define the simulation parameters<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Define-the-simulation-parameters">¶</a>
</h3>
<p>The Gibson-Lanni PSF model accounts for differences between design parameters and real parameters that describe the fluorescence microscope, such as the refractive indexes and thicknesses of the immersion medium, coverslip, and sample. For more information, please see the above references or, if you do not have access to the publications, the description of the model here: <a href="http://bigwww.epfl.ch/algorithms/psfgenerator/">http://bigwww.epfl.ch/algorithms/psfgenerator/</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Image properties</span>
<span class="c1"># Size of the PSF array, pixels</span>
<span class="n">size_x</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">size_y</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">size_z</span> <span class="o">=</span> <span class="mi">128</span>

<span class="c1"># Precision control</span>
<span class="n">num_basis</span>    <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Number of rescaled Bessels that approximate the phase function</span>
<span class="n">num_samples</span>  <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># Number of pupil samples along radial direction</span>
<span class="n">oversampling</span> <span class="o">=</span> <span class="mi">2</span>    <span class="c1"># Defines the upsampling ratio on the image space grid for computations</span>

<span class="c1"># Microscope parameters</span>
<span class="n">NA</span>          <span class="o">=</span> <span class="mf">1.4</span>
<span class="n">wavelength</span>  <span class="o">=</span> <span class="mf">0.610</span> <span class="c1"># microns</span>
<span class="n">M</span>           <span class="o">=</span> <span class="mi">100</span>   <span class="c1"># magnification</span>
<span class="n">ns</span>          <span class="o">=</span> <span class="mf">1.33</span>  <span class="c1"># specimen refractive index (RI)</span>
<span class="n">ng0</span>         <span class="o">=</span> <span class="mf">1.5</span>   <span class="c1"># coverslip RI design value</span>
<span class="n">ng</span>          <span class="o">=</span> <span class="mf">1.5</span>   <span class="c1"># coverslip RI experimental value</span>
<span class="n">ni0</span>         <span class="o">=</span> <span class="mf">1.5</span>   <span class="c1"># immersion medium RI design value</span>
<span class="n">ni</span>          <span class="o">=</span> <span class="mf">1.5</span>   <span class="c1"># immersion medium RI experimental value</span>
<span class="n">ti0</span>         <span class="o">=</span> <span class="mi">150</span>   <span class="c1"># microns, working distance (immersion medium thickness) design value</span>
<span class="n">tg0</span>         <span class="o">=</span> <span class="mi">170</span>   <span class="c1"># microns, coverslip thickness design value</span>
<span class="n">tg</span>          <span class="o">=</span> <span class="mi">170</span>   <span class="c1"># microns, coverslip thickness experimental value</span>
<span class="n">res_lateral</span> <span class="o">=</span> <span class="mf">0.1</span>   <span class="c1"># microns</span>
<span class="n">res_axial</span>   <span class="o">=</span> <span class="mf">0.25</span>  <span class="c1"># microns</span>
<span class="n">pZ</span>          <span class="o">=</span> <span class="mi">2</span>     <span class="c1"># microns, particle distance from coverslip</span>

<span class="c1"># Scaling factors for the Fourier-Bessel series expansion</span>
<span class="n">min_wavelength</span> <span class="o">=</span> <span class="mf">0.436</span> <span class="c1"># microns</span>
<span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">NA</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_basis</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">min_wavelength</span> <span class="o">/</span> <span class="n">wavelength</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Create-the-coordinate-systems">Create the coordinate systems<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Create-the-coordinate-systems">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Place the origin at the center of the final PSF array</span>
<span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
<span class="n">y0</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="c1"># Find the maximum possible radius coordinate of the PSF array by finding the distance</span>
<span class="c1"># from the center of the array to a corner</span>
<span class="n">max_radius</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">((</span><span class="n">size_x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">size_x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">size_y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">size_y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1"># Radial coordinates, image space</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">res_lateral</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">oversampling</span> <span class="o">*</span> <span class="n">max_radius</span><span class="p">)</span> <span class="o">/</span> <span class="n">oversampling</span>

<span class="c1"># Radial coordinates, pupil space</span>
<span class="n">a</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">NA</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ni</span><span class="p">,</span> <span class="n">ni0</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">ng0</span><span class="p">])</span> <span class="o">/</span> <span class="n">NA</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>

<span class="c1"># Stage displacements away from best focus</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">res_axial</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">size_z</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size_z</span> <span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">res_axial</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-1:-Approximate-the-pupil-phase-with-a-Fourier-Bessel-series">Step 1: Approximate the pupil phase with a Fourier-Bessel series<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Step-1:-Approximate-the-pupil-phase-with-a-Fourier-Bessel-series">¶</a>
</h2>
<p><code>z.reshape(-1,1)</code> flips <code>z</code> from a row array to a column array so that it may be broadcast across <code>rho</code>.</p>
<p>The coefficients <code>C</code> are found by a least-squares solution to the equation</p>
\begin{equation*}
\mathbf{\phi} \left( \rho , z \right)= \mathbf{J} \left( \rho \right) \mathbf{c} \left( z \right)
\end{equation*}<p>$ \mathbf{c} $ has dimensions <code>num_basis</code> $ \times $ <code>len(z)</code>. The <code>J</code> array has dimensions <code>num_basis</code> $ \times $ <code>len(rho)</code> and the <code>phase</code> array has dimensions <code>len(z)</code> $ \times $ <code>len(rho)</code>. The <code>J</code> and <code>phase</code> arrays are therefore transposed to get the dimensions right in the call to <code>np.linalg.lstsq</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Define the wavefront aberration</span>
<span class="n">OPDs</span> <span class="o">=</span> <span class="n">pZ</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ns</span> <span class="o">*</span> <span class="n">ns</span> <span class="o">-</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span> <span class="c1"># OPD in the sample</span>
<span class="n">OPDi</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ti0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ni</span> <span class="o">*</span> <span class="n">ni</span> <span class="o">-</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">ti0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ni0</span> <span class="o">*</span> <span class="n">ni0</span> <span class="o">-</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span> <span class="c1"># OPD in the immersion medium</span>
<span class="n">OPDg</span> <span class="o">=</span> <span class="n">tg</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ng</span> <span class="o">*</span> <span class="n">ng</span> <span class="o">-</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span> <span class="o">-</span> <span class="n">tg0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ng0</span> <span class="o">*</span> <span class="n">ng0</span> <span class="o">-</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">NA</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span> <span class="c1"># OPD in the coverslip</span>
<span class="n">W</span>    <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="n">OPDs</span> <span class="o">+</span> <span class="n">OPDi</span> <span class="o">+</span> <span class="n">OPDg</span><span class="p">)</span>

<span class="c1"># Sample the phase</span>
<span class="c1"># Shape is (number of z samples by number of rho samples)</span>
<span class="n">phase</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">W</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>

<span class="c1"># Define the basis of Bessel functions</span>
<span class="c1"># Shape is (number of basis functions by number of rho samples)</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">scaling_factor</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span>

<span class="c1"># Compute the approximation to the sampled pupil phase by finding the least squares</span>
<span class="c1"># solution to the complex coefficients of the Fourier-Bessel expansion.</span>
<span class="c1"># Shape of C is (number of basis functions by number of z samples).</span>
<span class="c1"># Note the matrix transposes to get the dimensions correct.</span>
<span class="n">C</span><span class="p">,</span> <span class="n">residuals</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">phase</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Compare-the-function-to-its-Fourier-Bessel-expansion">Compare the function to its Fourier-Bessel expansion<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Compare-the-function-to-its-Fourier-Bessel-expansion">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Which z-plane to compute</span>
<span class="n">z0</span> <span class="o">=</span> <span class="mi">24</span>

<span class="c1"># The Fourier-Bessel approximation</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">J</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">[:,</span><span class="n">z0</span><span class="p">])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">z0</span><span class="p">,</span> <span class="p">:]),</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">'$ \exp{ \left[ jW \left( \rho \right) \right] }$'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">est</span><span class="p">),</span> <span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Fourier-Bessel'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'$\rho$'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Real'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper left'</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">z0</span><span class="p">,</span> <span class="p">:]))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">est</span><span class="p">),</span> <span class="s1">'--'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'$\rho$'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Imaginary'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>




<div class="output_png output_subarea ">
<img src="data:image/png;base64,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%0AhBBCYuj/A0ly18EpMhJ1AAAAAElFTkSuQmCC">
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Step-2:-Compute-the-PSF">Step 2: Compute the PSF<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Step-2:-Compute-the-PSF">¶</a>
</h2>
<p>Here, we use the Fourier-Bessel series expansion of the phase function and a Bessel integral identity to compute the approximate PSF. Each coefficient $ c_{m} \left( z \right) $ needs to be multiplied by</p>
\begin{equation*}
R \left(r; \mathbf{p} \right) = \frac{\sigma_m J_1 \left( \sigma_m a \right) J_0 \left( \beta a \right)a - \beta J_0 \left( \sigma_m a \right) J_1 \left( \beta a \right)a }{\sigma_m^2 - \beta^2}
\end{equation*}<p>and the resulting products summed over the number of basis functions. $ \mathbf{p} $ is the parameter vector for the Gibson-Lanni model, $ \sigma_m $ is the scaling factor for the argument to the $ m'th $ Bessel basis function, and $ \beta = kr\text{NA} $.</p>
<p><code>b</code> is defined such that <code>R</code> has dimensions of <code>len(r)</code> $ \times $ <code>len(rho)</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">r</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">NA</span> <span class="o">/</span> <span class="n">wavelength</span>

<span class="c1"># Convenience functions for J0 and J1 Bessel functions</span>
<span class="n">J0</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">J1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># See equation 5 in Li, Xue, and Blu</span>
<span class="n">denom</span> <span class="o">=</span> <span class="n">scaling_factor</span> <span class="o">*</span> <span class="n">scaling_factor</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">b</span>
<span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">scaling_factor</span> <span class="o">*</span> <span class="n">J1</span><span class="p">(</span><span class="n">scaling_factor</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">J0</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">J0</span><span class="p">(</span><span class="n">scaling_factor</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">J1</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
<span class="n">R</span> <span class="o">/=</span> <span class="n">denom</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now compute the point-spread function via</p>
\begin{equation*}
PSF \left( r, z; z_p, \mathbf{p} \right) = \left| \mathbf{R} \left( r; \mathbf{p} \right) \mathbf{c} \left( z \right) \right|^2
\end{equation*}
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># The transpose places the axial direction along the first dimension of the array, i.e. rows</span>
<span class="c1"># This is only for convenience.</span>
<span class="n">PSF_rz</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># Normalize to the maximum value</span>
<span class="n">PSF_rz</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PSF_rz</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Profile-in-r-and-z">Profile in r and z<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Profile-in-r-and-z">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">PSF_rz</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">z</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mf">2.5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'r, $\mu m$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'z, $\mu m$'</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>




<div class="output_png output_subarea ">
<img src="data:image/png;base64,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">
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>z is the stage <em>displacement</em> in an inverted microscope. So, negative z's correspond to moving "up" in the sample.</p>
<h2 id="Step-3:-Resample-the-PSF-onto-a-rotationally-symmetric-Cartesian-grid">Step 3: Resample the PSF onto a rotationally-symmetric Cartesian grid<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Step-3:-Resample-the-PSF-onto-a-rotationally-symmetric-Cartesian-grid">¶</a>
</h2>
<p>Here we generate a two dimensional grid where the value at each grid point is the distance of the point from the center of the grid. These values are supplied to an interpolation function computed from <code>PSF_rz</code> to produce a rotationally-symmetric 2D PSF at each z-position.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create the fleshed-out xy grid of radial distances from the center</span>
<span class="n">xy</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">size_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">size_x</span><span class="p">]</span>
<span class="n">r_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">y0</span><span class="p">))</span> <span class="o">*</span> <span class="n">res_lateral</span>

<span class="n">PSF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_y</span><span class="p">,</span> <span class="n">size_x</span><span class="p">,</span> <span class="n">size_z</span><span class="p">))</span>

<span class="k">for</span> <span class="n">z_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PSF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
    <span class="c1"># Interpolate the radial PSF function</span>
    <span class="n">PSF_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">PSF_rz</span><span class="p">[</span><span class="n">z_index</span><span class="p">,</span> <span class="p">:])</span>
    
    <span class="c1"># Evaluate the PSF at each value of r_pixel</span>
    <span class="n">PSF</span><span class="p">[:,:,</span> <span class="n">z_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">PSF_interp</span><span class="p">(</span><span class="n">r_pixel</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">size_y</span><span class="p">,</span> <span class="n">size_x</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Save-z-stack-to-a-movie">Save z-stack to a movie<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Save-z-stack-to-a-movie">¶</a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>    <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Rescale the PSF values logarithmically for better viewing</span>
<span class="n">PSF_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">PSF</span><span class="p">)</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">PSF_log</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">PSF_log</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">PSF</span><span class="p">[:,:,</span><span class="mi">64</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
<span class="n">img</span><span class="o">.</span><span class="n">set_extent</span><span class="p">([</span><span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="o">-</span><span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">r</span><span class="o">.</span><span class="n">max</span><span class="p">()])</span>

<span class="n">txt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">'z = </span><span class="si">{:.1f}</span><span class="s1"> $\mu m$'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">64</span><span class="p">]))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">((</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'x, $\mu m$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">((</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">'y, $\mu m$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'bottom'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Initialize the figure with an empty frame</span>
<span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="n">img</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size_y</span><span class="p">,</span> <span class="n">size_x</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">img</span><span class="p">,</span>

<span class="c1"># This function is called for each frame of the animation</span>
<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>   
    <span class="n">img</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">PSF</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">frame</span><span class="p">]))</span>

    <span class="n">txt</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">'z = </span><span class="si">{:.1f}</span><span class="s1"> $\mu m$'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">frame</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">img</span><span class="p">,</span>

<span class="c1"># Create the animation</span>
<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">),</span>
                               <span class="n">init_func</span><span class="o">=</span><span class="n">init</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Save the animation</span>
<span class="n">myWriter</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FFMpegWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s1">'-vcodec'</span><span class="p">,</span> <span class="s1">'libx264'</span><span class="p">])</span>
<span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'gibson-lanni.mp4'</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">myWriter</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<video controls src="gibson-lanni.mp4" type="video/mp4"></video>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary">Summary<a class="anchor-link" href="posts/implementing-a-fast-gibson-lanni-psf-solver-in-python/#Summary">¶</a>
</h2>
<p>In summary, this method for calculating the Gibson-Lanni PSF is fast because it reduces the problem to a numer of matrix operations, rather than a numerical integration of the Kirchhoff diffraction integral. I especially find the Fourier-Bessel approximation of the phase function very clever, since this enables us to apply the integral identity described above. Moreover, it seems like the approach can extend to computing PSFs from other wavefront aberrations, though at the moment I do not know how it might handle non-rotationally symmetric pupils. (I am referring to the <code>W</code> variable above.)</p>
<p>I would like to thank the first author of the work, <a href="http://www.ee.cuhk.edu.hk/~jzli/">Jizhou Li</a>, for encouraging me to write this as a blog post and for providing feedback on the implementation presented here.</p>

</div>
</div>
</div>
</div>
    </div>
    </article><article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title"><a href="posts/accessing-the-raspberry-pi-camera-image-sensor/" class="u-url">Accessing the Raspberry Pi camera image sensor</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                Kyle M. Douglass
            </span></p>
            <p class="dateline">
            <a href="posts/accessing-the-raspberry-pi-camera-image-sensor/" rel="bookmark">
            <time class="published dt-published" datetime="2017-08-26T23:33:07+02:00" itemprop="datePublished" title="2017-08-26 23:33">2017-08-26 23:33</time></a>
            </p>
                <p class="commentline">
        
    <a href="posts/accessing-the-raspberry-pi-camera-image-sensor/#disqus_thread" data-disqus-identifier="cache/posts/accessing-the-raspberry-pi-camera-image-sensor.html">Comments</a>


        </p>
</div>
    </header><div class="p-summary entry-summary">
    <div>
<p><strong>WARNING</strong> You can easily ruin your Raspberry Pi camera module by
following the steps in this post. Proceed with caution.</p>
<p>Over the past half year I have been making slow but steady progress on
<a class="reference external" href="https://hackaday.io/project/19677-basic-lensless-imaging-for-low-cost-microscopy">my lensless imager project</a>. The
purpose, aside from having a bit of fun, is to create an imaging
system for basic cell biology that doesn't use an expensive microscope
objective.</p>
<p>A lensless imager works just as its name implies: an image sensor
records the scattered light from a microscopic, transparent object and
computationally reconstructs an image of that object, all without a
lens. The best resolutions are achieved when the object is relatively
close to the image sensor. Ideally, the separation between the object
and the sensor's pixels would be at most about one millimeter. <a class="reference external" href="http://innovate.ee.ucla.edu/wp-content/uploads/2016/01/annurev-bioeng-092515-010849.pdf">This
limit is partly determined by the light source's spatial coherence</a>,
but also by the fact that high resolution is achieved by recording the
scattered light at very large angles, which is possible only when the
sample is close to the sensor.</p>
<p>Today I had a bit of free time so I decided to see whether I could
remove the housing that surrounds the Raspberry Pi camera's
sensor. The <a class="reference external" href="https://www.raspberrypi.org/products/camera-module-v2/">Raspberry Pi Camera Module version 2</a> sensor is a
Sony IMX219 color chip. Directly above the sensor is a filter, a lens,
and the housing for both of these that prevent me from placing
anything closer than about half a centimeter from the sensor plane. If
I would want to use this camera for the lensless imager, then the
housing would have to go.</p>
<p>Now, even without the housing the Raspberry Pi camera is not
necessarily the best option for the project because the IMX219 is a
color sensor. This means that there is a Bayer filter over its pixels,
which would cut the resolution of the imager since I would be using a
very narrow band light source. Effectively, only a quarter of the
pixels would be receiving any light. Regardless, I had a spare second
camera and it interfaces well with the Raspberry Pi, so I figured it
would make for a good prototype.</p>
<p>As you will see, I did slightly damage my sensor, though it seems to
still work. <strong>You can easily ruin your camera module or cut your
finger by following these steps, so proceed at your own risk.</strong></p>
<div class="section" id="step-0-the-raspberry-pi-camera-module-v2">
<h2>Step 0: The Raspberry Pi Camera Module V2</h2>
<p>In the picture below you see my Raspberry Pi Camera Module. From
above, you can see the small circular aperture with the lens
immediately behind it. The sensor is inside the small gray rectangular
housing that is attached to the control board by a small ribbon cable
(to its right) and a bit of two-sided sticky foam tape (underneath the
sensor; not visible).</p>
<img alt="The Raspberry Pi Camera Module V2" class="align-center" src="images/pi_camera_step0.thumbnail.jpg">
</div>
<div class="section" id="step-1-remove-the-main-ribbon-cable">
<h2>Step 1: Remove the main ribbon cable</h2>
<p>To make working on the board a bit easier, I removed the white ribbon
cable that attaches the module to the Pi. I did this by pulling on the
black tabs on the two ends of the connecter until the cable is easily
removed. I labeled the sides of the ribbon cable just in case.</p>
<img alt="Remove the main ribbon cable from the control board" class="align-center" src="images/pi_camera_step1.thumbnail.jpg">
</div>
<div class="section" id="step-2-detach-the-sensor-s-ribbon-cable">
<h2>Step 2: Detach the sensor's ribbon cable</h2>
<p>Next, I used my finger and thumb nail to remove the small ribbon cable
that attaches the sensor to the control board. I essentially applied a
small torque to the bottom edge of the connector until it just
"popped" up, as seen in the second image below.</p>
<img alt="The small ribbon cable from the sensor is to the right." class="align-center" src="images/pi_camera_step2.thumbnail.jpg">
</div>
<div class="section" id="step-3-remove-the-sensor-from-the-control-board">
<h2>Step 3: Remove the sensor from the control board</h2>
<p>In the third step, I used my thumbnail to gently pry the sensor from
the control board. The sensor is attached with some two-sided sticky
tape and may need a few minutes of work to come free.</p>
<img alt="Pull the sensor off the control board." class="align-center" src="images/pi_camera_step3.thumbnail.jpg">
</div>
<div class="section" id="step-4-remove-the-rectangular-housing">
<h2>Step 4: Remove the rectangular housing</h2>
<p><strong>In this step you risk cutting your finger, so please be careful.</strong></p>
<p>The housing around the sensor is glued. To remove it, you will need to
gently work a knife (or, better yet, a thin screw driver) between the
housing and the sensor board, taking care not to let the blade go too
far into the housing and possibly ruining one of the resistors or wire
bonds.</p>
<img alt="Cut carefully on one side of the housing." class="align-center" src="images/pi_camera_step4.thumbnail.jpg"><p>Once you get a knife between the two, try popping the housing off of
the sensor.</p>
<img alt="Once the edge is cut, pop the housing off." class="align-center" src="images/pi_camera_step4b.thumbnail.jpg"><p>When I did this I cut on three sides of the housing, but in retrospect
I should have only cut on the side opposite the ribbon cable and pried
the other sides loose. This is because I damaged a small resistor when
the knife blade went too far into the housing. You can see this below
and, at the same time, get an idea of the layout of the sensor board
so you know where you can and can't cut.</p>
<img alt="The resistor near the top of the board was damaged when cutting the housing." class="align-center" src="images/pi_camera_step4c.thumbnail.png"><p>If you have the normal version of the camera, then you can also find the IR blocking filter
inside the housing.</p>
<img alt="The IR blocking filter." class="align-center" src="images/pi_camera_step4d.thumbnail.jpg"><p>Fortunately for me the camera still works, despite the damaged
resistor. I can now place samples directly on the sensor if I wanted
to, though the wire bonds from the sensor to its control board appear
quite fragile. For this reason, it may make more sense to build a
slide holder that holds a sample just above the surface without
touching it. For now, I can use this exposed sensor to prototype
different methods for mounting the sample.</p>
</div>
</div>
    </div>
    </article>
</div>

        <nav class="postindexpager"><ul class="pager">
<li class="next">
                <a href="index-3.html" rel="next">Older posts</a>
            </li>
        </ul></nav><script>var disqus_shortname="kmdouglass";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha256-SDRP1VVYu+tgAGKhddBSl5+ezofHKZeI+OzxakbIe/Y=" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        processEscapes: true
    }
});
</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2019         <a href="mailto:kyle.m.douglass@gmail.com">Kyle M. Douglass</a> - Powered by         <a href="http://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
